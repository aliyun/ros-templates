ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 创建CMS监控规则、目标与消息主题，支持多维度指标警报配置与通知策略。
  en: Create CMS monitoring rules, targets, and message topics, supporting multi-dimensional
    metric alert configurations and notification policies.
Parameters:
  TopicName:
    Type: String
    Description: Topic name
    MinLength: 1
    MaxLength: 256
  RuleName:
    Type: String
    Description: The name of the alert rule.
  Category:
    Type: String
    Description: |-
      The abbreviation of the service name. Valid values:
      ECS (including Alibaba Cloud and non-Alibaba Cloud hosts)
      RDS (ApsaraDB for RDS)
      ADS (AnalyticDB)
      SLB (Server Load Balancer)
      VPC (Virtual Private Cloud)
      APIGATEWAY (API Gateway)
      CDN
      CS (Container Service for Swarm)
      DCDN (Dynamic Route for CDN)
      DDoS (distributed denial of service)
      EIP (Elastic IP)
      ELASTICSEARCH (Elasticsearch)
      EMR (E-MapReduce)
      ESS (Auto Scaling)
      HBASE (ApsaraDB for HBase)
      IOT_EDGE (IoT Edge)
      K8S_POD (k8s pod)
      KVSTORE_SHARDING (ApsaraDB for Redis cluster version)
      KVSTORE_SPLITRW (ApsaraDB for Redis read/write splitting version)
      KVSTORE_STANDARD (ApsaraDB for Redis standard version)
      MEMCACHE (ApsaraDB for Memcache)
      MNS (Message Service)
      MONGODB (ApsaraDB for MongoDB replica set instances)
      MONGODB_CLUSTER (ApsaraDB for MongoDB cluster version)
      MONGODB_SHARDING (ApsaraDB for MongoDB sharded clusters)
      MQ_TOPIC (Message Service topic)
      OCS (original version of ApsaraDB for Memcache)
      OPENSEARCH (Open Search)
      OSS (Object Storage Service)
      POLARDB (ApsaraDB for POLARDB)
      PETADATA (HybridDB for MySQL)
      SCDN (Secure Content Delivery Network)
      SHAREBANDWIDTHPACKAGES (shared bandwidth package)
      SLS (Log Service)
      VPN (VPN Gateway)
  RuleId:
    Type: String
    Description: |-
      The ID of the alert rule. The IDs of alert rules are generated by callers to ensure
      uniqueness.
    Default: mytest
  Namespace:
    Type: String
    Description: |-
      The data namespace of the service. For more information, call DescribeMetricMetaList
      or see Preset metrics reference.
  GroupId:
    Type: String
    Description: The ID of application group.
  MetricName:
    Type: String
    Description: The name of the metric. For more information, call DescribeMetricMetaList
      or see Preset metrics reference.
  Escalations:
    Type: Json
  NoEffectiveInterval:
    Type: String
    Description: The period when the alert rule is ineffective.
    Default: null
  SilenceTime:
    Type: Number
    Description: |-
      The duration of the mute period during which new alerts are not sent even if the trigger
      conditions are met. Unit: second. Default value: 86400. Minimum value: 60.
    Default: null
    MinValue: 60
  Dimensions:
    Type: String
    Description: The expended resource dimensions.
    Default: null
  Period:
    Type: Number
    Description: 'The aggregation period. Unite: second.'
    Default: null
  EffectiveInterval:
    Type: String
    Description: The period when the alert rule is effective.
    Default: null
  EmailSubject:
    Type: String
    Description: The subject of the alert notification email.
    Default: null
  Webhook:
    Type: String
    Description: The URL of the callback triggered when an alert occurs.
    Default: null
  Interval:
    Type: Number
    Description: The detection period of alerts.
    Default: null
Resources:
  GroupMetricRule:
    Type: ALIYUN::CMS::GroupMetricRule
    Properties:
      NoEffectiveInterval:
        Ref: NoEffectiveInterval
      SilenceTime:
        Ref: SilenceTime
      Category:
        Ref: Category
      RuleId:
        Ref: RuleId
      Dimensions:
        Ref: Dimensions
      Period:
        Ref: Period
      EffectiveInterval:
        Ref: EffectiveInterval
      Namespace:
        Ref: Namespace
      GroupId:
        Ref: GroupId
      MetricName:
        Ref: MetricName
      Escalations:
        Ref: Escalations
      EmailSubject:
        Ref: EmailSubject
      Webhook:
        Ref: Webhook
      RuleName:
        Ref: RuleName
      Interval:
        Ref: Interval
  Topic:
    Type: ALIYUN::MNS::Topic
    Properties:
      TopicName:
        Ref: TopicName
  MetricRuleTargets:
    Type: ALIYUN::CMS::MetricRuleTargets
    Properties:
      RuleId:
        Ref: GroupMetricRule
      Targets:
      - Level: WARN
        Id: '1'
        Arn:
          Fn::Sub:
          - ${TopicArn}/message
          - TopicArn:
              Fn::GetAtt:
              - Topic
              - ARN.WithSlash
    DependsOn:
    - GroupMetricRule
    - Topic
Outputs:
  RuleId:
    Description: Rule ID.
    Value:
      Fn::GetAtt:
      - GroupMetricRule
      - RuleId
  Arns:
    Description: The ARN list of targets
    Value:
      Fn::GetAtt:
      - MetricRuleTargets
      - Arns
  Ids:
    Description: The ID list of targets
    Value:
      Fn::GetAtt:
      - MetricRuleTargets
      - Ids
