ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 创建双栈云服务器(ECS)，自动配置IPv6公网IP，含VPC、安全组、IPv6网关及带宽设置。
  en: Create a dual-stack cloud server (ECS) and automatically configure IPv6 public IP, including VPC, security group, IPv6 gateway and bandwidth settings.
Parameters:
  InstanceImageId:
    AssociationPropertyMetadata:
      InstanceType: ${InstanceType}
      SupportedImageOwnerAlias:
        - system
        - self
        - others
    Description:
      zh-cn: 镜像ID, <br>Linux系统请选择：<font color='red'><b>centos_7</b></font> <br>Windows系统请选择：<font color='red'><b>win2008r2；win2012r2；win2016</b></font>
      en: Image ID，<br>Linux System Select：<font color='red'><b>centos_7</b></font> <br>Windows System Select：<font color='red'><b>win2008r2；win2012r2；win2016</b></font>
    Default: centos_7_04_64_20G_alibase_201701015.vhd
    Label:
      zh-cn: 镜像
      en: Image
    AssociationProperty: ALIYUN::ECS::Image::ImageId
    Type: String
  SystemDiskCategory:
    AssociationProperty: ALIYUN::ECS::Disk::SystemDiskCategory
    AssociationPropertyMetadata:
      LocaleKey: DiskCategory
      InstanceType: ${InstanceType}
    Type: String
    Description:
      zh-cn: '<font color=''blue''><b>可选值：</b></font><br>[cloud_efficiency: <font color=''green''>高效云盘</font>]<br>[cloud_ssd: <font color=''green''>SSD云盘</font>]<br>[cloud_essd: <font color=''green''>ESSD云盘</font>]<br>[cloud: <font color=''green''>普通云盘</font>]<br>[ephemeral_ssd: <font color=''green''>本地SSD盘</font>]'
      en: '<font color=''blue''><b>Optional values:</b></font><br>[cloud_efficiency: <font color=''green''>Efficient Cloud Disk</font>]<br>[cloud_ssd: <font color=''green''>SSD Cloud Disk</font>]<br>[cloud_essd: <font color=''green''>ESSD Cloud Disk</font>]<br>[cloud: <font color=''green''>Cloud Disk</font>]<br>[ephemeral_ssd: <font color=''green''>Local SSD Cloud Disk</font>]'
    Label:
      zh-cn: 系统盘类型
      en: System Disk Type
  SystemDiskSize:
    Default: 40
    Type: Number
    Description:
      zh-cn: 系统盘大小, 取值范围：[20, 500], 单位：GB。
      en: 'System disk size, range of values: 20-500, units: GB.'
    Label:
      zh-cn: 系统盘空间
      en: System Disk Space
  VpcCidrBlock:
    Default: 192.168.0.0/16
    Label:
      zh-cn: 专有网络IPV4网段
      en: VPC IPV4 CIDR Block
    Type: String
    Description:
      zh-cn: 新建专有网络IP地址段范围，推荐使用以下的IP地址段<br><font color='green'>[10.0.0.0/8]</font><br><font color='green'>[172.16.0.0/12]</font><br><font color='green'>[192.168.0.0/16]</font>
      en: New proprietary network IP address segment range, recommended use of the following IP address segments<br><font color='green'>[10.0.0.0/8]</font><br><font color='green'>[172.16.0.0/12]</font><br><font color='green'>[192.168.0.0/16]</font>
    AllowedValues:
      - 192.168.0.0/16
      - 172.16.0.0/12
      - 10.0.0.0/8
  InstanceType:
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      ZoneId: VSwitchZoneId
    Type: String
    Description:
      zh-cn: 填写VSwitch可用区下可使用的规格；<br>通用规格：<font color='red'><b>ecs.c5.large</b></font><br>注：可用区可能不支持通用规格<br>规格详见：<a href='https://help.aliyun.com/document_detail/25378.html' target='_blank'><b><font color='blue'>实例规格族</font></a></b>
      en: 'Fill in the specifications that can be used under the VSwitch availability zone;</b></font><br>general specifications：<font color=''red''><b>ecs.c5.large</b></font><br>note: a few zones do not support general specifications<br>see detail: <a href=''https://www.alibabacloud.com/help/en/doc-detail/25378.html'' target=''_blank''><b><font color=''blue''>Instance Specification Family</font></a></b>'
    Label:
      zh-cn: 实例规格
      en: Instance Type
  InstancePassword:
    Description:
      zh-cn: 服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）。
      en: Server login password, Length 8-30, must contain three(Capital letters, lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in).
    Type: String
    Label:
      zh-cn: 实例密码
      en: Instance Password
    NoEcho: true
    AssociationProperty: ALIYUN::ECS::Instance::Password
    ConstraintDescription:
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）。
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in).
  VSwitchCidrBlock:
    Default: 192.168.0.0/24
    Type: String
    Description:
      zh-cn: 新建交换机的网段，所属虚拟专有网络的子网
      en: Network segments of new switches, subnets of virtual proprietary networks
    Label:
      zh-cn: 交换机IPV4网段
      en: VSwitch IPV4 CIDR Block
  InternetChargeType:
    Default: PayByBandwidth
    AssociationPropertyMetadata:
      LocaleKey: InternetChargeType
    Label:
      zh-cn: IPv6公网带宽的计费方式
      en: IPv6 Metric Bandwidth Metering Method.
    Type: String
    AllowedValues:
      - PayByTraffic
      - PayByBandwidth
  IPV6Bandwidth:
    Default: 10
    Type: Number
    Description:
      zh-cn: IPv6网关公网带宽, 取值范围：[1, 5000], 单位：Mbps。当公网带宽计费方式为按使用流量计费时取值范围为1~2000Mbps，当公网带宽计费方式为按带宽计费时取值范围为1~5000Mbps。
      en: 'IPv6 network Gateway public network bandwidth, value range: s1, 5000, in Mbps. When the public network bandwidth billing method is based on the use of traffic billing value range of 1 to 2000Mbps, when the public network bandwidth billing method is metered by bandwidth when the value range is 1 to 5000Mbps.'
    Label:
      zh-cn: IPv6网关公网带宽
      en: IPv6 Network Gateway Public Network Bandwidth
  VSwitchZoneId:
    AssociationProperty: ALIYUN::ECS::Instance:ZoneId
    Type: String
    Description:
      zh-cn: 可用区ID。<br><b>注： <font color='blue'>选择前请确认该可用区是否支持创建ECS资源的规格，建议与其他交换机可用区不同</font></b>
      en: Availability Zone ID.<br><b>note：<font color='blue'>before selecting, please confirm that the Availability Zone supports the specification of creating ECS resources,which is recommended to be different from other VSwitch Availability Zone</font></b>
    Label:
      zh-cn: 交换机可用区
      en: VSwitch Availability Zone
  InstancePublicIP:
    Default: false
    Type: Boolean
    Description:
      zh-cn: 是否分配IPV4公共IP。
      en: Whether to assign a IPV4 common IP.
    Label:
      zh-cn: 分配IPV4公网IP
      en: Allocate IPV4 Public IP
  IPV6GateWaySpec:
    AssociationPropertyMetadata:
      LocaleKey: NatGatewaySpec
    Description:
      zh-cn: IPv6网关的规格,可选值：Small（免费版），Medium（企业版），Large（企业增强版）
      en: 'IPv6 gateway specifications, optional values: Small (free version), Medium (enterprise version), Large (enterprise enhancement version)'
    Default: Small
    Label:
      zh-cn: IPv6网关的规格
      en: Specifications for the IPv6 Gateway
    AllowedValues:
      - Small
      - Medium
      - Large
    Type: String
Outputs:
  EcsInstanceId:
    Description: EcsInstance InstanceId
    Value:
      Fn::GetAtt:
        - EcsInstance
        - InstanceId
  EcsInstancePrivateIp:
    Description: EcsInstance PrivateIp
    Value:
      Fn::GetAtt:
        - EcsInstance
        - PrivateIp
  EcsInstanceIpv6Address:
    Description: EcsInstance Ipv6Address
    Value:
      Fn::Select:
        - '0'
        - Fn::GetAtt:
            - EcsAssignIpv6Addresses
            - Ipv6Addresses
Conditions: {}
Resources:
  EcsSecurityGroup:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      SecurityGroupIngress:
        - Priority: 1
          IpProtocol: tcp
          NicType: intranet
          SourceCidrIp: 0.0.0.0/0
          PortRange: 3389/3389
        - Priority: 1
          IpProtocol: all
          NicType: intranet
          Ipv6SourceCidrIp: '::/0'
          PortRange: '-1/-1'
      VpcId:
        Ref: EcsVpc
      SecurityGroupEgress:
        - Priority: 1
          IpProtocol: tcp
          DestCidrIp: 0.0.0.0/0
          NicType: intranet
          PortRange: 3389/3389
        - Ipv6DestCidrIp: '::/0'
          IpProtocol: all
          Priority: 1
          NicType: intranet
          PortRange: '-1/-1'
  WaitConditionHandle:
    Type: ALIYUN::ROS::WaitConditionHandle
    Properties: {}
  VpcIpv6InternetBandwidth:
    Type: ALIYUN::VPC::Ipv6InternetBandwidth
    Properties:
      InternetChargeType:
        Ref: InternetChargeType
      Bandwidth:
        Ref: IPV6Bandwidth
      Ipv6AddressId:
        Fn::Select:
          - 0
          - Fn::GetAtt:
              - EcsAssignIpv6Addresses
              - Ipv6AddressIds
      Ipv6GatewayId:
        Ref: VpcIpv6Gateway
    DependsOn:
      - EcsAssignIpv6Addresses
      - VpcIpv6Gateway
  VpcIpv6Gateway:
    Type: ALIYUN::VPC::Ipv6Gateway
    Properties:
      VpcId:
        Ref: EcsVpc
      Name: MyIpv6Gateway
      Spec:
        Ref: IPV6GateWaySpec
  EcsAssignIpv6Addresses:
    Type: ALIYUN::ECS::AssignIpv6Addresses
    Properties:
      NetworkInterfaceId:
        Fn::GetAtt:
          - EcsInstance
          - PrimaryNetworkInterfaceId
      Ipv6AddressCount: 1
    DependsOn:
      - EcsInstance
  EcsVSwitch:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      Ipv6CidrBlock: 0
      VpcId:
        Ref: EcsVpc
      CidrBlock:
        Ref: VSwitchCidrBlock
      ZoneId:
        Ref: VSwitchZoneId
  WaitCondition:
    Type: ALIYUN::ROS::WaitCondition
    Properties:
      Count: 1
      Handle:
        Ref: WaitConditionHandle
      Timeout: 900
  EcsInstance:
    Type: ALIYUN::ECS::Instance
    Properties:
      UserData:
        Fn::Replace:
          - ros-notify:
              Fn::GetAtt:
                - WaitConditionHandle
                - CurlCli
          - Fn::Join:
              - ''
              - - '#!/bin/sh'
                - |2

                - |
                  cd /opt
                - |
                  wget http://ecs-image-utils.oss-cn-hangzhou.aliyuncs.com/ipv6/rhel/ecs-utils-ipv6
                - |
                  chmod +x ./ecs-utils-ipv6
                - |
                  ./ecs-utils-ipv6
                - |
                  ros-notify -d "{\"Data\" : \"SUCCESS\", \"Status\" : \"SUCCESS\"}"
      SystemDiskCategory:
        Ref: SystemDiskCategory
      VpcId:
        Ref: EcsVpc
      SecurityGroupId:
        Ref: EcsSecurityGroup
      SystemDiskSize:
        Ref: SystemDiskSize
      ImageId:
        Ref: InstanceImageId
      AllocatePublicIP:
        Ref: InstancePublicIP
      VSwitchId:
        Ref: EcsVSwitch
      IoOptimized: optimized
      Password:
        Ref: InstancePassword
      InstanceType:
        Ref: InstanceType
    DependsOn:
      - EcsSecurityGroup
      - EcsVSwitch
      - EcsVpc
  EcsVpc:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock:
        Ref: VpcCidrBlock
      VpcName:
        Fn::Join:
          - '-'
          - - StackId
            - Ref: ALIYUN::StackId
      EnableIpv6: true
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
      - Parameters:
          - VpcCidrBlock
          - VSwitchCidrBlock
          - VSwitchZoneId
          - InstanceType
          - InstanceImageId
          - SystemDiskSize
          - InstancePublicIP
          - InternetChargeType
          - IPV6Bandwidth
          - IPV6GateWaySpec
          - SystemDiskCategory
          - InstancePassword
        Label:
          default: ECS
