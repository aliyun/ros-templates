ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 构建混合云Kubernetes集群，自动配置GPU实例与CPFS存储，集成飞天AI加速工具，实现AI模型的高效训练和推理。
  en: Construct a hybrid cloud Kubernetes cluster, automate the configuration of GPU
    instances with CPFS storage integration, and incorporate Alibaba Cloud's Fei Tian
    AI acceleration tools to facilitate efficient training and inference of AI models.
Conditions:
  CreateCentOS:
    Fn::Equals:
    - centos_7
    - Ref: ImageId
  NotUseResourceGroupId:
    Fn::Equals:
    - default
    - Ref: ResourceGroupId
Parameters:
  VpcCidrBlock:
    Type: String
    Label:
      en: VPC CIDR Block for Master Instance
      zh-cn: 专有网络网段
    Description:
      en: Master instance proprietary network IP address segment range
      zh-cn: 专有网络IP地址段范围
    Default: 192.168.0.0/16
    AllowedValues:
    - 192.168.0.0/16
  MasterVSwitchZoneId:
    Type: String
    Label:
      en: VSwitch Zone ID for Master Instance
      zh-cn: Master实例交换机可用区
    Description:
      en: Availability Zone ID.<br><b>note：<font color='blue'>before selecting the
        available zone, please confirm that the available zone supports the specification
        of creating Master ECS</font></b>
      zh-cn: 可用区ID。<br><b>注：<font color='blue'><font color='blue'>选择可用区前请确认该可用区是否支持创建Master
        ECS的规格。</font></b>
    AssociationProperty: ALIYUN::ECS::Instance:ZoneId
  MasterVSwitchCidrBlock:
    Type: String
    Label:
      en: VSwitch CIDR Block for Master Instance
      zh-cn: Master实例交换机网段
    Description:
      en: Must be a sub-network segment of the proprietary network and is not occupied
        by other VSwitches.
      zh-cn: 必须是专有网络的子网段，并且没有被其他交换机占用。
    Default: 192.168.0.0/24
  WorkerVSwitchZoneId:
    Type: String
    Label:
      en: VSwitch Zone ID for Worker Instance
      zh-cn: Worker实例交换机可用区
    Description:
      en: Availability Zone ID.<font color='red'><b>select a different availability
        zone than other switches</font></b><br><b>note：<font color='blue'>before selecting
        the available zone, please confirm that the available zone supports the specification
        of creating Worker ECS</font></b>
      zh-cn: 可用区ID，<font color='red'><b>选择与其他交换机不同的可用区</b></font><br><b>注：<font color='blue'><font
        color='blue'>选择可用区前请确认该可用区是否支持创建Worker ECS的规格。</font></b>
    AssociationProperty: ALIYUN::ECS::Instance:ZoneId
  WorkerVSwitchCidrBlock:
    Type: String
    Label:
      en: VSwitch CIDR Block for Worker Instance
      zh-cn: Worker实例交换机网段
    Description:
      en: Must be a sub-network segment of the proprietary network and is not occupied
        by other VSwitches.
      zh-cn: 必须是专有网络的子网段，并且没有被其他交换机占用。
    Default: 192.168.10.0/24
  MasterInstanceType:
    Type: String
    Label:
      en: Master Instance Type
      zh-cn: Master实例规格
    Description:
      en: 'Fill in the specifications that can be used under the master instance VSwitch
        availability zone; master instances use common ECS specifications</b></font><br>general
        specifications：<font color=''red''><b>ecs.c5.large</b></font><br>note: a few
        zones do not support general specifications<br>see detail: <a href=''https://www.alibabacloud.com/help/en/doc-detail/25378.html''
        target=''_blank''><b><font color=''blue''>Instance Specification Family</font></a></b>'
      zh-cn: 填写Master实例交换机可用区下可使用的规格；Master实例使用通用型ECS规格<br>通用规格：<font color='red'><b>ecs.c5.large</b></font><br>注：可用区可能不支持通用规格<br>规格详见：<a
        href='https://help.aliyun.com/document_detail/25378.html' target='_blank'><b><font
        color='blue'>实例规格族</font></a></b>
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      ZoneId: MasterVSwitchZoneId
  WorkerInstanceType:
    Type: String
    Label:
      en: Worker Instance Type
      zh-cn: Worker实例规格
    Description:
      en: 'Fill in the specifications that can be used under the worker instance VSwitch
        availability zone; worker instances use GPU compute ECS specifications for
        the gn4, gn5, gn5i, gn6v and gn6i series</b></font><br>recommended specifications：<font
        color=''red''><b>ecs.gn5i-c2g1.large</b></font><br>note: a few zones do not
        support recommended specifications<br>see detail: <a href=''https://www.alibabacloud.com/help/en/doc-detail/25378.html''
        target=''_blank''><b><font color=''blue''>Instance Specification Family</font></a></b>'
      zh-cn: 填写Worker实例交换机可用区下可使用的规格；Worker实例使用gn4、gn5、gn5i、gn6v及gn6i系列的GPU计算型ECS规格<br>推荐规格：<font
        color='red'><b>ecs.gn5i-c2g1.large</b></font><br>注：可用区可能不支持推荐规格<br>规格详见：<a
        href='https://help.aliyun.com/document_detail/25378.html' target='_blank'><b><font
        color='blue'>实例规格族</font></a></b>
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      ZoneId: WorkerVSwitchZoneId
  ImageId:
    Type: String
    Label:
      en: Image
      zh-cn: 镜像
    Description:
      en: Image ID, using other images does not install software such as the service
        side, please use the centos_7; <br>see detail：<b><a href='https://www.alibabacloud.com/help/en/doc-detail/112977.html'
        target='_blank'><font color='blue'>Find the mirror</font></a></b>
      zh-cn: 镜像ID，使用其他镜像不会安装服务端等软件，请使用centos_7；<br>详见：<b><a href='https://help.aliyun.com/document_detail/112977.html'
        target='_blank'><font color='blue'>查找镜像</font></a></b>
    Default: centos_7
  SystemDiskCategory:
    Type: String
    Label:
      en: Disk Type
      zh-cn: 磁盘类型
    Description:
      en: '<font color=''blue''><b>Optional values:</b></font><br>[cloud_efficiency:
        <font color=''green''>Efficient Cloud Disk</font>]<br>[cloud_ssd: <font color=''green''>SSD
        Cloud Disk</font>]<br>[cloud_essd: <font color=''green''>ESSD Cloud Disk</font>]<br>[cloud:
        <font color=''green''>Cloud Disk</font>]<br>[ephemeral_ssd: <font color=''green''>Local
        SSD Cloud Disk</font>]'
      zh-cn: '<font color=''blue''><b>可选值：</b></font><br>[cloud_efficiency: <font
        color=''green''>高效云盘</font>]<br>[cloud_ssd: <font color=''green''>SSD云盘</font>]<br>[cloud_essd:
        <font color=''green''>ESSD云盘</font>]<br>[cloud: <font color=''green''>普通云盘</font>]<br>[ephemeral_ssd:
        <font color=''green''>本地SSD盘</font>]'
    Default: cloud_efficiency
    AllowedValues:
    - cloud_efficiency
    - cloud_ssd
    - cloud
    - cloud_essd
    - ephemeral_ssd
  SystemDiskSize:
    Type: Number
    Label:
      en: System Disk Space
      zh-cn: 系统盘空间
    Description:
      en: 'System disk size, range of values: 40-500, units: GB.'
      zh-cn: 系统盘大小, 取值范围：[40, 500], 单位：GB。
    Default: 150
  InternetBandwidth:
    Type: Number
    Label:
      en: Public Network Bandwidth
      zh-cn: 公网带宽
    Description:
      en: 'ECS public network bandwidth, value range: [1, 100], Unit: Mbps.'
      zh-cn: 'ECS公网带宽，取值范围: [1, 100]，单位： Mbps。'
    Default: 5
    MinValue: 1
    MaxValue: 100
  Password:
    Type: String
    Label:
      en: Instance Password
      zh-cn: 实例密码
    Description:
      en: Server login password, Length 8-30, must contain three(Capital letters,
        lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol
        in).
      zh-cn: 服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）。
    ConstraintDescription:
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers,
        ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in).
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）。
    AllowedPattern: '[0-9A-Za-z\_\-\&:;''<>,=%`~!@#\(\)\$\^\*\+\|\{\}\[\]\.\?\/]+$'
    MinLength: 8
    MaxLength: 30
    NoEcho: true
  ResourceGroupId:
    Type: String
    Label:
      en: Resource Group Id
      zh-cn: 资源组ID
    Description:
      en: Resource group ID, when default, ECS does not join the resource group.
      zh-cn: 资源组ID，默认default时，ECS不加入资源组。
    Default: default
Resources:
  CenInstance:
    Type: ALIYUN::CEN::CenInstance
    Properties:
      Name:
        Fn::Join:
        - '-'
        - - StackId
          - Ref: ALIYUN::StackId
  CommandWaitConditionHandle:
    Type: ALIYUN::ROS::WaitConditionHandle
    Properties: {}
  CommandWaitCondition:
    Type: ALIYUN::ROS::WaitCondition
    Properties:
      Count: 2
      Handle:
        Ref: CommandWaitConditionHandle
      Timeout: 3600
  MasterVpc:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock:
        Ref: VpcCidrBlock
      VpcName:
        Fn::Join:
        - '-'
        - - Master-ECS
          - StackId
          - Ref: ALIYUN::StackId
  MasterVSwitch:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      ZoneId:
        Ref: MasterVSwitchZoneId
      VpcId:
        Ref: MasterVpc
      CidrBlock:
        Ref: MasterVSwitchCidrBlock
      VSwitchName:
        Fn::Join:
        - _
        - - Worker-ECS
          - StackId
          - Ref: ALIYUN::StackId
  NasAccessGroup:
    Type: ALIYUN::NAS::AccessGroup
    Properties:
      AccessGroupName:
        Fn::Join:
        - '-'
        - - StackId
          - Ref: ALIYUN::StackId
      AccessGroupType: Vpc
  NasAccessRule:
    Type: ALIYUN::NAS::AccessRule
    Properties:
      AccessGroupName:
        Ref: NasAccessGroup
      SourceCidrIp: 0.0.0.0/0
    DependsOn:
    - NasAccessGroup
  NasFileSystem:
    Type: ALIYUN::NAS::FileSystem
    Properties:
      ProtocolType: NFS
      StorageType: Capacity
  NasMountTarget:
    Type: ALIYUN::NAS::MountTarget
    Properties:
      VpcId:
        Ref: MasterVpc
      VSwitchId:
        Ref: MasterVSwitch
      AccessGroupName:
        Ref: NasAccessGroup
      FileSystemId:
        Ref: NasFileSystem
      NetworkType: Vpc
    DependsOn:
    - NasAccessRule
    - NasFileSystem
  EcsCommand:
    Type: ALIYUN::ECS::Command
    Properties:
      CommandContent:
        Fn::Base64Encode:
          Fn::Replace:
          - ros-notify:
              Fn::GetAtt:
              - CommandWaitConditionHandle
              - CurlCli
          - Fn::Join:
            - ''
            - - "#!/bin/sh \n"
              - "sleep 20 && cd /root/tmp && bash mount.sh \n"
              - "#param_name='worker001' \n"
              - "#hostname=`hostname` \n"
              - "#if [ $hostname == $param_name ];then \n"
              - "#    #copy model file \n"
              - "#    cd /099 && tar xzvf resnet50_tensorflow.tgz -C /mnt \n"
              - "#    ls /mnt \n"
              - "#fi \n"
              - "ros-notify \n"
      Name:
        Fn::Join:
        - '-'
        - - Master-Command
          - StackId
          - Ref: ALIYUN::StackId
      Type: RunShellScript
    DependsOn:
    - NasMountTarget
  WorkerEcsWaitConditionHandle:
    Type: ALIYUN::ROS::WaitConditionHandle
    Properties: {}
  WorkerEcsWaitCondition:
    Type: ALIYUN::ROS::WaitCondition
    Properties:
      Count: 1
      Handle:
        Ref: WorkerEcsWaitConditionHandle
      Timeout: 3600
  MasterCenInstanceAttachment:
    Type: ALIYUN::CEN::CenInstanceAttachment
    Properties:
      CenId:
        Ref: CenInstance
      ChildInstanceId:
        Ref: MasterVpc
      ChildInstanceRegionId:
        Ref: ALIYUN::Region
      ChildInstanceType: VPC
    DependsOn:
    - MasterVSwitch
  WorkerVpc:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock:
        Ref: VpcCidrBlock
      VpcName:
        Fn::Join:
        - '-'
        - - Worker-ECS
          - StackId
          - Ref: ALIYUN::StackId
  WorkerVSwitch:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      ZoneId:
        Ref: WorkerVSwitchZoneId
      VpcId:
        Ref: WorkerVpc
      CidrBlock:
        Ref: WorkerVSwitchCidrBlock
      VSwitchName:
        Fn::Join:
        - _
        - - Master-ECS
          - StackId
          - Ref: ALIYUN::StackId
  WorkerCenInstanceAttachment:
    Type: ALIYUN::CEN::CenInstanceAttachment
    Properties:
      CenId:
        Ref: CenInstance
      ChildInstanceId:
        Ref: WorkerVpc
      ChildInstanceRegionId:
        Ref: ALIYUN::Region
      ChildInstanceType: VPC
    DependsOn:
    - MasterCenInstanceAttachment
    - WorkerVSwitch
  WorkerSecurityGroup:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: WorkerVpc
      SecurityGroupIngress:
      - IpProtocol: icmp
        NicType: internet
        PortRange: -1/-1
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        NicType: internet
        PortRange: 3389/3389
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        NicType: internet
        PortRange: 6443/6443
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        NicType: internet
        PortRange: 443/443
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      SecurityGroupName:
        Fn::Join:
        - _
        - - Worker-ECS
          - StackId
          - Ref: ALIYUN::StackId
  WorkerInstanceGroup:
    Type: ALIYUN::ECS::InstanceGroup
    Properties:
      VpcId:
        Ref: WorkerVpc
      VSwitchId:
        Ref: WorkerVSwitch
      SecurityGroupId:
        Ref: WorkerSecurityGroup
      ImageId:
        Ref: ImageId
      AllocatePublicIP: true
      HostName:
        Fn::Join:
        - ''
        - - worker
          - '[1,3]'
      InstanceName:
        Fn::Join:
        - ''
        - - worker
          - '[1,3]'
      InstanceType:
        Ref: WorkerInstanceType
      InternetMaxBandwidthOut:
        Ref: InternetBandwidth
      MaxAmount: 1
      Password:
        Ref: Password
      ResourceGroupId:
        Fn::If:
        - NotUseResourceGroupId
        - Ref: ALIYUN::NoValue
        - Ref: ResourceGroupId
      SystemDiskCategory:
        Ref: SystemDiskCategory
      SystemDiskSize:
        Ref: SystemDiskSize
      Tags:
      - Key: best_practice
        Value: 099
      UserData:
        Fn::If:
        - CreateCentOS
        - Fn::Replace:
          - ros-notify:
              Fn::GetAtt:
              - WorkerEcsWaitConditionHandle
              - CurlCli
          - Fn::Join:
            - ''
            - - "#!/bin/bash \n"
              - "worker_ip=`ip addr | grep eth0 | grep -o '[0-9]\\{1,3\\}\\.[0-9]\\\
                {1,3\\}\\.[0-9]\\{1,3\\}\\.[0-9]\\{1,3\\}/' | cut -d '/' -f 1` \n"
              - Fn::GetAtt:
                - IpWaitConditionHandle
                - CurlCli
              - " -d \"{\\\"id\\\" : \\\"ip\\\", \\\"data\\\" : \\\"$worker_ip\\\"\
                }\" \n"
              - "yum -y install nfs-utils jq expect gcc git \n"
              - "yum -y install yum-utils device-mapper-persistent-data lvm2 \n"
              - "yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\
                \ stable-19.03 \n"
              - "yum -y install docker-ce-19.03.8 \n"
              - "systemctl enable docker && systemctl start docker \n"
              - "#####  gn5i  ##### \n"
              - "#wget https://${ossName}.oss-cn-beijing.aliyuncs.com/AI_k8s/gn5i_NVIDIA-Linux-x86_64-440.64.00.run\
                \ \n"
              - "#chmod +x gn5i_NVIDIA-Linux-x86_64-440.64.00.run \n"
              - "#./gn5i_NVIDIA-Linux-x86_64-440.64.00.run -q -s \n"
              - instance_type="
              - Ref: WorkerInstanceType
              - "\" \n"
              - "if [[ `echo $instance_type | grep \"gn5i\"` != \"\" ]];then \n"
              - "    wget https://${ossName}.oss-cn-beijing.aliyuncs.com/AI_k8s/gn5i_NVIDIA-Linux-x86_64-440.64.00.run\
                \ \n"
              - "    chmod +x gn5i_NVIDIA-Linux-x86_64-440.64.00.run \n"
              - "    ./gn5i_NVIDIA-Linux-x86_64-440.64.00.run -q -s \n"
              - "elif [ `echo $instance_type | grep \"gn4\"` != \"\" ];then \n"
              - "    wget https://${ossName}.oss-cn-beijing.aliyuncs.com/AI_k8s/gn4_NVIDIA-Linux-x86_64-440.64.00.run\
                \ \n"
              - "   chmod +x gn4_NVIDIA-Linux-x86_64-440.64.00.run \n"
              - "  ./gn4_NVIDIA-Linux-x86_64-440.64.00.run -q -s \n"
              - "elif [ `echo $instance_type | grep \"gn5\"` != \"\" ];then \n"
              - "    wget https://${ossName}.oss-cn-beijing.aliyuncs.com/AI_k8s/gn5_NVIDIA-Linux-x86_64-440.64.00.run\
                \ \n"
              - "    chmod +x gn5_NVIDIA-Linux-x86_64-440.64.00.run \n"
              - "    ./gn5_NVIDIA-Linux-x86_64-440.64.00.run -q -s \n"
              - "elif [ `echo $instance_type | grep \"gn6i\"` != \"\" ];then \n"
              - "   wget https://${ossName}.oss-cn-beijing.aliyuncs.com/AI_k8s/gn6i_NVIDIA-Linux-x86_64-440.64.00.run\
                \ \n"
              - "  chmod +x gn6i_NVIDIA-Linux-x86_64-440.64.00.run \n"
              - " ./gn6i_NVIDIA-Linux-x86_64-440.64.00.run -q -s \n"
              - "elif [ `echo $instance_type | grep \"gn6v\"` != \"\" ];then \n"
              - "   wget https://${ossName}.oss-cn-beijing.aliyuncs.com/AI_k8s/gn6v_NVIDIA-Linux-x86_64-440.64.00.run\
                \ \n"
              - "  chmod +x gn6v_NVIDIA-Linux-x86_64-440.64.00.run \n"
              - " ./gn6v_NVIDIA-Linux-x86_64-440.64.00.run -q -s \n"
              - "else \n"
              - "   wget https://${ossName}.oss-cn-beijing.aliyuncs.com/AI_k8s/NVIDIA-Linux-x86_64-440.64.00.run\
                \ \n"
              - "  chmod +x NVIDIA-Linux-x86_64-440.64.00.run \n"
              - " ./NVIDIA-Linux-x86_64-440.64.00.run \n"
              - "fi \n"
              - "distribution=$(. /etc/os-release;echo $ID$VERSION_ID) \n"
              - "curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.repo\
                \ | sudo tee /etc/yum.repos.d/nvidia-docker.repo \n"
              - "yum install -y nvidia-container-toolkit \n"
              - "#wget https://${ossName}.oss-cn-beijing.aliyuncs.com/AI_k8s/libnvidia-container1-1.0.7-1.x86_64.rpm\
                \ \n"
              - "#rpm -ivh libnvidia-container1-1.0.7-1.x86_64.rpm \n"
              - "##wget https://${ossName}.oss-cn-beijing.aliyuncs.com/AI_k8s/nvidia-container-toolkit-1.0.5-2.x86_64.rpm\
                \ \n"
              - "#rpm -ivh nvidia-container-toolkit-1.0.5-2.x86_64.rpm \n"
              - "##curl -s -L https://nvidia.github.io/nvidia-container-runtime/$distribution/nvidia-container-runtime.repo\
                \ | sudo tee /etc/yum.repos.d/nvidia-container-runtime.repo \n"
              - "##yum -y install nvidia-container-runtime \n"
              - "wget https://${ossName}.oss-cn-beijing.aliyuncs.com/AI_k8s/nvidia-container-runtime-3.1.4-1.x86_64.rpm\
                \ \n"
              - "rpm -ivh nvidia-container-runtime-3.1.4-1.x86_64.rpm \n"
              - "##yum -y install nvidia-docker \n"
              - "wget https://${ossName}.oss-cn-beijing.aliyuncs.com/AI_k8s/nvidia-docker-1.0.1-1.x86_64.rpm\
                \ \n"
              - "rpm -ivh nvidia-docker-1.0.1-1.x86_64.rpm \n"
              - "echo '[plugins.linux]' >>  /etc/containerd/config.toml \n"
              - "echo '   runtime = \"/usr/bin/nvidia-container-runtime\"' >>  /etc/containerd/config.toml\
                \ \n"
              - "mkdir -p /etc/systemd/system/docker.service.d \n"
              - "echo '{' >> /etc/docker/daemon.json \n"
              - "echo '  \"default-runtime\": \"nvidia\",' >> /etc/docker/daemon.json\
                \ \n"
              - "echo '  \"runtimes\": {' >> /etc/docker/daemon.json \n"
              - "echo '    \"nvidia\": {' >> /etc/docker/daemon.json \n"
              - "echo '      \"path\": \"/usr/bin/nvidia-container-runtime\",' >>\
                \ /etc/docker/daemon.json \n"
              - "echo '      \"runtimeArgs\": []' >> /etc/docker/daemon.json \n"
              - "echo '    }' >> /etc/docker/daemon.json \n"
              - "echo '  },' >> /etc/docker/daemon.json \n"
              - "echo '  \"exec-opts\": [\"native.cgroupdriver=systemd\"],' >> /etc/docker/daemon.json\
                \ \n"
              - "echo '  \"log-driver\": \"json-file\",' >> /etc/docker/daemon.json\
                \ \n"
              - "echo '  \"log-opts\": {' >> /etc/docker/daemon.json \n"
              - "echo '    \"max-size\": \"100m\"' >> /etc/docker/daemon.json \n"
              - "echo '  },' >> /etc/docker/daemon.json \n"
              - "echo '  \"storage-driver\": \"overlay2\",' >> /etc/docker/daemon.json\
                \ \n"
              - "echo '  \"storage-opts\": [' >> /etc/docker/daemon.json \n"
              - "echo '    \"overlay2.override_kernel_check=true\"' >> /etc/docker/daemon.json\
                \ \n"
              - "echo '  ]' >> /etc/docker/daemon.json \n"
              - "echo '}' >> /etc/docker/daemon.json \n"
              - "systemctl daemon-reload && systemctl restart docker \n"
              - "docker info | grep Cgroup \n"
              - "docker info | grep nvidia \n"
              - "#docker run --gpus all nvidia/cuda:9.0-base nvidia-smi \n"
              - "echo 'net.ipv4.ip_forward = 1' >> /etc/sysctl.d/k8s.conf \n"
              - "echo 'net.bridge.bridge-nf-call-ip6tables = 1' >> /etc/sysctl.d/k8s.conf\
                \ \n"
              - "echo 'net.bridge.bridge-nf-call-iptables = 1' >> /etc/sysctl.d/k8s.conf\
                \ \n"
              - "sysctl -p /etc/sysctl.d/k8s.conf \n"
              - "echo '[kubernetes]' >> /etc/yum.repos.d/kubernetes.repo \n"
              - "echo 'name=Kubernetes' >> /etc/yum.repos.d/kubernetes.repo \n"
              - "echo 'baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/'\
                \ >> /etc/yum.repos.d/kubernetes.repo \n"
              - "echo 'enabled=1' >> /etc/yum.repos.d/kubernetes.repo \n"
              - "echo 'gpgcheck=1' >> /etc/yum.repos.d/kubernetes.repo \n"
              - "echo 'repo_gpgcheck=1' >> /etc/yum.repos.d/kubernetes.repo \n"
              - "echo 'gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg\
                \ https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg'\
                \ >> /etc/yum.repos.d/kubernetes.repo \n"
              - "yum install -y kubelet-1.15.3-0 kubeadm-1.15.3-0 kubectl-1.15.3-0\
                \ \n"
              - "systemctl enable kubelet && systemctl start kubelet \n"
              - "systemctl restart containerd \n"
              - "while true;do \n"
              - "    if [ -f '/master_ip.info' ];then \n"
              - "        echo 'get master_ip success' >> /root/master_ip.log \n"
              - "        break \n"
              - "    else \n"
              - "        echo 'master_ip is null' >> /root/master_ip.log \n"
              - "        continue \n"
              - "    fi \n"
              - "done \n"
              - "touch get_join_command.sh && chmod +x get_join_command.sh \n"
              - "echo '#!/bin/bash' >> get_join_command.sh \n"
              - "echo 'expect <<EOF' >> get_join_command.sh \n"
              - "echo 'set timeout 10' >> get_join_command.sh \n"
              - "echo 'spawn scp master001:/root/join_k8s_cmd.sh /root/' >> get_join_command.sh\
                \ \n"
              - "echo 'expect {' >> get_join_command.sh \n"
              - "echo '\"yes/no\" {' >> get_join_command.sh \n"
              - "echo 'send \"yes\\n\";exp_continue' >> get_join_command.sh \n"
              - "echo '}' >> get_join_command.sh \n"
              - "echo '\"*password\" {' >> get_join_command.sh \n"
              - echo 'send "
              - Ref: Password
              - "\\n\"' >> get_join_command.sh \n"
              - "echo '}' >> get_join_command.sh \n"
              - "echo '}' >> get_join_command.sh \n"
              - "echo 'expect eof' >> get_join_command.sh \n"
              - "echo 'EOF' >> get_join_command.sh \n"
              - "bash get_join_command.sh \n"
              - "systemctl enable kubelet.service \n"
              - "cd /root && /bin/bash join_k8s_cmd.sh \n"
              - "sleep 30 \n"
              - "touch after_worker_start.sh && chmod +x after_worker_start.sh \n"
              - "echo '#!/bin/bash' >> after_worker_start.sh \n"
              - "echo 'expect <<EOF' >> after_worker_start.sh \n"
              - "echo 'set timeout 10' >> after_worker_start.sh \n"
              - "echo 'spawn ssh master001 \"cd /root && /bin/bash after_worker.sh\
                \ >> after_worker.log && /bin/bash install_arena.sh >> install_arena.log\"\
                ' >> after_worker_start.sh \n"
              - "echo 'expect {' >> after_worker_start.sh \n"
              - "echo '\"*password\" {' >> after_worker_start.sh \n"
              - echo 'send "
              - Ref: Password
              - "\\n\"' >> after_worker_start.sh \n"
              - "echo '}' >> after_worker_start.sh \n"
              - "echo '}' >> after_worker_start.sh \n"
              - "echo 'expect eof' >> after_worker_start.sh \n"
              - "echo 'EOF' >> after_worker_start.sh \n"
              - "sleep 30 \n"
              - "bash after_worker_start.sh \n"
              - "touch /root/start.sh && chmod +x /root/start.sh \n"
              - "echo '#!/bin/bash' >> /root/start.sh \n"
              - "echo 'systemctl daemon-reload && systemctl restart docker' >> /root/start.sh\
                \ \n"
              - "echo 'systemctl restart containerd' >> /root/start.sh \n"
              - "###cd /root/ && bash join_k8s_cmd.sh \n"
              - "##cd /root/ && bash join_k8s_cmd.sh \n"
              - "##scp master001:/root/join_k8s_cmd.sh ./ \n"
              - "##chmod +x join_k8s_cmd.sh && bash join_k8s_cmd.sh \n"
              - "##wget https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/v1.11/nvidia-device-plugin.yml\
                \ \n"
              - "##kubectl create -f nvidia-device-plugin.yml \n"
              - "##kubectl get pods --all-namespaces \n"
              - "sleep 30 \n"
              - "mkdir /root/tmp \n"
              - "echo '#!/bin/bash ' >> /root/tmp/mount.sh \n"
              - 'echo ''sudo mount -t nfs -o vers=4,minorversion=0,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport '
              - Fn::GetAtt:
                - NasMountTarget
                - MountTargetDomain
              - ":/ /mnt' >> /root/tmp/mount.sh \n"
              - "chmod +x /root/tmp/mount.sh \n"
              - "echo 'install nfs /sbin/modprobe --ignore-install nfs nfs4_unique_id=`cat\
                \ /sys/class/dmi/id/product_uuid`' >> /etc/modprobe.d/nfs.conf \n"
              - "touch /install.sh && chmod +x /install.sh \n"
              - "echo '#!/bin/bash' >> /install.sh \n"
              - "echo \"if [ -f '/restart.txt' ];then\" >> /install.sh \n"
              - "echo \"  mv /restart.txt /restart.txt.old && cd /root && /bin/bash\
                \ start.sh >> start.log\" >> /install.sh \n"
              - "echo \"else\" >> /install.sh \n"
              - "echo \"  cd /\" >> /install.sh \n"
              - "echo \"fi\" >> /install.sh \n"
              - "sed -i '/# By default this script does nothing./a bash /install.sh'\
                \ /etc/rc.local \n"
              - "touch restart.txt \n"
              - "#cd / && git clone https://code.aliyun.com/best-practice/099.git\
                \ \n"
              - "ros-notify \n"
              - "#root \n"
        - Ref: ALIYUN::NoValue
    DependsOn:
    - WorkerCenInstanceAttachment
  EcsInvocationWorker:
    Type: ALIYUN::ECS::Invocation
    Properties:
      InstanceIds:
        Fn::GetAtt:
        - WorkerInstanceGroup
        - InstanceIds
      CommandId:
        Ref: EcsCommand
    DependsOn:
    - EcsCommand
    - WorkerEcsWaitCondition
  IpWaitConditionHandle:
    Type: ALIYUN::ROS::WaitConditionHandle
    Properties: {}
  IpWaitCondition:
    Type: ALIYUN::ROS::WaitCondition
    Properties:
      Count: 1
      Handle:
        Ref: IpWaitConditionHandle
      Timeout: 3600
  MasterEcsWaitConditionHandle:
    Type: ALIYUN::ROS::WaitConditionHandle
    Properties: {}
  MasterEcsWaitCondition:
    Type: ALIYUN::ROS::WaitCondition
    Properties:
      Count: 1
      Handle:
        Ref: MasterEcsWaitConditionHandle
      Timeout: 3600
  MasterSecurityGroup:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: MasterVpc
      SecurityGroupIngress:
      - IpProtocol: icmp
        NicType: internet
        PortRange: -1/-1
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        NicType: internet
        PortRange: 3389/3389
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        NicType: internet
        PortRange: 6443/6443
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        NicType: internet
        PortRange: 443/443
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      SecurityGroupName:
        Fn::Join:
        - _
        - - Master-ECS
          - StackId
          - Ref: ALIYUN::StackId
  MasterInstanceGroup:
    Type: ALIYUN::ECS::InstanceGroup
    Properties:
      VpcId:
        Ref: MasterVpc
      VSwitchId:
        Ref: MasterVSwitch
      SecurityGroupId:
        Ref: MasterSecurityGroup
      ImageId:
        Ref: ImageId
      AllocatePublicIP: true
      HostName:
        Fn::Join:
        - ''
        - - master
          - '[1,3]'
      InstanceName:
        Fn::Join:
        - ''
        - - master
          - '[1,3]'
      InstanceType:
        Ref: MasterInstanceType
      InternetMaxBandwidthOut:
        Ref: InternetBandwidth
      MaxAmount: 1
      Password:
        Ref: Password
      ResourceGroupId:
        Fn::If:
        - NotUseResourceGroupId
        - Ref: ALIYUN::NoValue
        - Ref: ResourceGroupId
      SystemDiskCategory:
        Ref: SystemDiskCategory
      SystemDiskSize:
        Ref: SystemDiskSize
      Tags:
      - Key: best_practice
        Value: 099
      UserData:
        Fn::If:
        - CreateCentOS
        - Fn::Replace:
          - ros-notify:
              Fn::GetAtt:
              - MasterEcsWaitConditionHandle
              - CurlCli
          - Fn::Join:
            - ''
            - - "#!/bin/sh \n"
              - "yum -y install nfs-utils jq expect \n"
              - "ossName='ros-template-resources' \n"
              - "master_ip=`ip addr | grep eth0 | grep -o '[0-9]\\{1,3\\}\\.[0-9]\\\
                {1,3\\}\\.[0-9]\\{1,3\\}\\.[0-9]\\{1,3\\}/' | cut -d '/' -f 1` \n"
              - "mkdir /root/tmp \n"
              - '#echo ''sudo mount -t nfs -o vers=4,minorversion=0,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport '
              - Fn::GetAtt:
                - NasMountTarget
                - MountTargetDomain
              - ":/ /mnt' >> /root/tmp/mount.sh \n"
              - worker_ip_json='
              - Fn::GetAtt:
                - IpWaitCondition
                - Data
              - "' \n"
              - "worker_ip=`echo $worker_ip_json | jq .ip | sed 's/\"//g'` \n"
              - "echo \"$worker_ip        worker001        worker001\" >> /etc/hosts\
                \ \n"
              - "master_ip=`ip addr | grep eth0 | grep -o '[0-9]\\{1,3\\}\\.[0-9]\\\
                {1,3\\}\\.[0-9]\\{1,3\\}\\.[0-9]\\{1,3\\}/' | cut -d '/' -f 1` \n"
              - "ssh-keygen -t rsa -P '' -f '/root/.ssh/id_rsa' \n"
              - "touch ssh_copy.sh && chmod +x ssh_copy.sh \n"
              - "echo '#!/bin/bash' >> ssh_copy.sh \n"
              - "echo 'expect <<EOF' >> ssh_copy.sh \n"
              - "echo 'set timeout 150' >> ssh_copy.sh \n"
              - "echo 'spawn ssh-copy-id -i /root/.ssh/id_rsa.pub worker001' >> ssh_copy.sh\
                \ \n"
              - "echo 'expect {' >> ssh_copy.sh \n"
              - "echo '\"yes/no\" {' >> ssh_copy.sh \n"
              - "echo 'send \"yes\\n\";exp_continue' >> ssh_copy.sh \n"
              - "echo '}' >> ssh_copy.sh \n"
              - "echo '\"*password\" {' >> ssh_copy.sh \n"
              - echo 'send "
              - Ref: Password
              - "\\n\"' >> ssh_copy.sh \n"
              - "echo '}' >> ssh_copy.sh \n"
              - "echo '}' >> ssh_copy.sh \n"
              - "echo 'expect eof' >> ssh_copy.sh \n"
              - "echo 'EOF' >> ssh_copy.sh \n"
              - "sleep 60 \n"
              - "bash ssh_copy.sh \n"
              - "ssh worker001 \"echo \"$master_ip        master001        master001\"\
                \ >> /etc/hosts && exit \" \n"
              - "yum -y install yum-utils device-mapper-persistent-data lvm2 \n"
              - "yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\
                \ stable-19.03 \n"
              - "yum -y install docker-ce-19.03.8 \n"
              - "systemctl enable docker && systemctl start docker \n"
              - "mkdir -p /etc/docker \n"
              - "echo '{' >> /etc/docker/daemon.json \n"
              - "echo '  \"exec-opts\": [\"native.cgroupdriver=systemd\"],' >> /etc/docker/daemon.json\
                \ \n"
              - "echo '  \"log-driver\": \"json-file\",' >> /etc/docker/daemon.json\
                \ \n"
              - "echo '  \"log-opts\": {' >> /etc/docker/daemon.json \n"
              - "echo '    \"max-size\": \"100m\"' >> /etc/docker/daemon.json \n"
              - "echo '  },' >> /etc/docker/daemon.json \n"
              - "echo '  \"storage-driver\": \"overlay2\",' >> /etc/docker/daemon.json\
                \ \n"
              - "echo '  \"storage-opts\": [' >> /etc/docker/daemon.json \n"
              - "echo '    \"overlay2.override_kernel_check=true\"' >> /etc/docker/daemon.json\
                \ \n"
              - "echo '  ]' >> /etc/docker/daemon.json \n"
              - "echo '}' >> /etc/docker/daemon.json \n"
              - "mkdir -p /etc/systemd/system/docker.service.d \n"
              - "systemctl daemon-reload && systemctl restart docker \n"
              - "docker info |grep Cgroup \n"
              - "echo 'net.ipv4.ip_forward = 1' >> /etc/sysctl.d/k8s.conf \n"
              - "echo 'net.bridge.bridge-nf-call-ip6tables = 1' >> /etc/sysctl.d/k8s.conf\
                \ \n"
              - "echo 'net.bridge.bridge-nf-call-iptables = 1' >> /etc/sysctl.d/k8s.conf\
                \ \n"
              - "sysctl -p /etc/sysctl.d/k8s.conf \n"
              - "echo '[kubernetes]' >> /etc/yum.repos.d/kubernetes.repo \n"
              - "echo 'name=Kubernetes' >> /etc/yum.repos.d/kubernetes.repo \n"
              - "echo 'baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/'\
                \ >> /etc/yum.repos.d/kubernetes.repo \n"
              - "echo 'enabled=1' >> /etc/yum.repos.d/kubernetes.repo \n"
              - "echo 'gpgcheck=1' >> /etc/yum.repos.d/kubernetes.repo \n"
              - "echo 'repo_gpgcheck=1' >> /etc/yum.repos.d/kubernetes.repo \n"
              - "echo 'gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg\
                \ https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg'\
                \ >> /etc/yum.repos.d/kubernetes.repo \n"
              - "yum install -y kubelet-1.15.3-0 kubeadm-1.15.3-0 kubectl-1.15.3-0\
                \ \n"
              - "systemctl enable kubelet && systemctl start kubelet \n"
              - "kubeadm init --pod-network-cidr=172.16.20.0/16 --image-repository\
                \ registry.aliyuncs.com/google_containers --kubernetes-version=1.15.3\
                \ >> /root/tmp/join_k8s_cmd.log \n"
              - "wait \n"
              - "cd / \n"
              - "echo '#!/bin/bash' >> /root/join_k8s_cmd.sh \n"
              - "cat /root/tmp/join_k8s_cmd.log | grep 'kubeadm join .*' >> /root/join_k8s_cmd.sh\
                \ \n"
              - "cat /root/tmp/join_k8s_cmd.log | grep 'discovery.*' >> /root/join_k8s_cmd.sh\
                \ \n"
              - "chmod +x /root/join_k8s_cmd.sh \n"
              - "#scp /root/join_k8s_cmd.sh worker001:/root/ \n"
              - "mkdir -p /root/.kube \n"
              - "sudo cp -i /etc/kubernetes/admin.conf /root/.kube/config \n"
              - "sudo chown $(id -u):$(id -g) /root/.kube/config \n"
              - "echo \"export KUBECONFIG=/root/.kube/config\" >> ~/.bash_profile\
                \ \n"
              - "source ~/.bash_profile \n"
              - "wget http://mirror.faasx.com/k8s/calico/v3.3.2/rbac-kdd.yaml \n"
              - "wget http://mirror.faasx.com/k8s/calico/v3.3.2/calico.yaml \n"
              - "sed -i 's/192.168.0.0/172.16.20.0/' calico.yaml \n"
              - "sleep 60 \n"
              - "kubectl create -f rbac-kdd.yaml \n"
              - "kubectl create -f calico.yaml \n"
              - "sudo kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml\
                \ \n"
              - "systemctl daemon-reload \n"
              - "#kubectl get nodes \n"
              - "sleep 60 \n"
              - "sudo kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml\
                \ \n"
              - "#wget https://${ossName}.oss-cn-beijing.aliyuncs.com/AI_k8s/kube-flannel.yml\
                \ \n"
              - "#sudo kubectl apply -f kube-flannel.yml \n"
              - "systemctl daemon-reload \n"
              - "ssh worker001 \"echo \"$master_ip\" >> /master_ip.info && exit \"\
                \ \n"
              - "echo '#!/bin/bash ' >> /root/tmp/mount.sh \n"
              - 'echo ''sudo mount -t nfs -o vers=4,minorversion=0,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport '
              - Fn::GetAtt:
                - NasMountTarget
                - MountTargetDomain
              - ":/ /mnt' >> /root/tmp/mount.sh \n"
              - "chmod +x /root/tmp/mount.sh \n"
              - "##### after worker node \n"
              - "touch /root/after_worker.sh && chmod +x /root/after_worker.sh \n"
              - "echo '#/bin/bash' >> /root/after_worker.sh \n"
              - "echo 'kubectl get nodes' >> /root/after_worker.sh \n"
              - "echo 'kubectl label node worker001 node-role.kubernetes.io/worker=worker'\
                \ >> /root/after_worker.sh \n"
              - "echo 'kubectl get nodes' >> /root/after_worker.sh \n"
              - "echo \"wget https://${ossName}.oss-cn-beijing.aliyuncs.com/AI_k8s/nvidia-device-plugin.yml\"\
                \ >> /root/after_worker.sh \n"
              - "echo 'kubectl create -f nvidia-device-plugin.yml' >> /root/after_worker.sh\
                \ \n"
              - "echo 'kubectl get pods --all-namespaces' >> /root/after_worker.sh\
                \ \n"
              - "##### install arena  \n"
              - "touch /root/install_arena.sh && chmod +x /root/install_arena.sh \n"
              - "echo '#!/bin/bash' >> /root/install_arena.sh \n"
              - "echo '###install arena' >> /root/install_arena.sh \n"
              - "echo \"wget https://${ossName}.oss-cn-beijing.aliyuncs.com/AI_k8s/arena-installer-0.3.1-b96e1ac-linux-amd64.tar.gz\"\
                \ >> /root/install_arena.sh \n"
              - "echo 'tar xzvf arena-installer-0.3.1-b96e1ac-linux-amd64.tar.gz'\
                \ >> /root/install_arena.sh \n"
              - "echo 'cd arena-installer' >> /root/install_arena.sh \n"
              - "echo 'sh -x install.sh' >> /root/install_arena.sh \n"
              - "echo 'yum install bash-completion -y' >> /root/install_arena.sh \n"
              - "echo 'echo \"source <(arena completion bash)\" >> ~/.bashrc' >> /root/install_arena.sh\
                \ \n"
              - "echo 'chmod u+x ~/.bashrc' >> /root/install_arena.sh \n"
              - "echo 'arena version' >> /root/install_arena.sh \n"
              - "echo 'arena top node -d' >> /root/install_arena.sh \n"
              - "#cd /root && bash install_arena.sh >> install_arena.log \n"
              - "#nas-pv.yaml \n"
              - "echo 'apiVersion: v1' >>  /root/nas-pv.yaml \n"
              - "echo 'kind: PersistentVolume' >>  /root/nas-pv.yaml \n"
              - "echo 'metadata:' >>  /root/nas-pv.yaml \n"
              - "echo '  name: pv-nas' >>  /root/nas-pv.yaml \n"
              - "echo '  labels:' >>  /root/nas-pv.yaml \n"
              - "echo '    servedata: nas-serve' >>  /root/nas-pv.yaml \n"
              - "echo 'spec: ' >>  /root/nas-pv.yaml \n"
              - "echo '  persistentVolumeReclaimPolicy: Retain ' >>  /root/nas-pv.yaml\
                \ \n"
              - "echo '  capacity:' >>  /root/nas-pv.yaml \n"
              - "echo '    storage: 100Gi' >>  /root/nas-pv.yaml \n"
              - "echo '  accessModes:' >>  /root/nas-pv.yaml \n"
              - "echo '  - ReadWriteMany' >>  /root/nas-pv.yaml \n"
              - "echo '  nfs:' >>  /root/nas-pv.yaml \n"
              - 'echo ''    server: '
              - Fn::GetAtt:
                - NasMountTarget
                - MountTargetDomain
              - "' >>  /root/nas-pv.yaml \n"
              - "echo '    path: \"/\"' >>  /root/nas-pv.yaml \n"
              - "# kubectl create -f nas-pv.yaml \n"
              - "# nas-pvc.yaml \n"
              - "echo 'apiVersion: v1' >>  /root/nas-pvc.yaml \n"
              - "echo 'kind: PersistentVolumeClaim' >>  /root/nas-pvc.yaml \n"
              - "echo 'metadata:' >>  /root/nas-pvc.yaml \n"
              - "echo '  name: pvc-nas' >>  /root/nas-pvc.yaml \n"
              - "echo '  annotations:' >>  /root/nas-pvc.yaml \n"
              - "echo '    description: \"this is the serve demo\"' >>  /root/nas-pvc.yaml\
                \ \n"
              - "echo 'spec:' >>  /root/nas-pvc.yaml \n"
              - "echo '  accessModes:' >>  /root/nas-pvc.yaml \n"
              - "echo '    - ReadWriteMany' >>  /root/nas-pvc.yaml \n"
              - "echo '  resources:' >>  /root/nas-pvc.yaml \n"
              - "echo '    requests:' >>  /root/nas-pvc.yaml \n"
              - "echo '       storage: 100Gi' >>  /root/nas-pvc.yaml \n"
              - "echo '  selector:' >>  /root/nas-pvc.yaml \n"
              - "echo '    matchLabels:' >>  /root/nas-pvc.yaml \n"
              - "echo '      servedata: nas-serve' >>  /root/nas-pvc.yaml \n"
              - "touch /root/deploy.sh && chmod +x /root/deploy.sh \n"
              - "echo '#!/bin/bash' >> /root/deploy.sh \n"
              - "echo 'kubectl create -f nas-pvc.yaml' >> /root/deploy.sh \n"
              - "echo 'kubectl get pvc' >> /root/deploy.sh \n"
              - "#create reasoning \n"
              - "echo 'arena serve custom --name=perseus-serving --gpus=1 --replicas=1\
                \ --port=8001 --restful-port=8000 --image=registry.cn-shanghai.aliyuncs.com/ai_beijing/perseus_inference:v24\
                \ --data=pvc-nas:/mnt \"/opt/perseus/bin/perseus_model_server --model-store=/mnt\"\
                ' >> /root/deploy.sh \n"
              - "echo 'arena serve list' >> /root/deploy.sh  \n"
              - "echo 'arena serve logs perseus-serving' >> /root/deploy.sh \n"
              - "echo 'arena serve list' >> /root/deploy.sh \n"
              - "echo 'kubectl get service' >> /root/deploy.sh \n"
              - "#create reasoning client \n"
              - "echo 'apiVersion: extensions/v1beta1' >> deploy-client.yaml \n"
              - "echo 'kind: Deployment' >> deploy-client.yaml \n"
              - "echo 'metadata:' >> deploy-client.yaml \n"
              - "echo '  name: perseus-client' >> deploy-client.yaml \n"
              - "echo '  namespace: default' >> deploy-client.yaml \n"
              - "echo 'spec:' >> deploy-client.yaml \n"
              - "echo '  replicas: 1' >> deploy-client.yaml \n"
              - "echo '  template:' >> deploy-client.yaml \n"
              - "echo '    metadata:' >> deploy-client.yaml \n"
              - "echo '      labels:' >> deploy-client.yaml \n"
              - "echo '        app: perseus-client' >> deploy-client.yaml \n"
              - "echo '        name: perseus-client' >> deploy-client.yaml \n"
              - "echo '    spec:' >> deploy-client.yaml \n"
              - "echo '      containers:' >> deploy-client.yaml \n"
              - "echo '      - name: perseus-client' >> deploy-client.yaml \n"
              - "echo '        image: registry.cn-shanghai.aliyuncs.com/ai_beijing/perseus_inference:v24'\
                \ >> deploy-client.yaml \n"
              - "echo '        command: [\"/bin/sh\", \"-c\"]' >> deploy-client.yaml\
                \ \n"
              - "echo '        args: [\"sleep 36000000\"]        # for pausing' >>\
                \ deploy-client.yaml \n"
              - "echo '        imagePullPolicy: Always' >> deploy-client.yaml \n"
              - "echo '      restartPolicy: Always' >> deploy-client.yaml \n"
              - "echo 'cat deploy-client.yaml' >> /root/deploy.sh \n"
              - "echo 'kubectl create -f deploy-client.yaml' >> /root/deploy.sh \n"
              - "echo 'kubectl  get pods' >> /root/deploy.sh \n"
              - "#login reasoning client for container env \n"
              - "# kubectl exec -it perseus-client-*****  /bin/bash \n"
              - "ros-notify \n"
        - Ref: ALIYUN::NoValue
    DependsOn:
    - IpWaitCondition
    - WorkerCenInstanceAttachment
  MasterEcsInvocation:
    Type: ALIYUN::ECS::Invocation
    Properties:
      InstanceIds:
        Fn::GetAtt:
        - MasterInstanceGroup
        - InstanceIds
      CommandId:
        Ref: EcsCommand
    DependsOn:
    - EcsCommand
    - MasterEcsWaitCondition
Outputs:
  CenInstanceId:
    Value:
      Fn::GetAtt:
      - CenInstance
      - CenId
  MasterInstancePrivateIp:
    Value:
      Fn::Select:
      - '0'
      - Fn::GetAtt:
        - MasterInstanceGroup
        - PrivateIps
  MasterInstancePublicIp:
    Value:
      Fn::Select:
      - '0'
      - Fn::GetAtt:
        - MasterInstanceGroup
        - PublicIps
  MasterVpcId:
    Value:
      Fn::GetAtt:
      - MasterVpc
      - VpcId
  WorkerInstancePrivateIp:
    Value:
      Fn::Select:
      - '0'
      - Fn::GetAtt:
        - WorkerInstanceGroup
        - PrivateIps
  WorkerInstancePublicIp:
    Value:
      Fn::Select:
      - '0'
      - Fn::GetAtt:
        - WorkerInstanceGroup
        - PublicIps
  WorkerVpcId:
    Value:
      Fn::GetAtt:
      - WorkerVpc
      - VpcId
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
    - Parameters:
      - VpcCidrBlock
      - MasterVSwitchZoneId
      - MasterVSwitchCidrBlock
      - WorkerVSwitchZoneId
      - WorkerVSwitchCidrBlock
      Label:
        default: VPC
    - Parameters:
      - MasterInstanceType
      - WorkerInstanceType
      - ImageId
      - SystemDiskCategory
      - SystemDiskSize
      - InternetBandwidth
      - Password
      - ResourceGroupId
      Label:
        default: ECS
    TemplateTags:
    - acs:solution:机器学习&人工智能:混合云使用飞天AI加速工具
  ALIYUN::ROS::Composer:
    3411eb45:
      Rect:
        - 1272
        - 812
        - 40
        - 100
        - 1
        - 0
      ResT: Composer::ROSParameter::AlibabaCloud
    a77d13a2:
      Parent: 3411eb45
      Rect:
        - 1236
        - 752
        - 60
        - 144
        - 2
        - 0
      ResT: Composer::ROSParameter::Region
    58c1c16e:
      Res:
        - CenInstance
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 680
        - 184
        - 3
        - 0
    3e37ac5b:
      Res:
        - CommandWaitConditionHandle
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 720
        - 780
        - 3
        - 0
      Hidden: true
    bf999e6f:
      Res:
        - CommandWaitCondition
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 780
        - 490
        - 3
        - 0
      Hidden: true
    bcede54c:
      Res:
        - MasterVpc
      Parent: a77d13a2
      Rect:
        - 511
        - 319
        - 749
        - 290
        - 3
        - 0
    d1fe84f0:
      Res:
        - NasAccessGroup
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 953
        - 663
        - 3
        - 0
      Hidden: true
    30c8be95:
      Res:
        - NasAccessRule
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 1200
        - 686
        - 3
        - 0
      Hidden: true
    efc70f36:
      Res:
        - NasFileSystem
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 700
        - 820
        - 3
        - 0
    5add7d82:
      Res:
        - EcsCommand
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 600
        - 200
        - 3
        - 0
      Hidden: true
    4ef6eb2a:
      Res:
        - WorkerEcsWaitConditionHandle
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 780
        - 780
        - 3
        - 0
      Hidden: true
    9f78345d:
      Res:
        - WorkerEcsWaitCondition
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 80
        - 780
        - 3
        - 0
      Hidden: true
    a3245aef:
      Res:
        - WorkerVpc
      Parent: a77d13a2
      Rect:
        - 520
        - 317
        - 158
        - 292
        - 3
        - 0
    8b12b04d:
      Res:
        - EcsInvocationWorker
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 660
        - 200
        - 3
        - 0
      Hidden: true
    ff592b24:
      Res:
        - IpWaitConditionHandle
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 80
        - 840
        - 3
        - 0
      Hidden: true
    22f4d03a:
      Res:
        - IpWaitCondition
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 600
        - 780
        - 3
        - 0
      Hidden: true
    89dbddb7:
      Res:
        - MasterEcsWaitConditionHandle
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 600
        - 840
        - 3
        - 0
      Hidden: true
    e7054cec:
      Res:
        - MasterEcsWaitCondition
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 660
        - 780
        - 3
        - 0
      Hidden: true
    67f119ed:
      Res:
        - MasterEcsInvocation
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 720
        - 200
        - 3
        - 0
      Hidden: true
    290b7f09:
      Res:
        - NasMountTarget
      Parent: a77d13a2
      Rect:
        - 40
        - 40
        - 700
        - 703
        - 3
        - 0
    2bdf23ec:
      Res:
        - MasterVSwitch
      Parent: bcede54c
      Rect:
        - 400
        - 200
        - 840
        - 340
        - 4
        - 0
    bd5740a9:
      Res:
        - MasterCenInstanceAttachment
      Parent: bcede54c
      Rect:
        - 40
        - 40
        - 780
        - 450
        - 4
        - 0
    61b615c7:
      Res:
        - WorkerVSwitch
      Parent: a3245aef
      Rect:
        - 351
        - 200
        - 196
        - 360
        - 4
        - 0
    a03fc72f:
      Res:
        - WorkerCenInstanceAttachment
      Parent: a3245aef
      Rect:
        - 40
        - 40
        - 583
        - 450
        - 4
        - 0
    be537bfd:
      Edge:
        - bf999e6f
        - 3e37ac5b
      Line: 0:0:0:gray:0
    2f15d8a9:
      Parent: a77d13a2
      Edge:
        - 30c8be95
        - d1fe84f0
      Line: 0:0:0:gray:0
    251d4744:
      Parent: a77d13a2
      Edge:
        - 290b7f09
        - d1fe84f0
      Line: 0:0:0:gray:0
    0375f468:
      Parent: a77d13a2
      Edge:
        - 290b7f09
        - efc70f36
      Line: 0:0:0:gray:0
    16fec6d7:
      Edge:
        - 9f78345d
        - 4ef6eb2a
      Line: 0:0:0:gray:0
    ee7fc640:
      Parent: a77d13a2
      Edge:
        - bd5740a9
        - 58c1c16e
      Line: 0:0:0:gray:0
    182debde:
      Parent: a77d13a2
      Edge:
        - a03fc72f
        - 58c1c16e
      Line: 0:0:0:gray:0
    56d667df:
      Parent: a77d13a2
      Edge:
        - ccff644f
        - 290b7f09
      Line: 0:0:0:gray:0
    0945973b:
      Parent: a77d13a2
      Edge:
        - 8b12b04d
        - ccff644f
      Line: 0:0:0:gray:0
    f8d96c72:
      Edge:
        - 8b12b04d
        - 5add7d82
      Line: 0:0:0:gray:0
    897566a0:
      Edge:
        - 22f4d03a
        - ff592b24
      Line: 0:0:0:gray:0
    ce9cd440:
      Edge:
        - e7054cec
        - 89dbddb7
      Line: 0:0:0:gray:0
    7a5d604a:
      Parent: a77d13a2
      Edge:
        - d9703125
        - 290b7f09
      Line: 0:0:0:gray:0
    fa3a8b34:
      Parent: a77d13a2
      Edge:
        - 67f119ed
        - d9703125
      Line: 0:0:0:gray:0
    6fd2ed43:
      Edge:
        - 67f119ed
        - 5add7d82
      Line: 0:0:0:gray:0
    4549349d:
      Res:
        - MasterSecurityGroup
      Parent: bcede54c
      Rect:
        - 179
        - 110
        - 952
        - 398
        - 28
        - 0
    98f40353:
      Res:
        - WorkerSecurityGroup
      Parent: a3245aef
      Rect:
        - 161
        - 96
        - 279
        - 419
        - 28
        - 0
    d9703125:
      Res:
        - MasterInstanceGroup
      Parent: 2bdf23ec
      Rect:
        - 40
        - 40
        - 1020
        - 430
        - 29
        - 0
      Layer:
        - 4549349d
    ccff644f:
      Res:
        - WorkerInstanceGroup
      Parent: 61b615c7
      Rect:
        - 40
        - 40
        - 342
        - 440
        - 29
        - 0
      Layer:
        - 98f40353
