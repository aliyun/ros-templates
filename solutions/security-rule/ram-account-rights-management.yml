ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 单账号多环境RAM用户与资源治理方案，含VPC、ECS、OSS、RDS资源分组、权限配置及自动化部署策略。
  en: Single-account Multi-environment RAM User and Resource Governance Solution,
    encompassing VPC, ECS, OSS, RDS resource grouping, permission configurations,
    and automated deployment strategies.
Parameters:
  ResourceGroupId1Dev:
    Type: String
    Label:
      en: Development Resource Group ID
      zh-cn: 开发资源组ID
    Description:
      en: <font color='blue'><b>Development environment resource group ID where the
        instance is located
      zh-cn: <font color='blue'><b>实例所在的开发环境资源组ID。
    MinLength: 3
  ResourceGroupId2Prod:
    Type: String
    Label:
      en: Production Resource Group ID
      zh-cn: 生产资源组ID
    Description:
      en: <font color='blue'><b>The production environment resource group ID of the
        instance
      zh-cn: <font color='blue'><b>实例所在的生产环境资源组ID。
    MinLength: 3
  ResourceGroupId3Test:
    Type: String
    Label:
      en: Test Resource Group ID
      zh-cn: 测试资源组ID
    Description:
      en: <font color='blue'><b>The test environment resource group ID of the instance
      zh-cn: <font color='blue'><b>实例所在的测试环境资源组ID。
    MinLength: 3
  VpcCidrBlock1Dev:
    Type: String
    Label:
      en: Develop Environment VPC CIDR Block
      zh-cn: 开发环境专有网络网段
    Description:
      en: Develop Environment VPC CIDR Block
      zh-cn: 开发环境专有网络网段
    Default: 172.16.0.0/12
    AllowedValues:
    - 10.0.0.0/8
    - 172.16.0.0/12
    - 192.168.0.0/16
  VpcCidrBlock2Prod:
    Type: String
    Label:
      en: Production Environment VPC CIDR Block
      zh-cn: 生产环境专有网络网段
    Description:
      en: Production Environment VPC CIDR Block
      zh-cn: 生产环境专有网络网段
    Default: 10.0.0.0/8
    AllowedValues:
    - 10.0.0.0/8
    - 172.16.0.0/12
    - 192.168.0.0/16
  VpcCidrBlock3Test:
    Type: String
    Label:
      en: Test Environment VPC CIDR Block
      zh-cn: 测试环境专有网络网段
    Description:
      en: Test Environment VPC CIDR Block
      zh-cn: 测试环境专有网络网段
    Default: 192.168.0.0/16
    AllowedValues:
    - 10.0.0.0/8
    - 172.16.0.0/12
    - 192.168.0.0/16
  VSwitchZoneId:
    Type: String
    Label:
      en: VSwitch Availability Zone
      zh-cn: 交换机可用区
    Description:
      en: Availability Zone ID,<br><b>note： <font color='blue'>Before selecting, please
        confirm that the Availability Zone supports the specification of creating
        ECS resources</font></b>
      zh-cn: 可用区ID。<br><b>注： <font color='blue'>选择可用区前请确认该可用区是否支持创建ECS资源的规格</font></b>
    AssociationProperty: ALIYUN::ECS::Instance:ZoneId
  VSwitchCidrBlockDev:
    Type: String
    Label:
      en: Develop VSwitch CIDR Block
      zh-cn: 开发交换机网段
    Description:
      en: Must be a sub-network segment of the proprietary network and is not occupied
        by other VSwitches.
      zh-cn: 必须是所属专有网络的子网段，并且没有被其他交换机占用。
    Default: 172.16.10.0/24
  VSwitchCidrBlockProd:
    Type: String
    Label:
      en: Production VSwitch CIDR Block
      zh-cn: 生产交换机网段
    Description:
      en: Must be a sub-network segment of the proprietary network and is not occupied
        by other VSwitches.
      zh-cn: 必须是所属专有网络的子网段，并且没有被其他交换机占用。
    Default: 10.0.10.0/24
  VSwitchCidrBlockTest:
    Type: String
    Label:
      en: Test VSwitch CIDR Block
      zh-cn: 测试交换机网段
    Description:
      en: Must be a sub-network segment of the proprietary network and is not occupied
        by other VSwitches.
      zh-cn: 必须是所属专有网络的子网段，并且没有被其他交换机占用。
    Default: 192.168.10.0/24
  EcsInstanceType:
    Type: String
    Label:
      en: Instance Type
      zh-cn: 实例规格
    Description:
      en: <font color='blue'><b>1.Before selecting the model please confirm that the
        current available zone under the model is in stock, some models need to be
        reported in advance</b></font><br><font color='blue'><b>2.List of optional
        models</font><br></b></font>[ecs.c5.large <font color='green'>2vCPU 4GiB Intranet
        bandwidth1Gbps In-grid sending and receiving packages30MillionPPS</font>]<br></b>[ecs.c5.xlarge
        <font color='green'>4vCPU 8GiB Intranet bandwidth1.5Gbps In-grid sending and
        receiving packages50MillionPPS</font>]<br></b>[ecs.c5.2xlarge <font color='green'>8vCPU
        16GiB Intranet bandwidth2.5Gbps In-grid sending and receiving packages80MillionPPS</font>]
      zh-cn: <font color='blue'><b>1.选择机型前请先确认当前可用区下该机型是否有货，部分机型需要提前报备</b></font><br><font
        color='blue'><b>2.可选机型列表</font><br></b></font>[ecs.c5.large <font color='green'>2vCPU
        4GiB 内网带宽1Gbps 内网收发包30万PPS</font>]<br></b>[ecs.c5.xlarge <font color='green'>4vCPU
        8GiB 内网带宽1.5Gbps 内网收发包50万PPS</font>]<br></b>[ecs.c5.2xlarge <font color='green'>8vCPU
        16GiB 内网带宽2.5Gbps 内网收发包80万PPS</font>]
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
  EcsImageId:
    Type: String
    Label:
      en: Image
      zh-cn: 镜像
    Description:
      en: Image ID，see detail：<b><a href='https://www.alibabacloud.com/help/en/doc-detail/112977.html'
        target='_blank'><font color='blue'>Find the mirror</font></a></b>
      zh-cn: 镜像ID, 详见：<b><a href='https://help.aliyun.com/document_detail/112977.html'
        target='_blank'><font color='blue'>查找镜像</font></a></b>
    Default: centos_7
  EcsSystemDiskCategory:
    Type: String
    Label:
      en: System Disk Type
      zh-cn: 系统盘类型
    Description:
      en: '<font color=''blue''><b>Optional values:</b></font><br>[cloud_efficiency:
        <font color=''green''>Efficient Cloud Disk</font>]<br>[cloud_ssd: <font color=''green''>SSD
        Cloud Disk</font>]<br>[cloud_essd: <font color=''green''>ESSD Cloud Disk</font>]<br>[cloud:
        <font color=''green''>Cloud Disk</font>]<br>[ephemeral_ssd: <font color=''green''>Local
        SSD Cloud Disk</font>]'
      zh-cn: '<font color=''blue''><b>可选值：</b></font><br>[cloud_efficiency: <font
        color=''green''>高效云盘</font>]<br>[cloud_ssd: <font color=''green''>SSD云盘</font>]<br>[cloud_essd:
        <font color=''green''>ESSD云盘</font>]<br>[cloud: <font color=''green''>普通云盘</font>]<br>[ephemeral_ssd:
        <font color=''green''>本地SSD盘</font>]'
    Default: cloud_efficiency
    AllowedValues:
    - cloud_efficiency
    - cloud_ssd
    - cloud
    - cloud_essd
    - ephemeral_ssd
  EcsGroupSystemDiskSize:
    Type: Number
    Label:
      en: System Disk Space
      zh-cn: 系统盘空间
    Description:
      en: 'System disk size, range of values: 40-500, units: GB.'
      zh-cn: 系统盘大小, 取值范围：[40, 500], 单位：GB。
    Default: 40
  EcsPassword:
    Type: String
    Label:
      en: Instance Password
      zh-cn: 实例密码
    Description:
      en: Server login password, Length 8-30, must contain three(Capital letters,
        lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol
        in).
      zh-cn: 服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）。
    ConstraintDescription:
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers,
        ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in).
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）。
    AllowedPattern: '[0-9A-Za-z\_\-\&:;''<>,=%`~!@#\(\)\$\^\*\+\|\{\}\[\]\.\?\/]+$'
    MinLength: 8
    MaxLength: 30
    NoEcho: true
  DBInstanceEngineAndVersion:
    Type: String
    Label:
      en: Type And Version
      zh-cn: 类型与版本号
    Description:
      en: Database type and version number.
      zh-cn: 数据库类型与版本号。
    Default: MySQL-5.7
    AllowedValues:
    - MySQL-5.5
    - MySQL-5.6
    - MySQL-5.7
    - MySQL-8.0
  DBInstanceClass:
    Type: String
    Label:
      en: Specifications
      zh-cn: 实例规格
    Description:
      en: 'Select the instance specification based on the type of database engine
        and the available area support;<br>See detail: <a href=''https://www.alibabacloud.com/help/doc-detail/26312.htm''
        target=''_blank''><b><font color=''blue''>Instance specification sheet</font></b></a>'
      zh-cn: 根据数据库引擎的类型和可用的区域支持选择实例规格；<br>请参见详细信息：<a href='https://help.aliyun.com/document_detail/26312.html'
        target='_blank'><b><font color='blue'>实例规格列表</font></b></a>
    Default: rds.mysql.s2.large
    AllowedValues:
    - rds.mysql.s2.large
    - rds.mysql.s2.xlarge
    - rds.mysql.s3.large
    - rds.mysql.m1.medium
    - rds.mysql.c1.large
    - rds.mysql.c1.xlarge
  DBInstanceStorage:
    Type: Number
    Label:
      en: Storage Space
      zh-cn: 存储空间
    Description:
      en: 'Database storage space, units: GB, per 5GB increment, value range: 5-1000.'
      zh-cn: 数据库存储空间, 单位：GB, 每5GB进行递增，取值范围：5-1000。
    Default: 5
    MinValue: 5
    MaxValue: 1000
  BucketAccessControl:
    Type: String
    Label:
      en: Access Control
      zh-cn: 读写权限
    Description:
      en: '<font color=''blue''><b>Optional values: </b></font><br>[private：<font
        color=''green''>All access to the file requires authentication</font>]<br>[public-read：<font
        color=''green''>File writes need to be authenticated；Files can be read anonymously</font>]<br>[public-read-write：<font
        color=''green''>Anyone (including anonymous visitors) can perform read and
        write operators on the files in the bucket</font>]'
      zh-cn: '<font color=''blue''><b>可选值: </b></font><br>[private：<font color=''green''>对文件的所有访问操作需要进行身份验证</font>]<br>[public-read：<font
        color=''green''>对文件写操作需要进行身份验证；可以对文件进行匿名读</font>]<br>[public-read-write：<font
        color=''green''>所有人都可以对文件进行读写操作</font>]'
    Default: private
    AllowedValues:
    - private
    - public-read
    - public-read-write
  BucketStorageClass:
    Type: String
    Label:
      en: Storage Type
      zh-cn: 存储类型
    Description:
      en: '<font color=''blue''><b>Optional values: </b></font><br>[Standard：<font
        color=''green''>Standard storage type</font>]<br>[IA：<font color=''green''>Low
        frequency access storage type</font>]<br>[Archive：<font color=''green''>Archive
        storage type</font>]'
      zh-cn: '<font color=''blue''><b>可选值: </b></font><br>[Standard：<font color=''green''>标准存储类型</font>]<br>[IA：<font
        color=''green''>低频访问存储类型</font>]<br>[Archive：<font color=''green''>归档存储类型</font>]'
    Default: Standard
    AllowedValues:
    - Standard
    - IA
    - Archive
  BucketName1Dev:
    Type: String
    Label:
      en: Develop Bucket Name
      zh-cn: 开发存储空间名称
    Description:
      en: The name must be 3 to 63 bytes in length, The name must start and end with
        a lowercase letter or digit.The name can contain only lowercase letters, digits,
        and hyphens (-);<br><b>note：<font color='blue'>A bucket name must be globally
        unique within OSS. Bucket names cannot be changed after the bucket is created.</b></font>
      zh-cn: 长度为3~63个字符，必须以小写字母或数字开头和结尾，可以包含小写字母、数字和连字符(-);<br><font color='blue'><b>注：需要全网唯一性，已经存在的不能在创建</b></font>
    Default: ros-projects-dev
  BucketName2Prod:
    Type: String
    Label:
      en: Production Bucket Name
      zh-cn: 生产存储空间名称
    Description:
      en: The name must be 3 to 63 bytes in length, The name must start and end with
        a lowercase letter or digit.The name can contain only lowercase letters, digits,
        and hyphens (-);<br><b>note：<font color='blue'>A bucket name must be globally
        unique within OSS. Bucket names cannot be changed after the bucket is created.</b></font>
      zh-cn: 长度为3~63个字符，必须以小写字母或数字开头和结尾，可以包含小写字母、数字和连字符(-);<br><font color='blue'><b>注：需要全网唯一性，已经存在的不能在创建</b></font>
    Default: ros-projects-prod
  BucketName3Test:
    Type: String
    Label:
      en: Test Bucket Name
      zh-cn: 测试存储空间名称
    Description:
      en: The name must be 3 to 63 bytes in length, The name must start and end with
        a lowercase letter or digit.The name can contain only lowercase letters, digits,
        and hyphens (-);<br><b>note：<font color='blue'>A bucket name must be globally
        unique within OSS. Bucket names cannot be changed after the bucket is created.</b></font>
      zh-cn: 长度为3~63个字符，必须以小写字母或数字开头和结尾，可以包含小写字母、数字和连字符(-);<br><font color='blue'><b>注：需要全网唯一性，已经存在的不能在创建</b></font>
    Default: ros-projects-test
  BucketName4Code:
    Type: String
    Label:
      en: Code Release Bucket Name
      zh-cn: 代码发布空间名称
    Description:
      en: The name must be 3 to 63 bytes in length, The name must start and end with
        a lowercase letter or digit.The name can contain only lowercase letters, digits,
        and hyphens (-);<br><b>note：<font color='blue'>A bucket name must be globally
        unique within OSS. Bucket names cannot be changed after the bucket is created.</b></font>
      zh-cn: 长度为3~63个字符，必须以小写字母或数字开头和结尾，可以包含小写字母、数字和连字符(-);<br><font color='blue'><b>注：需要全网唯一性，已经存在的不能在创建</b></font>
    Default: ros-projects-code
  BucketName5Other:
    Type: String
    Label:
      en: Other Bucket Name
      zh-cn: 其他存储空间名称
    Description:
      en: The name must be 3 to 63 bytes in length, The name must start and end with
        a lowercase letter or digit.The name can contain only lowercase letters, digits,
        and hyphens (-);<br><b>note：<font color='blue'>A bucket name must be globally
        unique within OSS. Bucket names cannot be changed after the bucket is created.</b></font>
      zh-cn: 长度为3~63个字符，必须以小写字母或数字开头和结尾，可以包含小写字母、数字和连字符(-);<br><font color='blue'><b>注：需要全网唯一性，已经存在的不能在创建</b></font>
    Default: ros-projects-other
  BucketName4CodeFolderName:
    Type: String
    Label:
      en: Publish Directory
      zh-cn: 发布存储空间发布目录
    Description:
      en: The directory to be created in the publishing storage space divides the
        read and write permissions of user groups to the publishing storage space
        folder，;<br> does not allow names like ”/“or “..”Subdirectory, length 1-254
        characters.
      zh-cn: 即将在发布存储空间创建的目录，划分用户组对发布存储空间文件夹的读写权限；<br>不允许出现名为 “/”或“..”的子目录，长度1-254个字符。
    Default: release
    MinLength: 1
    MaxLength: 254
  BucketName5CodeFolderName:
    Type: String
    Label:
      en: Production Directory
      zh-cn: 发布存储空间生产目录
    Description:
      en: The directory to be created in the publishing storage space divides the
        read and write permissions of user groups to the publishing storage space
        folder，;<br> does not allow names like ”/“or “..”Subdirectory, length 1-254
        characters.
      zh-cn: 即将在发布存储空间创建的目录，划分用户组对发布存储空间文件夹的读写权限；<br>不允许出现名为 “/”或“..”的子目录，长度1-254个字符。
    Default: prod
    MinLength: 1
    MaxLength: 254
  GroupName4Sa:
    Type: String
    Label:
      en: Operation User Group Name
      zh-cn: 运维用户组名称
    Description:
      en: 'Operation group user group, 1 to 64 characters in length, including English
        letters, Numbers, and hyphens (-);<br><b>note: <font color=''blue''>unique
        in account</b></font>'
      zh-cn: 运维组用户组, 长度为1~64个字符，可包含英文字母、数字，和连字符（-）；<br><b>注：<font color='blue'>账号内唯一</b></font>
    Default: sa
  GroupName5Dev:
    Type: String
    Label:
      en: Develop User Group Name
      zh-cn: 开发用户组名称
    Description:
      en: 'Develop group user group, 1 to 64 characters in length, including English
        letters, Numbers, and hyphens (-);<br><b>note: <font color=''blue''>unique
        in account</b></font>'
      zh-cn: 开发组用户组名称, 长度为1~64个字符，可包含英文字母、数字，和连字符（-）；<br><b>注：<font color='blue'>账号内唯一</b></font>
    Default: dev
  GroupName6Test:
    Type: String
    Label:
      en: Test User Group Name
      zh-cn: 测试用户组名称
    Description:
      en: 'Test group user group, 1 to 64 characters in length, including English
        letters, Numbers, and hyphens (-);<br><b>note: <font color=''blue''>unique
        in account</b></font>'
      zh-cn: 测试用户组名称, 长度为1~64个字符，可包含英文字母、数字，和连字符（-）；<br><b>注：<font color='blue'>账号内唯一</b></font>
    Default: test
  GroupName1AppDev:
    Type: String
    Label:
      en: Development Environment User Group Name
      zh-cn: 开发环境程序用户组名称
    Description:
      en: 'Development environment user group name, 1 to 64 characters in length,
        including English letters, Numbers, and hyphens (-);<br><b>note: <font color=''blue''>unique
        in account</b></font>'
      zh-cn: 开发环境程序组用户组, 长度为1~64个字符，可包含英文字母、数字，和连字符（-）；<br><b>注：<font color='blue'>账号内唯一</b></font>
    Default: app-dev
  GroupName2AppProd:
    Type: String
    Label:
      en: Production Environment User Group Name
      zh-cn: 生产环境程序用户组名称
    Description:
      en: 'Production environment user group name, 1 to 64 characters in length, including
        English letters, Numbers, and hyphens (-);<br><b>note: <font color=''blue''>unique
        in account</b></font>'
      zh-cn: 生产环境程序组用户组, 长度为1~64个字符，可包含英文字母、数字，和连字符（-）；<br><font color='blue'><b>注：账号内唯一</b></font>
    Default: app-prod
  GroupName3AppTest:
    Type: String
    Label:
      en: Test Environment User Group Name
      zh-cn: 测试环境程序用户组名称
    Description:
      en: 'Test environment user group name, 1 to 64 characters in length, including
        English letters, Numbers, and hyphens (-);<br><b>note: <font color=''blue''>unique
        in account</b></font>'
      zh-cn: 测试环境程序组用户组, 长度为1~64个字符，可包含英文字母、数字，和连字符（-）；<br><b>注：<font color='blue'>账号内唯一</b></font>
    Default: app-test
  UserName1Dev:
    Type: String
    Label:
      en: Development Permission User Name
      zh-cn: 开发权限用户名
    Description:
      en: 'Development rights user name, 1 to 64 characters in length, including English
        letters, Numbers, and hyphens (-);<br><b>note: <font color=''blue''>unique
        in account</b></font>'
      zh-cn: 开发账号用户名, 长度为1~64个字符，可包含英文字母、数字，和连字符（-）；<br><b>注：<font color='blue'>账号内唯一</b></font>
    ConstraintDescription:
      en: '[1, 64] bits contain a maximum of 64 characters.format：^[a-zA-Z0-9\.@\-_]+$。'
      zh-cn: '[1, 64]位最多包含64个字符。格式：^[a-zA-Z0-9\.@\-_]+$。'
    Default: sts_dev
    MinLength: 1
  UserName2Prod:
    Type: String
    Label:
      en: Production Permission User Name
      zh-cn: 生产权限用户名
    Description:
      en: 'Production permission user name, 1 to 64 characters in length, including
        English letters, Numbers, and hyphens (-);<br><b>note: <font color=''blue''>unique
        in account</b></font>'
      zh-cn: 生产账号用户名, 长度为1~64个字符，可包含英文字母、数字，和连字符（-）；<br><b>注：<font color='blue'>账号内唯一</b></font>
    ConstraintDescription:
      en: '[1, 64] bits contain a maximum of 64 characters.format：^[a-zA-Z0-9\.@\-_]+$。'
      zh-cn: '[1, 64]位最多包含64个字符。格式：^[a-zA-Z0-9\.@\-_]+$。'
    Default: sts_prod
    MinLength: 1
  UserName3Test:
    Type: String
    Label:
      en: Test Permission User Name
      zh-cn: 测试权限用户名
    Description:
      en: 'Test permission user name, 1 to 64 characters in length, including English
        letters, Numbers, and hyphens (-);<br><b>note: <font color=''blue''>unique
        in account</b></font>'
      zh-cn: 测试账号用户名, 长度为1~64个字符，可包含英文字母、数字，和连字符（-）；<br><b>注：<font color='blue'>账号内唯一</b></font>
    ConstraintDescription:
      en: '[1, 64] bits contain a maximum of 64 characters.format：^[a-zA-Z0-9\.@\-_]+$。'
      zh-cn: '[1, 64]位最多包含64个字符。格式：^[a-zA-Z0-9\.@\-_]+$。'
    Default: sts_test
    MinLength: 1
Resources:
  EcsVpc1Dev:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock:
        Ref: VpcCidrBlock1Dev
      ResourceGroupId:
        Ref: ResourceGroupId1Dev
      VpcName:
        Fn::Join:
        - '-'
        - - Dev-StackId
          - Ref: ALIYUN::StackId
  EcsSecurityGroup1Dev:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: EcsVpc1Dev
      SecurityGroupIngress:
      - IpProtocol: icmp
        NicType: internet
        PortRange: -1/-1
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        NicType: internet
        PortRange: 80/80
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        NicType: internet
        PortRange: 443/443
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      SecurityGroupName:
        Fn::Join:
        - '-'
        - - Dev-StackId
          - Ref: ALIYUN::StackId
      Tags:
      - Key: best_practice
        Value: '051'
  EcsVSwitch1Dev:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      ZoneId:
        Ref: VSwitchZoneId
      VpcId:
        Ref: EcsVpc1Dev
      CidrBlock:
        Ref: VSwitchCidrBlockDev
      VSwitchName:
        Fn::Join:
        - '-'
        - - Dev-VSwitch-StackId
          - Ref: ALIYUN::StackId
  RamRole1Dev:
    Type: ALIYUN::RAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action: sts:AssumeRole
          Effect: Allow
          Principal:
            Service:
            - actiontrail.aliyuncs.com
        Version: '1'
      Description: projects-dev读写角色
      RoleName:
        Fn::Join:
        - '-'
        - - projects-dev-rw
          - StackId
          - Ref: ALIYUN::StackId
  RamUser1Dev:
    Type: ALIYUN::RAM::User
    Properties:
      DisplayName: 开发STSToken
      Policies:
      - Description: '扮演role-projects-dev-rw角色权限 '
        PolicyDocument:
          Statement:
          - Action:
            - sts:AssumeRole
            Effect: Allow
            Resource:
            - Fn::GetAtt:
              - RamRole1Dev
              - Arn
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - assume_role-projects-dev-rw
            - StackId
            - Ref: ALIYUN::StackId
      UserName:
        Ref: UserName1Dev
  RamAccessKey1Dev:
    Type: ALIYUN::RAM::AccessKey
    Properties:
      UserName:
        Ref: RamUser1Dev
    DependsOn: RamUser1Dev
  EcsInstance1Dev:
    Type: ALIYUN::ECS::Instance
    Properties:
      VpcId:
        Ref: EcsVpc1Dev
      VSwitchId:
        Ref: EcsVSwitch1Dev
      SecurityGroupId:
        Ref: EcsSecurityGroup1Dev
      ImageId:
        Ref: EcsImageId
      AllocatePublicIP: true
      InstanceChargeType: PostPaid
      InstanceType:
        Ref: EcsInstanceType
      InternetMaxBandwidthOut: 1
      IoOptimized: optimized
      Password:
        Ref: EcsPassword
      ResourceGroupId:
        Ref: ResourceGroupId1Dev
      SystemDiskCategory:
        Ref: EcsSystemDiskCategory
      SystemDiskSize:
        Ref: EcsGroupSystemDiskSize
      Tags:
      - Key: best_practice
        Value: '051'
      UserData:
        Fn::Replace:
        - ros-notify:
            Fn::GetAtt:
            - RosWaitConditionHandle
            - CurlCli
        - Fn::Join:
          - ''
          - - "#!/bin/sh \n"
            - "export hostname=`hostname` \n"
            - "sed -i '/127.0.0.1/d' /etc/hosts \n"
            - "echo \"127.0.0.1       $hostname\" >> /etc/hosts \n"
            - "echo '127.0.0.1       localhost' >> /etc/hosts \n"
            - export access_key_id=
            - Fn::GetAtt:
              - RamAccessKey1Dev
              - AccessKeyId
            - " \n"
            - export access_key_secret=
            - Fn::GetAtt:
              - RamAccessKey1Dev
              - AccessKeySecret
            - " \n"
            - export bucket_name=
            - Ref: BucketName4Code
            - " \n"
            - export endpoint=
            - Fn::Join:
              - ''
              - - http://oss-
                - Ref: ALIYUN::Region
                - -internal.aliyuncs.com
            - " \n"
            - export bucket_dir1=
            - Ref: BucketName4CodeFolderName
            - '

              '
            - export bucket_dir2=
            - Ref: BucketName5CodeFolderName
            - '

              '
            - "wget http://gosspublic.alicdn.com/ossutil/1.6.10/ossutil64 \n"
            - "chmod 755 ossutil64 \n"
            - "./ossutil64 config -k $access_key_secret -i $access_key_id -e $endpoint\
              \ \n"
            - ./ossutil64 mkdir oss://
            - Ref: BucketName4Code
            - "/$bucket_dir1/ \n"
            - "./ossutil64 config -k $access_key_secret -i $access_key_id -e $endpoint\
              \ \n"
            - ./ossutil64 mkdir oss://
            - Ref: BucketName4Code
            - "/$bucket_dir2/ \n"
            - "ros-notify -d \"{\\\"Data\\\" : \\\"Success\\\", \\\"Status\\\" : \\\
              \"Success\\\"}\" \n"
    DependsOn:
    - RamAccessKey1Dev
    - RamUser1Dev
  EcsVpc2Prod:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock:
        Ref: VpcCidrBlock2Prod
      ResourceGroupId:
        Ref: ResourceGroupId2Prod
      VpcName:
        Fn::Join:
        - '-'
        - - Prod-StackId
          - Ref: ALIYUN::StackId
  EcsSecurityGroup2Prod:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: EcsVpc2Prod
      SecurityGroupIngress:
      - IpProtocol: icmp
        NicType: internet
        PortRange: -1/-1
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        NicType: internet
        PortRange: 80/80
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        NicType: internet
        PortRange: 443/443
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      SecurityGroupName:
        Fn::Join:
        - '-'
        - - Prod-StackId
          - Ref: ALIYUN::StackId
      Tags:
      - Key: best_practice
        Value: '051'
  EcsVSwitch2Prod:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      ZoneId:
        Ref: VSwitchZoneId
      VpcId:
        Ref: EcsVpc2Prod
      CidrBlock:
        Ref: VSwitchCidrBlockProd
      VSwitchName:
        Fn::Join:
        - '-'
        - - Prod-VSwitch-StackId
          - Ref: ALIYUN::StackId
  EcsInstance2Prod:
    Type: ALIYUN::ECS::Instance
    Properties:
      VpcId:
        Ref: EcsVpc2Prod
      VSwitchId:
        Ref: EcsVSwitch2Prod
      SecurityGroupId:
        Ref: EcsSecurityGroup2Prod
      ImageId:
        Ref: EcsImageId
      AllocatePublicIP: false
      InstanceChargeType: PostPaid
      InstanceType:
        Ref: EcsInstanceType
      InternetMaxBandwidthOut: 0
      IoOptimized: optimized
      Password:
        Ref: EcsPassword
      ResourceGroupId:
        Ref: ResourceGroupId2Prod
      SystemDiskCategory:
        Ref: EcsSystemDiskCategory
      SystemDiskSize:
        Ref: EcsGroupSystemDiskSize
      Tags:
      - Key: best_practice
        Value: '051'
  EcsVpc3Test:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock:
        Ref: VpcCidrBlock3Test
      ResourceGroupId:
        Ref: ResourceGroupId3Test
      VpcName:
        Fn::Join:
        - '-'
        - - Test-StackId
          - Ref: ALIYUN::StackId
  EcsSecurityGroup3Test:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: EcsVpc3Test
      SecurityGroupIngress:
      - IpProtocol: icmp
        NicType: internet
        PortRange: -1/-1
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        NicType: internet
        PortRange: 80/80
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        NicType: internet
        PortRange: 443/443
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
      SecurityGroupName:
        Fn::Join:
        - '-'
        - - Test-StackId
          - Ref: ALIYUN::StackId
      Tags:
      - Key: best_practice
        Value: '051'
  EcsVSwitch3Test:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      ZoneId:
        Ref: VSwitchZoneId
      VpcId:
        Ref: EcsVpc3Test
      CidrBlock:
        Ref: VSwitchCidrBlockTest
      VSwitchName:
        Fn::Join:
        - '-'
        - - Test-VSwitch-StackId
          - Ref: ALIYUN::StackId
  EcsInstance3Test:
    Type: ALIYUN::ECS::Instance
    Properties:
      VpcId:
        Ref: EcsVpc3Test
      VSwitchId:
        Ref: EcsVSwitch3Test
      SecurityGroupId:
        Ref: EcsSecurityGroup3Test
      ImageId:
        Ref: EcsImageId
      AllocatePublicIP: false
      InstanceChargeType: PostPaid
      InstanceType:
        Ref: EcsInstanceType
      InternetMaxBandwidthOut: 0
      IoOptimized: optimized
      Password:
        Ref: EcsPassword
      ResourceGroupId:
        Ref: ResourceGroupId3Test
      SystemDiskCategory:
        Ref: EcsSystemDiskCategory
      SystemDiskSize:
        Ref: EcsGroupSystemDiskSize
      Tags:
      - Key: best_practice
        Value: '051'
  OssBucket1Dev:
    Type: ALIYUN::OSS::Bucket
    Properties:
      AccessControl:
        Ref: BucketAccessControl
      BucketName:
        Ref: BucketName1Dev
      DeletionForce: true
      StorageClass:
        Ref: BucketStorageClass
      Tags:
        Key: best_practice
        Value: '051'
  OssBucket2Prod:
    Type: ALIYUN::OSS::Bucket
    Properties:
      AccessControl:
        Ref: BucketAccessControl
      BucketName:
        Ref: BucketName2Prod
      DeletionForce: true
      StorageClass:
        Ref: BucketStorageClass
      Tags:
        Key: best_practice
        Value: '051'
  OssBucket3Test:
    Type: ALIYUN::OSS::Bucket
    Properties:
      AccessControl:
        Ref: BucketAccessControl
      BucketName:
        Ref: BucketName3Test
      DeletionForce: true
      StorageClass:
        Ref: BucketStorageClass
      Tags:
        Key: best_practice
        Value: '051'
  OssBucket4Code:
    Type: ALIYUN::OSS::Bucket
    Properties:
      AccessControl:
        Ref: BucketAccessControl
      BucketName:
        Ref: BucketName4Code
      DeletionForce: true
      StorageClass:
        Ref: BucketStorageClass
      Tags:
        Key: best_practice
        Value: '051'
  OssBucket5Other:
    Type: ALIYUN::OSS::Bucket
    Properties:
      AccessControl:
        Ref: BucketAccessControl
      BucketName:
        Ref: BucketName5Other
      DeletionForce: true
      StorageClass:
        Ref: BucketStorageClass
      Tags:
        Key: best_practice
        Value: '051'
    DependsOn:
    - EcsInstance3Test
  RamRole2Prod:
    Type: ALIYUN::RAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action: sts:AssumeRole
          Effect: Allow
          Principal:
            Service:
            - actiontrail.aliyuncs.com
        Version: '1'
      Description: projects-prod读写角色
      RoleName:
        Fn::Join:
        - '-'
        - - projects-prod-rw
          - StackId
          - Ref: ALIYUN::StackId
  RamUser2Prod:
    Type: ALIYUN::RAM::User
    Properties:
      DisplayName: 生产STSToken
      Policies:
      - Description: 扮演role-projects-prod-rw角色权限
        PolicyDocument:
          Statement:
          - Action:
            - sts:AssumeRole
            Effect: Allow
            Resource:
            - Fn::GetAtt:
              - RamRole2Prod
              - Arn
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - assume_role-projects-prod-rw
            - StackId
            - Ref: ALIYUN::StackId
      UserName:
        Ref: UserName2Prod
  RamAccessKey2Prod:
    Type: ALIYUN::RAM::AccessKey
    Properties:
      UserName:
        Ref: RamUser2Prod
    DependsOn: RamUser2Prod
  RamRole3Test:
    Type: ALIYUN::RAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action: sts:AssumeRole
          Effect: Allow
          Principal:
            Service:
            - actiontrail.aliyuncs.com
        Version: '1'
      Description: projects-test读写角色
      RoleName:
        Fn::Join:
        - '-'
        - - projects-test-rw
          - StackId
          - Ref: ALIYUN::StackId
  RamUser3Test:
    Type: ALIYUN::RAM::User
    Properties:
      DisplayName: 测试STSToken
      Policies:
      - Description: 扮演role-projects-test-rw角色权限
        PolicyDocument:
          Statement:
          - Action:
            - sts:AssumeRole
            Effect: Allow
            Resource:
            - Fn::GetAtt:
              - RamRole3Test
              - Arn
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - assume_role-projects-test-rw
            - StackId
            - Ref: ALIYUN::StackId
      UserName:
        Ref: UserName3Test
  RamAccessKey3Test:
    Type: ALIYUN::RAM::AccessKey
    Properties:
      UserName:
        Ref: RamUser3Test
    DependsOn: RamUser3Test
  RamGroup1AppDev:
    Type: ALIYUN::RAM::Group
    Properties:
      Comments: 开发环境程序组
      GroupName:
        Ref: GroupName1AppDev
      Policies:
      - Description: 程序只读访问project-code release目录权限
        PolicyDocument:
          Statement:
          - Action:
            - oss:ListObjects
            Condition:
              StringLike:
                oss:Prefix:
                - ''
                - Fn::Join:
                  - ''
                  - - Ref: BucketName4CodeFolderName
                    - /*
                - Fn::Join:
                  - ''
                  - - Ref: BucketName4CodeFolderName
                    - /
            Effect: Allow
            Resource:
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName4Code
          - Action:
            - oss:Get*
            - oss:List*
            Condition:
              IpAddress:
                acs:SourceIp:
                - Ref: VpcCidrBlock1Dev
                - Ref: VpcCidrBlock2Prod
                - Ref: VpcCidrBlock3Test
            Effect: Allow
            Resource:
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName4Code
                - /
                - Ref: BucketName4CodeFolderName
                - /*
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - oss_projects-code_release_r_app_dev
            - StackId
            - Ref: ALIYUN::StackId
      - Description: 开发环境读写访问bucket projects-dev权限
        PolicyDocument:
          Statement:
          - Action:
            - oss:PutObject
            - oss:GetObject
            Condition:
              IpAddress:
                acs:SourceIp:
                - Ref: VpcCidrBlock1Dev
            Effect: Allow
            Resource:
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName1Dev
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName1Dev
                - /*
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - oss_projects-dev_rw_app
            - StackId
            - Ref: ALIYUN::StackId
  RamGroup2AppProd:
    Type: ALIYUN::RAM::Group
    Properties:
      Comments: 生产环境程序组
      GroupName:
        Ref: GroupName2AppProd
      Policies:
      - Description: 程序只读访问project-code release目录权限
        PolicyDocument:
          Statement:
          - Action:
            - oss:ListObjects
            Condition:
              StringLike:
                oss:Prefix:
                - Fn::Join:
                  - ''
                  - - Ref: BucketName4CodeFolderName
                    - /*
            Effect: Allow
            Resource:
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName4Code
          - Action:
            - oss:Get*
            - oss:List*
            Condition:
              IpAddress:
                acs:SourceIp:
                - Ref: VpcCidrBlock1Dev
                - Ref: VpcCidrBlock2Prod
                - Ref: VpcCidrBlock3Test
            Effect: Allow
            Resource:
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName4Code
                - /
                - Ref: BucketName4CodeFolderName
                - /*
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - oss_projects-code_release_r_app_prod
            - StackId
            - Ref: ALIYUN::StackId
      - Description: '生产环境读写访问bucket projects-prod权限 '
        PolicyDocument:
          Statement:
          - Action:
            - oss:PutObject
            - oss:GetObject
            Condition:
              IpAddress:
                acs:SourceIp:
                - Ref: VpcCidrBlock2Prod
            Effect: Allow
            Resource:
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName2Prod
                - /*
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName2Prod
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - oss_projects-prod_rw_app
            - StackId
            - Ref: ALIYUN::StackId
  RamGroup3AppTest:
    Type: ALIYUN::RAM::Group
    Properties:
      Comments: 测试环境程序组
      GroupName:
        Ref: GroupName3AppTest
      Policies:
      - Description: 程序只读访问project-code release目录权限
        PolicyDocument:
          Statement:
          - Action:
            - oss:ListObjects
            Condition:
              StringLike:
                oss:Prefix:
                  Fn::Join:
                  - ''
                  - - Ref: BucketName4CodeFolderName
                    - /*
            Effect: Allow
            Resource:
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName4Code
          - Action:
            - oss:Get*
            - oss:List*
            Condition:
              IpAddress:
                acs:SourceIp:
                - Ref: VpcCidrBlock1Dev
                - Ref: VpcCidrBlock2Prod
                - Ref: VpcCidrBlock3Test
            Effect: Allow
            Resource:
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName4Code
                - /
                - Ref: BucketName4CodeFolderName
                - /*
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - oss_projects-code_release_r_app_test
            - StackId
            - Ref: ALIYUN::StackId
      - Description: 测试环境读写访问bucket projects-test权限
        PolicyDocument:
          Statement:
          - Action:
            - oss:PutObject
            - oss:GetObject
            Condition:
              IpAddress:
                acs:SourceIp:
                - Ref: VpcCidrBlock3Test
            Effect: Allow
            Resource:
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName3Test
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName3Test
                - /*
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - oss_projects-test_rw_app
            - StackId
            - Ref: ALIYUN::StackId
  RamGroup4Sa:
    Type: ALIYUN::RAM::Group
    Properties:
      Comments: 运维组
      GroupName:
        Ref: GroupName4Sa
      Policies:
      - Description: 管理所有阿里云资源的权限
        PolicyDocument:
          Statement:
          - Action:
            - '*'
            Effect: Allow
            Resource:
            - '*'
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - AdministratorAccess_Sa
            - StackId
            - Ref: ALIYUN::StackId
      - Description: 没有RAM管理权限
        PolicyDocument:
          Statement:
          - Action:
            - ram:*
            Effect: Deny
            Resource:
            - '*'
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - deny_ram_sa
            - StackId
            - Ref: ALIYUN::StackId
  RamGroup5Dev:
    Type: ALIYUN::RAM::Group
    Properties:
      Comments: 开发组
      GroupName:
        Ref: GroupName5Dev
      Policies:
      - Description: 只读访问所有阿里云资源的权限
        PolicyDocument:
          Statement:
          - Action:
            - '*:Describe*'
            - '*:List*'
            - '*:Get*'
            - '*:BatchGet*'
            - '*:Query*'
            - '*:BatchQuery*'
            - actiontrail:LookupEvents
            - dm:Desc*
            - dm:SenderStatistics*
            - ram:GenerateCredentialReport
            Effect: Allow
            Resource:
            - '*'
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - ReadOnlyAccess_Dev
            - StackId
            - Ref: ALIYUN::StackId
      - Description: project-code读写权限
        PolicyDocument:
          Statement:
          - Action:
            - oss:ListBuckets
            - oss:GetBucket*
            Effect: Allow
            Resource:
            - acs:oss:*:*:*
          - Action:
            - oss:*
            Effect: Allow
            Resource:
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName4Code
                - /*
          - Action:
            - oss:ListObjects
            Effect: Allow
            Resource:
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName4Code
                - /*
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - oss_projects-code_release_rw_dev
            - StackId
            - Ref: ALIYUN::StackId
      - Description: projects-dev完全控制权限
        PolicyDocument:
          Statement:
          - Action:
            - oss:ListBuckets
            - oss:GetBucket*
            Effect: Allow
            Resource:
            - acs:oss:*:*:*
          - Action:
            - oss:*
            Effect: Allow
            Resource:
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName1Dev
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName1Dev
                - /*
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - oss_projects-dev_all
            - StackId
            - Ref: ALIYUN::StackId
      - Description: ECS实例重启权限
        PolicyDocument:
          Statement:
          - Action:
            - ecs:RebootInstance
            Effect: Allow
            Resource:
            - '*'
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - ecs_instance_reboot_Dev
            - StackId
            - Ref: ALIYUN::StackId
      - Description: CDN预热及刷新权限
        PolicyDocument:
          Statement:
          - Action:
            - cdn:PushObjectCache
            - cdn:RefreshObjectCaches
            Effect: Allow
            Resource:
            - '*'
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - cdn_push_refresh_cache_Dev
            - StackId
            - Ref: ALIYUN::StackId
  RamGroup6Test:
    Type: ALIYUN::RAM::Group
    Properties:
      Comments: 测试组
      GroupName:
        Ref: GroupName6Test
      Policies:
      - Description: 只读访问所有阿里云资源的权限
        PolicyDocument:
          Statement:
          - Action:
            - '*:Describe*'
            - '*:List*'
            - '*:Get*'
            - '*:BatchGet*'
            - '*:Query*'
            - '*:BatchQuery*'
            - actiontrail:LookupEvents
            - dm:Desc*
            - dm:SenderStatistics*
            - ram:GenerateCredentialReport
            Effect: Allow
            Resource:
            - '*'
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - ReadOnlyAccess_Test
            - StackId
            - Ref: ALIYUN::StackId
      - Description: ECS实例重启权限
        PolicyDocument:
          Statement:
          - Action:
            - ecs:RebootInstance
            Effect: Allow
            Resource:
            - '*'
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - ecs_instance_reboot_Test
            - StackId
            - Ref: ALIYUN::StackId
      - Description: CDN预热及刷新权限
        PolicyDocument:
          Statement:
          - Action:
            - cdn:PushObjectCache
            - cdn:RefreshObjectCaches
            Effect: Allow
            Resource:
            - '*'
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - cdn_push_refresh_cache_Test
            - StackId
            - Ref: ALIYUN::StackId
      - Description: projects-code下release目录只读权限
        PolicyDocument:
          Statement:
          - Action:
            - oss:ListBuckets
            - oss:GetBucket*
            Effect: Allow
            Resource:
            - acs:oss:*:*:*
          - Action:
            - oss:Get*
            - oss:List*
            Effect: Allow
            Resource:
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName4Code
                - /
                - Ref: BucketName4CodeFolderName
                - /*
          - Action:
            - oss:ListObjects
            Condition:
              StringLike:
                oss:Delimiter: /
                oss:Prefix:
                - ''
                - Fn::Join:
                  - ''
                  - - Ref: BucketName4CodeFolderName
                    - /*
                - Fn::Join:
                  - ''
                  - - Ref: BucketName4CodeFolderName
                    - /
            Effect: Allow
            Resource:
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName4Code
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - oss_projects-code_release_r_test
            - StackId
            - Ref: ALIYUN::StackId
      - Description: projects-test完全控制权限
        PolicyDocument:
          Statement:
          - Action:
            - oss:ListBuckets
            - oss:GetBucket*
            Effect: Allow
            Resource:
            - acs:oss:*:*:*
          - Action:
            - oss:*
            Effect: Allow
            Resource:
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName3Test
                - /*
            - Fn::Join:
              - ''
              - - 'acs:oss:*:*:'
                - Ref: BucketName3Test
          Version: '1'
        PolicyName:
          Fn::Join:
          - '-'
          - - oss_projects-test_all
            - StackId
            - Ref: ALIYUN::StackId
  RdsDBInstance:
    Type: ALIYUN::RDS::DBInstance
    Properties:
      VpcId:
        Ref: EcsVpc1Dev
      VSwitchId:
        Ref: EcsVSwitch1Dev
      DBInstanceClass:
        Ref: DBInstanceClass
      DBInstanceNetType: Intranet
      DBInstanceStorage:
        Ref: DBInstanceStorage
      Engine:
        Fn::Select:
        - '0'
        - Fn::Split:
          - '-'
          - Ref: DBInstanceEngineAndVersion
      EngineVersion:
        Fn::Select:
        - '1'
        - Fn::Split:
          - '-'
          - Ref: DBInstanceEngineAndVersion
      PayType: Postpaid
      ResourceGroupId:
        Ref: ResourceGroupId1Dev
      SecurityIPList: 0.0.0.0/0
      Tags:
        key: best_practice
        value: '051'
  RosWaitConditionHandle:
    Type: ALIYUN::ROS::WaitConditionHandle
    Properties: {}
  RosWaitCondition:
    Type: ALIYUN::ROS::WaitCondition
    Properties:
      Count: 1
      Handle:
        Ref: RosWaitConditionHandle
      Timeout: 600
  User1ToGroupDev:
    Type: ALIYUN::RAM::UserToGroupAddition
    Properties:
      GroupName:
        Ref: RamGroup5Dev
      Users:
      - Ref: RamUser1Dev
    DependsOn:
    - RamGroup5Dev
    - RamUser1Dev
  User2ToGroupTest:
    Type: ALIYUN::RAM::UserToGroupAddition
    Properties:
      GroupName:
        Ref: RamGroup4Sa
      Users:
      - Ref: RamUser2Prod
    DependsOn:
    - RamGroup4Sa
    - RamUser2Prod
  User3ToGroupSa:
    Type: ALIYUN::RAM::UserToGroupAddition
    Properties:
      GroupName:
        Ref: RamGroup6Test
      Users:
      - Ref: RamUser3Test
    DependsOn:
    - RamGroup6Test
    - RamUser3Test
Outputs:
  AccessKeyId1Dev:
    Description:
      en: Develop user group user account AK Id.
      zh-cn: 开发用户组用户账号AK Id。
    Value:
      Fn::GetAtt:
      - RamAccessKey1Dev
      - AccessKeyId
  AccessKeyId2Prod:
    Description:
      en: Production user group user account AK Id.
      zh-cn: 生产用户组用户账号AK Id。
    Value:
      Fn::GetAtt:
      - RamAccessKey2Prod
      - AccessKeyId
  AccessKeyId3Test:
    Description:
      en: Test user group user account AK Id.
      zh-cn: 测试用户组用户账号AK Id。
    Value:
      Fn::GetAtt:
      - RamAccessKey3Test
      - AccessKeyId
  AccessKeySecret1Dev:
    Description:
      en: Develop user group user account AK Secret.
      zh-cn: 开发用户组用户账号AK Secret。
    Value:
      Fn::GetAtt:
      - RamAccessKey1Dev
      - AccessKeySecret
  AccessKeySecret2Prod:
    Description:
      en: Production user group user account AK Secret.
      zh-cn: 生产用户组用户账号AK Secret。
    Value:
      Fn::GetAtt:
      - RamAccessKey2Prod
      - AccessKeySecret
  AccessKeySecret3Test:
    Description:
      en: Test user group user account AK Secret.
      zh-cn: 测试用户组用户账号AK Secret。
    Value:
      Fn::GetAtt:
      - RamAccessKey3Test
      - AccessKeySecret
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
    - Parameters:
      - ResourceGroupId1Dev
      - ResourceGroupId2Prod
      - ResourceGroupId3Test
      Label:
        default: RESOURCE
    - Parameters:
      - VpcCidrBlock1Dev
      - VpcCidrBlock2Prod
      - VpcCidrBlock3Test
      - VSwitchZoneId
      - VSwitchCidrBlockDev
      - VSwitchCidrBlockProd
      - VSwitchCidrBlockTest
      Label:
        default: VPC
    - Parameters:
      - EcsInstanceType
      - EcsImageId
      - EcsSystemDiskCategory
      - EcsGroupSystemDiskSize
      - EcsPassword
      Label:
        default: ECS
    - Parameters:
      - DBInstanceEngineAndVersion
      - DBInstanceClass
      - DBInstanceStorage
      Label:
        default: RDS
    - Parameters:
      - BucketAccessControl
      - BucketStorageClass
      - BucketName1Dev
      - BucketName2Prod
      - BucketName3Test
      - BucketName4Code
      - BucketName5Other
      - BucketName4CodeFolderName
      - BucketName5CodeFolderName
      Label:
        default: OSS
    - Parameters:
      - GroupName4Sa
      - GroupName5Dev
      - GroupName6Test
      - GroupName1AppDev
      - GroupName2AppProd
      - GroupName3AppTest
      - UserName1Dev
      - UserName2Prod
      - UserName3Test
      Label:
        default: RAM
    TemplateTags:
    - acs:solution:安全&合规:RAM账号权限管理
  ALIYUN::ROS::Composer:
    8f1bb56b:
      Rect:
        - 1574
        - 889
        - 40
        - 78
        - 1
        - 0
      ResT: Composer::ROSParameter::AlibabaCloud
    9f391e74:
      Parent: 8f1bb56b
      Rect:
        - 1516
        - 806
        - 82
        - 120
        - 2
        - 0
      ResT: Composer::ROSParameter::Region
    c11a24cc:
      Res:
        - OssBucket1Dev
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 192
        - 815
        - 3
        - 0
      Label:
        zh-CN: OSS存储空间1
    6d2e77cc:
      Res:
        - OssBucket2Prod
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 1351
        - 815
        - 3
        - 0
      Label:
        zh-CN: OSS存储空间2
    bd44664c:
      Res:
        - EcsVpc1Dev
      Parent: 9f391e74
      Rect:
        - 440
        - 270
        - 102
        - 166
        - 3
        - 0
      Label:
        zh-CN: 专有网络VPC1
    5c346268:
      Res:
        - RamRole1Dev
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 357
        - 660
        - 3
        - 0
      Label:
        zh-CN: RAM角色1
    7c5351a6:
      Res:
        - RamAccessKey1Dev
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 192
        - 660
        - 3
        - 0
      Label:
        zh-CN: AccessKey1
    e7ca8419:
      Res:
        - EcsVpc2Prod
      Parent: 9f391e74
      Rect:
        - 440
        - 270
        - 562
        - 166
        - 3
        - 0
      Label:
        zh-CN: 专有网络VPC2
    959ab1fc:
      Res:
        - EcsVpc3Test
      Parent: 9f391e74
      Rect:
        - 440
        - 270
        - 1022
        - 166
        - 3
        - 0
      Label:
        zh-CN: 专有网络VPC3
    50351d5e:
      Res:
        - OssBucket3Test
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 357
        - 815
        - 3
        - 0
      Label:
        zh-CN: OSS存储空间3
    a1fd0746:
      Res:
        - OssBucket4Code
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 762
        - 815
        - 3
        - 0
      Label:
        zh-CN: OSS存储空间4
    4972a212:
      Res:
        - OssBucket5Other
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 1179
        - 815
        - 3
        - 0
      Label:
        zh-CN: OSS存储空间5
    526b1f12:
      Res:
        - RamRole2Prod
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 863
        - 676
        - 3
        - 0
      Label:
        zh-CN: RAM角色2
    686b1f0e:
      Res:
        - RamAccessKey2Prod
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 652
        - 676
        - 3
        - 0
      Label:
        zh-CN: AccessKey2
    4519bf93:
      Res:
        - RamRole3Test
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 1351
        - 676
        - 3
        - 0
      Label:
        zh-CN: RAM角色3
    03b52405:
      Res:
        - RamAccessKey3Test
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 1179
        - 676
        - 3
        - 0
      Label:
        zh-CN: AccessKey3
    0d478bf4:
      Res:
        - RosWaitConditionHandle
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 1542
        - 636
        - 3
        - 0
      Hidden: true
    17ff1a97:
      Res:
        - RosWaitCondition
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 1482
        - 636
        - 3
        - 0
      Hidden: true
    ab363751:
      Res:
        - EcsVSwitch2Prod
      Parent: e7ca8419
      Rect:
        - 400
        - 200
        - 582
        - 216
        - 4
        - 0
      Label:
        zh-CN: 交换机2
    74ae6552:
      Res:
        - EcsVSwitch3Test
      Parent: 959ab1fc
      Rect:
        - 400
        - 200
        - 1042
        - 216
        - 4
        - 0
      Label:
        zh-CN: 交换机3
    4d5c981a:
      Res:
        - EcsVSwitch1Dev
      Parent: bd44664c
      Rect:
        - 400
        - 200
        - 122
        - 216
        - 4
        - 0
      Label:
        zh-CN: 交换机1
    af844a49:
      Res:
        - RdsDBInstance
      Parent: 4d5c981a
      Rect:
        - 40
        - 40
        - 427
        - 296
        - 5
        - 0
    0ac8e4aa:
      Parent: 9f391e74
      Edge:
        - 40d4e89a
        - 5c346268
      Line: 0:0:0:gray:0
    624e21cf:
      Parent: 9f391e74
      Edge:
        - 7c5351a6
        - 40d4e89a
      Line: 0:0:0:gray:0
    c673e2fc:
      Parent: 9f391e74
      Edge:
        - 63e6f4e1
        - 7c5351a6
      Line: 0:0:0:gray:0
    613e62a1:
      Parent: 9f391e74
      Edge:
        - e3ff4f9a
        - 526b1f12
      Line: 0:0:0:gray:0
    f3c2023f:
      Parent: 9f391e74
      Edge:
        - 686b1f0e
        - e3ff4f9a
      Line: 0:0:0:gray:0
    84d402b8:
      Parent: 9f391e74
      Edge:
        - ee938faa
        - 4519bf93
      Line: 0:0:0:gray:0
    b6efcbd5:
      Parent: 9f391e74
      Edge:
        - 03b52405
        - ee938faa
      Line: 0:0:0:gray:0
    a482136a:
      Edge:
        - 17ff1a97
        - 0d478bf4
      Line: 0:0:0:gray:0
    d59b965f:
      Res:
        - RamGroup5Dev
      Rect:
        - 138
        - 106
        - 235
        - 453
        - 37
        - 0
      Label:
        zh-CN: RAM用户组1
    8a4c8b1b:
      Res:
        - RamGroup1AppDev
      Rect:
        - 162
        - 109
        - 701
        - 453
        - 37
        - 0
      Label:
        zh-CN: RAM用户组2
    d8dd8e41:
      Res:
        - RamGroup4Sa
      Rect:
        - 147
        - 117
        - 1204
        - 447
        - 37
        - 0
      Label:
        zh-CN: RAM用户组3
    c0ba7660:
      Res:
        - RamGroup3AppTest
      Rect:
        - 40
        - 40
        - 1150
        - 822
        - 37
        - 0
      Hidden: true
    000fc5e8:
      Res:
        - RamGroup2AppProd
      Rect:
        - 40
        - 40
        - 1066
        - 782
        - 37
        - 0
      Hidden: true
    5d0a0abb:
      Res:
        - RamGroup6Test
      Rect:
        - 40
        - 40
        - 1006
        - 691
        - 37
        - 0
      Hidden: true
    b9adb8ed:
      Res:
        - EcsSecurityGroup1Dev
      Parent: bd44664c
      Rect:
        - 152
        - 115
        - 145
        - 261
        - 37
        - 0
      Label:
        zh-CN: 安全组1
    a7e6943d:
      Res:
        - EcsSecurityGroup3Test
      Parent: 959ab1fc
      Rect:
        - 165
        - 111
        - 1144
        - 266
        - 37
        - 0
      Label:
        zh-CN: 安全组3
    '540e7015':
      Res:
        - EcsSecurityGroup2Prod
      Parent: e7ca8419
      Rect:
        - 177
        - 107
        - 692
        - 274
        - 37
        - 0
      Label:
        zh-CN: 安全组2
    e3ff4f9a:
      Res:
        - RamUser2Prod
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 762
        - 486
        - 38
        - 0
      Layer:
        - 8a4c8b1b
      Label:
        zh-CN: RAM用户2
    63e6f4e1:
      Res:
        - EcsInstance1Dev
      Parent: 4d5c981a
      Rect:
        - 40
        - 40
        - 192
        - 299
        - 38
        - 0
      Layer:
        - b9adb8ed
      Label:
        zh-CN: 云服务器实例1
    40d4e89a:
      Res:
        - RamUser1Dev
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 284
        - 486
        - 38
        - 0
      Layer:
        - d59b965f
      Label:
        zh-CN: RAM用户1
    ee938faa:
      Res:
        - RamUser3Test
      Parent: 9f391e74
      Rect:
        - 40
        - 40
        - 1262
        - 486
        - 38
        - 0
      Layer:
        - d8dd8e41
      Label:
        zh-CN: RAM用户3
    665352b4:
      Res:
        - EcsInstance3Test
      Parent: 74ae6552
      Rect:
        - 40
        - 40
        - 1206
        - 296
        - 38
        - 0
      Layer:
        - a7e6943d
      Label:
        zh-CN: 云服务器实例3
    3c7c198b:
      Res:
        - EcsInstance2Prod
      Parent: ab363751
      Rect:
        - 40
        - 40
        - 762
        - 296
        - 38
        - 0
      Layer:
        - '540e7015'
      Label:
        zh-CN: 云服务器实例2
