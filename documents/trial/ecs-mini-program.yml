ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 该模板用于配置ECS实例，包括分配RAM角色、安全组规则、安装Python、uWSGI服务器和Nginx，以支持支付宝小程序后端服务，通过公网访问实例信息。
  en: This template is designed for configuring ECS instances, encompassing the allocation
    of RAM roles, setup of security group rules, installation of Python, uWSGI server,
    and Nginx, to facilitate backend services for Alipay Mini Programs, with public
    network access enabled for instance information retrieval.
Parameters:
  InstanceId:
    Type: String
    Label:
      en: ECS Instance ID
      zh-cn: ECS实例ID
    AssociationProperty: ALIYUN::ECS::Instance::InstanceId
  EcsRamRoleName:
    Type: String
    Label:
      en: RAM Role Name
      zh-cn: RAM角色名称
    Description:
      en: English letters, numbers, or "-" are allowed. The number of characters should
        be less than or equal to 64.
      zh-cn: 允许英文字母、数字或 “-”。字符数应小于等于 64 个。
    Default: EcsRoleForMiniProgramServer
    AllowedPattern: ^[a-zA-Z0-9-]{1,64}$
Resources:
  DS_Instances:
    Type: DATASOURCE::ECS::Instances
    Properties:
      InstanceIds:
      - Ref: InstanceId
  WaitConditionHandle:
    Type: ALIYUN::ROS::WaitConditionHandle
    Properties: {}
  WaitCondition:
    Type: ALIYUN::ROS::WaitCondition
    Properties:
      Handle:
        Ref: WaitConditionHandle
      Timeout: 3720
      Count: 1
  EcsRamRole:
    Type: ALIYUN::RAM::Role
    Properties:
      RoleName:
        Ref: EcsRamRoleName
      Description: 搭建支付宝小程序ECS实例角色
      AssumeRolePolicyDocument:
        Version: '1'
        Statement:
        - Action: sts:AssumeRole
          Effect: Allow
          Principal:
            Service:
            - ecs.aliyuncs.com
      Policies:
      - PolicyName:
          Fn::Sub:
          - ${RamRoleName}Policy
          - RamRoleName:
              Ref: EcsRamRoleName
        Description: 搭建支付宝小程序ECS实例角色权限策略
        PolicyDocument:
          Version: '1'
          Statement:
          - Action:
            - ecs:DescribeInstances
            - ecs:DescribeInstanceStatus
            Effect: Allow
            Resource:
            - '*'
  EcsRamRoleAttachment:
    Type: ALIYUN::ECS::RamRoleAttachment
    Properties:
      InstanceIds:
      - Ref: InstanceId
      RamRoleName:
        Ref: EcsRamRoleName
    DependsOn: EcsRamRole
  SecurityGroupIngress_80:
    Type: ALIYUN::ECS::SecurityGroupIngress
    Properties:
      SecurityGroupId:
        Fn::Jq:
        - First
        - .[0].SecurityGroupIds[0]
        - Fn::GetAtt:
          - DS_Instances
          - Instances
      SourceCidrIp: 0.0.0.0/0
      IpProtocol: tcp
      NicType: intranet
      PortRange: 80/80
  InstallWebServer:
    Type: ALIYUN::ECS::RunCommand
    Properties:
      InstanceIds:
      - Ref: InstanceId
      Type: RunShellScript
      Sync: true
      Timeout: 3600
      CommandContent:
        Fn::Sub: "#!/bin/bash\n\nif [ ! -f .ros.provision ]; then\n  echo \"Name:\
          \ 搭建支付宝小程序\" > .ros.provision\nfi\n\nname=$(grep \"^Name:\" .ros.provision\
          \ | awk -F':' '{print $2}' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')\n\
          \n\nif [[ \"$name\" != \"搭建支付宝小程序\" ]]; then\n  echo \"当前实例已使用过\\\"$name\\\
          \"教程的一键配置，不能再使用本教程的一键配置\"\n  ${WaitConditionHandle.CurlCli} --data-binary\
          \ \"{\\\"status\\\": \\\"FAILURE\\\", \\\"reason\\\": \\\"The current instance\
          \ has already applied the configuration of the \\\\\\\"$name\\\\\\\" tutorial,\
          \ and the configuration of this tutorial can no longer be applied.\\\"}\"\
          \n  exit 0\nfi\n\n\nif ! grep -q \"^Step1: Install Python$\" .ros.provision;\
          \ then\n  echo \"#########################\"\n  echo \"# Install Python\"\
          \n  echo \"#########################\"\n  mkdir /data && touch /data/GetServerInfo.py\n\
          \  cat > /data/GetServerInfo.py << EOF\n# -*- coding: utf-8 -*-\nfrom flask\
          \ import Flask, jsonify, request\nfrom aliyunsdkcore.client import AcsClient\n\
          from aliyunsdkcore.auth import credentials\nimport requests\nimport json\n\
          from aliyunsdkecs.request.v20140526 import DescribeInstancesRequest, DescribeInstanceStatusRequest\n\
          \napp = Flask(__name__)\n\nmetaUrl = 'http://100.100.100.200/latest/meta-data/ram/security-credentials/${EcsRamRoleName}'\n\
          \nregion = '${ALIYUN::Region}'\n\n# 获取临时身份凭证 Get STS Token.\n\ndef getStsToken():\n\
          \  tokenResponse = requests.get(metaUrl)\n  return tokenResponse.json()\n\
          \n# 在app.route装饰器中声明响应的URL和请求方法 Declare the URL and request method of the\
          \ response in the app.route decorator.\n\n@app.route('/ecs/getServerInfo',\
          \ methods=['GET'])\ndef getServerInfo():\n    tokenResult = getStsToken()\n\
          \    accessKeyId = tokenResult['AccessKeyId']\n    accessSecret = tokenResult['AccessKeySecret']\n\
          \    securityToken = tokenResult['SecurityToken']\n    credential = credentials.StsTokenCredential(accessKeyId,\
          \ accessSecret, securityToken)\n    client = AcsClient(credential=credential,\
          \ region_id=region)\n\n    # GET方式获取请求参数 Get request parameters.\n    instanceId\
          \ = request.args.get(\"instanceId\")\n    if instanceId is None:    \n \
          \       return \"Invalid Parameter\"\n    # 查询实例信息 Query instance information.\n\
          \    describeInstancesRequest = DescribeInstancesRequest.DescribeInstancesRequest()\n\
          \    describeInstancesRequest.set_InstanceIds([instanceId])\n    describeInstancesResponse\
          \ = client.do_action_with_exception(describeInstancesRequest)\n    # 返回数据为bytes类型，需要将bytes类型转换为str然后反序列化为json对象\
          \ The returned data is of type bytes, which needs to be converted to str\
          \ and then deserialized into a json object.\n    describeInstancesResponse\
          \ = json.loads(str(describeInstancesResponse, 'utf-8'))\n    print(describeInstancesResponse)\n\
          \    if len(describeInstancesResponse['Instances']['Instance']) == 0:\n\
          \        return jsonify({})\n\n    instanceInfo = describeInstancesResponse['Instances']['Instance'][0]\n\
          \n    # 查询实例状态 Query instance status.\n    describeInstanceStatusRequest\
          \ = DescribeInstanceStatusRequest.DescribeInstanceStatusRequest()\n    describeInstanceStatusRequest.set_InstanceIds([instanceId])\n\
          \    describeInstanceStatusResponse = client.do_action_with_exception(describeInstanceStatusRequest)\n\
          \    describeInstanceStatusResponse = json.loads(str(describeInstanceStatusResponse,\
          \ 'utf-8'))\n    instanceStatus = describeInstanceStatusResponse['InstanceStatuses']['InstanceStatus'][0]['Status']\n\
          \n    # 封装结果 result\n    result = {\n        # cpu数\n        'Cpu': instanceInfo['Cpu'],\n\
          \        # 内存大小 \n        'Memory': instanceInfo['Memory'],\n        # 操作系统名称\n\
          \        'OSName': instanceInfo['OSName'],\n        # 实例规格\n        'InstanceType':\
          \ instanceInfo['InstanceType'],\n        # 实例公网IP地址\n        'IpAddress':\
          \ instanceInfo['PublicIpAddress']['IpAddress'][0],\n        # 公网出带宽最大值\n\
          \        'InternetMaxBandwidthOut': instanceInfo['InternetMaxBandwidthOut'],\n\
          \        # 实例状态\n        'instanceStatus': instanceStatus\n    }\n    return\
          \ jsonify(result)\n\n\nif __name__ == \"__main__\":\n      app.run()\nEOF\n\
          \  touch /data/requirements.txt\n  cat > /data/requirements.txt << EOF\n\
          aliyun_python_sdk_core==2.13.36\naliyun_python_sdk_ecs==4.24.62\nFlask==2.0.3\n\
          \nEOF\n  pip3 install -r /data/requirements.txt\n  echo \"Step1: Install\
          \ Python\" >> .ros.provision\nelse\n  echo \"#########################\"\
          \n  echo \"# Python has been installed\"\n  echo \"#########################\"\
          \nfi\n\n\nif ! grep -q \"^Step2: Install uWSGI Server$\" .ros.provision;\
          \ then\n  echo \"#########################\"\n  echo \"# Install uWSGI Server\"\
          \n  echo \"#########################\"\n  pip3 install uwsgi\n  touch /data/uwsgi.ini\n\
          \  cat > /data/uwsgi.ini << EOF\n[uwsgi]\n\n#uwsgi启动时所使用的地址和端口 The address\
          \ and port used when uwsgi starts.\n\nsocket=127.0.0.1:5000\n\n#指向网站目录 site\
          \ directory.\n\nchdir=/data\n\n\n#python启动程序文件 python start file.\n\nwsgi-file=GetServerInfo.py\n\
          \n#python程序内用以启动的application变量名 The application variable name used to start\
          \ in the python program.\n\ncallable=app\n\n\n#处理器数 Processors.\n\nprocesses=1\n\
          \n\n#线程数 Threads.\n\nthreads=2\n\n\n#状态检测地址 status detection address.\n\n\
          stats=127.0.0.1:9191\n\n\n#保存启动之后主进程的pid Save the pid file of the main process\
          \ after startup.\n\npidfile=/data/uwsgi.pid\n\n\n#设置uwsgi后台运行，uwsgi.log保存日志信息\
          \ 自动生成 save log info file.\n\ndaemonize=/data/uwsgi.log\n\nEOF\n  uwsgi\
          \ /data/uwsgi.ini\n  echo \"Step2: Install uWSGI Server\" >> .ros.provision\n\
          else\n  echo \"#########################\"\n  echo \"# uWSGI Server has\
          \ been installed\"\n  echo \"#########################\"\nfi\n\nif ! grep\
          \ -q \"^Step3: Install Nginx$\" .ros.provision; then\n  echo \"#########################\"\
          \n  echo \"# Install Nginx\"\n  echo \"#########################\"\n  yum\
          \ install -y nginx\n  touch /etc/nginx/conf.d/app.conf\n  cat > /etc/nginx/conf.d/app.conf\
          \ << EOF\nserver {\n    listen 80 default_server;\n    \n    server_name\
          \ app.example.com;\n\n    root /var/www/html;\n\n    # Add index.php to\
          \ the list if you are using PHP\n    index index.html index.htm index.nginx-debian.html;\n\
          \n    location / {\n        # 转发端口 forwarding address.\n        uwsgi_pass\
          \  127.0.0.1:5000;\n        include uwsgi_params;\n    }\n}\n\nEOF\n  systemctl\
          \ start nginx\n  echo \"Step3: Install Nginx\" >> .ros.provision\nelse\n\
          \  echo \"#########################\"\n  echo \"# Nginx has been installed\"\
          \n  echo \"#########################\"\nfi\n\n\n${WaitConditionHandle.CurlCli}\
          \ --data-binary '{\"status\": \"SUCCESS\"}'"
    DependsOn:
    - EcsRamRoleAttachment
    - SecurityGroupIngress_80
Outputs:
  WebUrl:
    Description:
      en: Get Instance Info.
      zh-cn: 获取实例信息。
    Value:
      Fn::Sub:
      - http://${IP}/ecs/getServerInfo?instanceId=${InstanceId}
      - IP:
          Fn::Jq:
          - First
          - if .[0].PublicIpAddress != [] then .[0].PublicIpAddress[0] else .[0].EipAddress.IpAddress
            end
          - Fn::GetAtt:
            - DS_Instances
            - Instances
        InstanceId:
          Fn::Jq:
          - First
          - .[0].InstanceId
          - Fn::GetAtt:
            - DS_Instances
            - Instances
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
    - Parameters:
      - InstanceId
      - EcsRamRoleName
    TemplateTags:
    - acs:document:试用教程:搭建支付宝小程序
