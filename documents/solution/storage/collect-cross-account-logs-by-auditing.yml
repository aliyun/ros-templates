ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 跨账号OSS日志采集方案，支持企业与个人认证模式，自动化配置日志审计服务与权限策略。
  en: Cross-account OSS Log Collection Solution, supporting both enterprise and individual
    authentication modes, automates the configuration of log audit services and permission
    policies.
Conditions:
  ResourceManagementMode:
    Fn::Equals:
    - Resource Management
    - Ref: AuthenticationMode
  UserDefinedMode:
    Fn::Equals:
    - User-defined
    - Ref: AuthenticationMode
Parameters:
  AuthenticationMode:
    Type: String
    Label:
      en: Authentication mode
      zh-cn: 鉴权模式
    Description:
      en: Only enterprise accounts can be used for resource management. For individual
        accounts, please select user-defined authentication mode.
      zh-cn: 仅支持企业账号开通资源管理（Resource Management），个人账号请通过自定义鉴权模式（User-defined）完成多账号配置。
    Default: Resource Management
    AllowedValues:
    - Resource Management
    - User-defined
  DisplayNameSLS:
    Type: String
    Label:
      en: Name of SLS log audit
      zh-cn: 日志审计服务名称
    Description:
      en: 'Name of SLS log audit. <br>

        Contains a maximum of 128 characters.'
      zh-cn: 'SLS日志审计服务的名称。<br>

        长度不超过128个字符。'
    Default: test-log-audit
    MaxLength: 128
  DisplayNameMember:
    Type: String
    Label:
      en: The name of resource management account
      zh-cn: 资源管理账号名称
    Description:
      en: 'The display name of the member. <br>

        The name must be 2 to 50 characters in length. The name can contain letters,
        digits, underscores (_), periods (.), hyphens (-), and spaces. The name must
        be unique in the resource directory.'
      zh-cn: '成员显示名称。<br>

        长度范围：2~50个字符或汉字。格式：允许输入汉字、英文字母、数字、下划线（_）、半角句号（.）、短划线（-）和空格。成员显示名称在资源目录内必须唯一。'
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
          - ${AuthenticationMode}
          - Resource Management
    Default: test-log-audit
  AccessKey:
    Type: String
    Label: AccessKey ID
    Description:
      en: Identify a user.
      zh-cn: 用于标识用户。
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
          - ${AuthenticationMode}
          - User-defined
    Default: null
  SecretKey:
    Type: String
    Label: AccessKey Secret
    Description:
      en: The key to verify the user.
      zh-cn: 用于验证用户的密钥。
    AssociationProperty: Password
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
          - ${AuthenticationMode}
          - User-defined
    Default: null
Resources:
  ResourceManagerAccount:
    Type: ALIYUN::ResourceManager::Account
    Condition: ResourceManagementMode
    Properties:
      DisplayName:
        Ref: DisplayNameMember
  DealLogAuditStack:
    Type: ALIYUN::ROS::Stack
    Condition: ResourceManagementMode
    Properties:
      Parameters:
        aliuid:
          Ref: ALIYUN::TenantId
        display_name:
          Ref: DisplayNameSLS
        multi_account:
        - Fn::GetAtt:
          - ResourceManagerAccount
          - AccountId
      TemplateBody:
        ROSTemplateFormatVersion: '2015-09-01'
        Transform: Aliyun::Terraform-v1.2
        Workspace:
          main.tf: "variable \"aliuid\" {\n  type = string\n}\n\nvariable \"display_name\"\
            \ {\n  type = string\n}\n\nvariable \"multi_account\" {\n  type = list(string)\n\
            }\n\nresource \"alicloud_log_audit\" \"default\" {\n  display_name = var.display_name\n\
            \  aliuid       = var.aliuid\n  variable_map = {\n    \"oss_access_enabled\"\
            \  = \"true\", \n    \"oss_access_ttl\"      = \"180\",\n  }\n  multi_account\
            \ = var.multi_account\n  resource_directory_type = \"custom\"\n}"
    DependsOn:
    - ResourceManagerAccount
  DealAccountPermissionPolicyStack:
    Type: ALIYUN::ROS::Stack
    Condition: UserDefinedMode
    Properties:
      Parameters:
        aliuid:
          Ref: ALIYUN::TenantId
        access_key:
          Ref: AccessKey
        secret_key:
          Ref: SecretKey
        region:
          Ref: ALIYUN::Region
      TemplateBody:
        ROSTemplateFormatVersion: '2015-09-01'
        Transform: Aliyun::Terraform-v1.2
        Workspace:
          main.tf: "variable \"aliuid\" {\n  type = string\n}\n\nvariable \"access_key\"\
            \ {\n  type = string\n}\n\nvariable \"secret_key\" {\n  type = string\n\
            }\n\nvariable \"region\" {\n  type = string\n}\n\nprovider \"alicloud\"\
            \ {\n  access_key = \"${var.access_key}\"\n  secret_key = \"${var.secret_key}\"\
            \n  region     = \"${var.region}\"\n}\n\nresource \"alicloud_ram_policy\"\
            \ \"policy\" {\n  policy_name     = \"AliyunLogAuditServiceMonitorAccess\"\
            \n  policy_document = <<EOF\n  {\n      \"Version\": \"1\",\n      \"\
            Statement\": [\n          {\n              \"Action\": \"log:*\",\n  \
            \            \"Resource\": [\n                  \"acs:log:*:*:project/slsaudit-*\"\
            ,\n                  \"acs:log:*:*:app/audit\"\n              ],\n   \
            \           \"Effect\": \"Allow\"\n          },\n          {\n       \
            \       \"Action\": [\n                  \"rds:ModifySQLCollectorPolicy\"\
            ,\n                  \"vpc:*FlowLog*\",\n                  \"drds:*SqlAudit*\"\
            ,\n                  \"kvstore:ModifyAuditLogConfig\",\n             \
            \     \"polardb:ModifyDBClusterAuditLogCollector\",\n                \
            \  \"config:UpdateIntegratedServiceStatus\",\n                  \"config:StartConfigurationRecorder\"\
            ,\n                  \"config:PutConfigurationRecorder\"\n           \
            \   ],\n              \"Resource\": \"*\",\n              \"Effect\":\
            \ \"Allow\"\n          },\n          {\n              \"Action\": \"ram:CreateServiceLinkedRole\"\
            ,\n              \"Resource\": \"*\",\n              \"Effect\": \"Allow\"\
            ,\n              \"Condition\": {\n                  \"StringEquals\"\
            : {\n                      \"ram:ServiceName\": [\n                  \
            \        \"config.aliyuncs.com\"\n                      ]\n          \
            \        }\n              }\n          }\n      ]\n  }\n  EOF\n}\n\nresource\
            \ \"alicloud_ram_role\" \"role\" {\n  name        = \"sls-audit-service-monitor\"\
            \n  document    = <<EOF\n  {\n      \"Statement\": [\n          {\n  \
            \            \"Action\": \"sts:AssumeRole\",\n              \"Effect\"\
            : \"Allow\",\n              \"Principal\": {\n                  \"Service\"\
            : [\n                      \"${var.aliuid}@log.aliyuncs.com\",\n     \
            \                 \"log.aliyuncs.com\"\n                  ]\n        \
            \      }\n          }\n      ],\n      \"Version\": \"1\"\n  }\n  EOF\n\
            }\n\nresource \"alicloud_ram_role_policy_attachment\" \"attach\" {\n \
            \ policy_name = alicloud_ram_policy.policy.policy_name\n  policy_type\
            \ = \"Custom\"\n  role_name   = alicloud_ram_role.role.name\n}\n\nresource\
            \ \"alicloud_ram_role_policy_attachment\" \"system_attach\" {\n  policy_name\
            \ = \"ReadOnlyAccess\"\n  policy_type = \"System\"\n  role_name   = alicloud_ram_role.role.name\n\
            }\n\ndata \"alicloud_account\" \"current\" {\n}\n\noutput \"current_account_id\"\
            \ {\n  value = \"${data.alicloud_account.current.id}\"\n}"
  DealUserDefinedLogAuditStack:
    Type: ALIYUN::ROS::Stack
    Condition: UserDefinedMode
    Properties:
      Parameters:
        aliuid:
          Ref: ALIYUN::TenantId
        display_name:
          Ref: DisplayNameSLS
        multi_account:
        - Fn::GetAtt:
          - DealAccountPermissionPolicyStack
          - Outputs.current_account_id
      TemplateBody:
        ROSTemplateFormatVersion: '2015-09-01'
        Transform: Aliyun::Terraform-v1.2
        Workspace:
          main.tf: "variable \"aliuid\" {\n  type = string\n}\n\nvariable \"display_name\"\
            \ {\n  type = string\n}\n\nvariable \"multi_account\" {\n  type = list(string)\n\
            }\n\nresource \"alicloud_log_audit\" \"default\" {\n  display_name = var.display_name\n\
            \  aliuid       = var.aliuid\n  variable_map = {\n    \"oss_access_enabled\"\
            \  = \"true\", \n    \"oss_access_ttl\"      = \"180\",\n  }\n  multi_account\
            \ = var.multi_account\n}"
    DependsOn:
    - DealAccountPermissionPolicyStack
