ROSTemplateFormatVersion: '2015-09-01'
Transform: Aliyun::Terraform-v1.5
Parameters:
  common_name:
    Type: String
    Default: BaiLian
    Label:
      en: Common Name
      zh-cn: 通用名称前缀
    Description:
      en: Common name prefix for resources
      zh-cn: 资源的通用名称前缀
  bailian_api_key:
    Type: String
    NoEcho: true
    Label:
      en: API-KEY
      zh-cn: API-KEY
    Description:
      zh-cn: 开通百炼模型服务，并获得 API-KEY，请参考： <a href="https://help.aliyun.com/zh/model-studio/developer-reference/get-api-key"  target="_blank">获取 API-KEY</a>。
      en: 'Activate BaiLian and obtain the API-KEY. Please refer to:  <a href="https://help.aliyun.com/zh/model-studio/developer-reference/get-api-key"  target="_blank">Get API-KEY</a>.'
  zone_id:
    Type: String
    AssociationProperty: ALIYUN::ECS::Instance::ZoneId
    Label:
      en: Availability Zone
      zh-cn: 可用区
    Description:
      zh-cn: 可用区ID。<br><b>注： <font color='blue'>选择可用区前请确认该可用区是否支持创建ECS资源的规格</font></b>
      en: Availability Zone ID,<br><b>note： <font color='blue'>Before selecting, please confirm that the Availability Zone supports the specification of creating ECS resources</font></b>
  instance_type:
    Type: String
    Label:
      en: Instance Type
      zh-cn: 实例规格
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      InstanceChargeType: PostPaid
      SystemDiskCategory: cloud_essd
    Default: ecs.e-c1m2.large
  instance_password:
    NoEcho: true
    Type: String
    Description:
      en: Server login password, Length 8-30, must contain three(Capital letters, lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in)
      zh-cn: 服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）
    Label:
      en: Instance Password
      zh-cn: 实例密码
    ConstraintDescription:
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in)
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）
    AssociationProperty: ALIYUN::ECS::Instance::Password
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
      - Parameters:
          - zone_id
        Label:
          default:
            en: Network Configuration
            zh-cn: 网络基础配置
      - Parameters:
          - instance_type
          - instance_password
        Label:
          default:
            en: ECS Configuration
            zh-cn: ECS配置
      - Parameters:
          - bailian_api_key
        Label:
          default:
            en: API-KEY
            zh-cn: API-KEY配置
      - Parameters:
          - common_name
        Label:
          default:
            en: Common Configuration
            zh-cn: 通用配置
    TemplateTags:
      - acs:technical-solution:ai:10分钟通过阿里云百炼平台搭建AI应用-tech_solu_235
Workspace:
  variable.tf: |-
    variable "common_name" {
      type        = string
      default     = "BaiLian"
      description = "Common name prefix for resources"
    }

    variable "bailian_api_key" {
      type        = string
      description = <<EOT
      {
        "Label": {
          "en": "API-KEY",
          "zh-cn": "API-KEY"
        },
        "Description": {
          "zh-cn": "开通百炼模型服务，并获得 API-KEY，请参考： <a href=\"https://help.aliyun.com/zh/model-studio/developer-reference/get-api-key\"  target=\"_blank\">获取 API-KEY</a>。",
          "en": "Activate BaiLian and obtain the API-KEY. Please refer to:  <a href=\"https://help.aliyun.com/zh/model-studio/developer-reference/get-api-key\"  target=\"_blank\">Get API-KEY</a>."
        }
      }
      EOT
    }

    variable "zone_id" {
      type        = string
      description = <<EOT
      {
        "Label": {
          "en": "Availability Zone",
          "zh-cn": "可用区"
        },
        "AssociationProperty": "ALIYUN::ECS::Instance::ZoneId"
      }
      EOT
    }

    variable "instance_type" {
      type        = string
      default     = "ecs.e-c1m2.large"
      description = <<EOT
      {
        "Label": {
          "en": "Instance Type",
          "zh-cn": "实例规格"
        },
        "AssociationProperty": "ALIYUN::ECS::Instance::InstanceType",
        "AssociationPropertyMetadata": {
          "InstanceChargeType": "PostPaid",
          "SystemDiskCategory": "cloud_essd"
        }
      }
      EOT
    }

    variable "instance_password" {
      type        = string
      sensitive   = true
      default     = null
      description = <<EOT
      {
        "Label": {
          "en": "Instance Password",
          "zh-cn": "实例密码"
        },
        "Description": {
          "en": "Server login password, Length 8-30, must contain three(Capital letters, lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in)",
          "zh-cn": "服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）"
        },
        "ConstraintDescription": {
          "en": "Length 8-30, must contain three(Capital letters, lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in)",
          "zh-cn": "长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）"
        },
        "AssociationProperty": "ALIYUN::ECS::Instance::Password"
      }
      EOT
    }
  main.tf: |-
    provider "alicloud" {
      // Provider configuration will be inherited from environment variables or provider block
    }

    // VPC Resource
    resource "alicloud_vpc" "vpc" {
      cidr_block = "192.168.0.0/16"
      vpc_name   = "${var.common_name}-VPC"
    }

    // VSwitch Resource
    resource "alicloud_vswitch" "vswitch" {
      vpc_id     = alicloud_vpc.vpc.id
      cidr_block = "192.168.0.0/24"
      zone_id    = var.zone_id
      vswitch_name = "${var.common_name}-vsw_001"
    }

    // Security Group Resource
    resource "alicloud_security_group" "security_group" {
      vpc_id              = alicloud_vpc.vpc.id
      security_group_name = "${var.common_name}-SecurityGroup_1"
    }

    // Security Group Rule for HTTP access
    resource "alicloud_security_group_rule" "allow_http" {
      type              = "ingress"
      ip_protocol       = "tcp"
      nic_type          = "intranet"
      policy            = "accept"
      port_range        = "80/80"
      priority          = 1
      security_group_id = alicloud_security_group.security_group.id
      cidr_ip           = "0.0.0.0/0"
    }

    // ECS Instance Resource
    resource "alicloud_instance" "ecs_instance" {
      vpc_id                      = alicloud_vpc.vpc.id
      vswitch_id                  = alicloud_vswitch.vswitch.id
      security_groups             = [alicloud_security_group.security_group.id]
      image_id                    = "aliyun_3_9_x64_20G_alibase_20231219.vhd"
      instance_type               = var.instance_type
      system_disk_category        = "cloud_essd"
      system_disk_size            = 40
      internet_max_bandwidth_out  = 5
      password                    = var.instance_password
    }

    // Run Command on ECS Instance
    resource "alicloud_ecs_command" "run_script" {
      name           = "setup-bailian-app"
      command_content = base64encode(<<SCRIPT
    #!/bin/bash
    cat << "PROFILE_EOF" >> ~/.bash_profile
    export BAILIAN_API_KEY=${var.bailian_api_key}
    export ROS_DEPLOY=true
    PROFILE_EOF

    source ~/.bash_profile

    curl -fsSL https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/install-script/create-ai-app-via-bailian/install.sh | bash
    SCRIPT
      )
      working_dir = "/root"
      type        = "RunShellScript"
      timeout     = 3600
    }

    resource "alicloud_ecs_invocation" "run_command" {
      instance_id = [alicloud_instance.ecs_instance.id]
      command_id  = alicloud_ecs_command.run_script.id
      timeouts {
        create = "15m"
      }
    }
  output.tf: |-
    output "web_url" {
      description = <<EOT
      {
        "zh-cn": "Web 访问地址。",
        "en": "The Addresses of Web."
      }
      EOT
      value = "http://${alicloud_instance.ecs_instance.public_ip}"
    }

    output "ecs_login_address" {
      description = <<EOT
      {
        "zh-cn": "ECS登录地址。",
        "en": "Ecs login address."
      }
      EOT
      value = "https://ecs-workbench.aliyun.com/?from=EcsConsole&instanceType=ecs&regionId=${data.alicloud_regions.current.regions.0.id}&instanceId=${alicloud_instance.ecs_instance.id}"
    }

    // Data source to get current region
    data "alicloud_regions" "current" {
      current = true
    }
