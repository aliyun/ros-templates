ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 创建VPC环境，配置安全组，搭建NFS文件系统，启用PAI服务，部署基于ChatGLM和LangChain的对话模型WebUI。
  en: Create a VPC environment, configure security groups, set up an NFS file system,
    enable PAI services, and deploy a conversation model WebUI based on ChatGLM and
    LangChain.
Parameters:
  ZoneId:
    Type: String
    Label:
      en: VSwitch Availability Zone
      zh-cn: 可用区
    Description:
      en: Availability Zone ID
      zh-cn: 可用区ID。
    AssociationProperty: ZoneId
  PAIEASInstanceType:
    Type: String
    Label:
      en: PAI-EAS instance type.
      zh-cn: PAI-EAS实例规格
    Description:
      en: PAI-EAS instance type.
      zh-cn: PAI-EAS 使用的实例规格。
    AllowedPattern: '(^ecs.*gn.*)|(^ml.*)'
Resources:
  RandomString:
    Type: ALIYUN::RandomString
    Properties:
      length: 8
      character_classes:
        - class: lowercase
          min: 1
        - class: digits
          min: 1
  Vpc:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock: 192.168.0.0/16
  VSwitch:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      ZoneId:
        Ref: ZoneId
      VpcId:
        Ref: Vpc
      CidrBlock: 192.168.0.0/24
  SecurityGroup:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: Vpc
      SecurityGroupIngress:
        - PortRange: 80/80
          Priority: 1
          SourceCidrIp: 0.0.0.0/0
          IpProtocol: tcp
          NicType: internet
        - PortRange: 443/443
          Priority: 1
          SourceCidrIp: 0.0.0.0/0
          IpProtocol: tcp
          NicType: internet
        - PortRange: 3389/3389
          Priority: 1
          SourceCidrIp: 0.0.0.0/0
          IpProtocol: tcp
          NicType: internet
  NasFileSystem:
    Type: ALIYUN::NAS::FileSystem
    Properties:
      ProtocolType: NFS
      FileSystemType: standard
      StorageType: Performance
      DeletionForce: true
      ZoneId:
        Ref: ZoneId
      VpcId:
        Ref: Vpc
      VSwitchId:
        Ref: VSwitch
  NasAccessGroup:
    Type: ALIYUN::NAS::AccessGroup
    Properties:
      AccessGroupType: Vpc
      AccessGroupName: 
        Fn::Sub: nas-access-group-${ALIYUN::StackId}
  NasMountTarget:
    Type: ALIYUN::NAS::MountTarget
    DependsOn:
    - NasAccessRule
    Properties:
      VpcId:
        Ref: Vpc
      VSwitchId:
        Ref: VSwitch
      NetworkType: Vpc
      AccessGroupName:
        Ref: NasAccessGroup
      FileSystemId:
        Ref: NasFileSystem
  NasAccessRule:
    Type: ALIYUN::NAS::AccessRule
    Properties:
      SourceCidrIp: 0.0.0.0/0
      AccessGroupName:
        Ref: NasAccessGroup
  Workspace:
    Type: ALIYUN::PAI::Workspace
    Properties:
      EnvTypes:
        - dev
        - prod
      Description: Build a dialogue model based on ChatGLM and LangChain.
      WorkspaceName:
        Fn::Sub: chatglm_demo_${RandomString.value}
  EAS:
    Type: ALIYUN::PAI::Service
    Properties:
      ServiceConfig:
        metadata:
          name:
            Fn::Sub: chatglm_demo_${RandomString.value}
          instance: 1
          enable_webservice: 'true'
        cloud:
          computing:
            instance_type:
              Ref: PAIEASInstanceType
            instances: Null
          networking:
            vswitch_id:
              Ref: VSwitch
            security_group_id:
              Ref: SecurityGroup
            vpc_id:
              Ref: Vpc
        containers:
          - image:
              Fn::Sub:
                - 'eas-registry-vpc.${Region}.cr.aliyuncs.com/pai-eas/chat-llm-webui:2.0'
                - Region:
                    Ref: ALIYUN::Region
            script: 'python webui/webui_server.py --port=8000 --model-path=THUDM/chatglm-6b'
            port: 8000
    DependsOn:
      - Workspace
Outputs:
  Namespace:
    Description:
      zh-cn: 服务所在的命名空间。
      en: The namespace where the service resides.
    Value:
      Fn::GetAtt:
        - EAS
        - Namespace
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
      - Parameters:
          - ZoneId
          - PAIEASInstanceType
    TemplateTags:
      - acs:technical-solution:AI:ChatGLM和LangChain搭建对话模型-tech_solu_31
  ALIYUN::ROS::Composer:
    '78550139':
      Res:
        - SecurityGroup
      Parent: a25bbf58
      Rect:
        - 228
        - 136
        - 262
        - 284
        - 10
        - 0
    6dcd9753:
      Rect:
        - 820
        - 470
        - 40
        - 100
        - 1
        - 0
      ResT: Composer::ROSParameter::AlibabaCloud
    8b2032fd:
      Parent: 6dcd9753
      Rect:
        - 780
        - 400
        - 60
        - 150
        - 2
        - 0
      ResT: Composer::ROSParameter::Region
    80ee19ff:
      Res:
        - RandomString
      Parent: 8b2032fd
      Rect:
        - 40
        - 40
        - 720
        - 490
        - 3
        - 0
      Hidden: true
      ResT: ALIYUN::RandomString
    a25bbf58:
      Res:
        - Vpc
      Parent: 8b2032fd
      Rect:
        - 620
        - 270
        - 100
        - 200
        - 3
        - 0
    cc1e3bea:
      Res:
        - NasAccessGroup
      Parent: 8b2032fd
      Rect:
        - 40
        - 40
        - 760
        - 290
        - 3
        - 0
      Hidden: true
    921c49dd:
      Res:
        - NasAccessRule
      Parent: 8b2032fd
      Rect:
        - 40
        - 40
        - 780
        - 200
        - 3
        - 0
      Hidden: true
    741a6545:
      Res:
        - VSwitch
      Parent: a25bbf58
      Rect:
        - 459
        - 203
        - 120
        - 250
        - 4
        - 0
    1f329335:
      Res:
        - NasFileSystem
      Parent: 741a6545
      Rect:
        - 40
        - 40
        - 160
        - 315
        - 5
        - 0
    9a5fde22:
      Res:
        - NasMountTarget
      Parent: 741a6545
      Rect:
        - 40
        - 40
        - 200
        - 300
        - 5
        - 0
      Hidden: true
    1a8a2f8c:
      Parent: 8b2032fd
      Edge:
        - 9a5fde22
        - cc1e3bea
      Line: 0:0:0:gray:0
    a79f9949:
      Parent: 741a6545
      Edge:
        - 9a5fde22
        - 1f329335
      Line: 0:0:0:gray:0
    9fbea3e9:
      Parent: 8b2032fd
      Edge:
        - 921c49dd
        - cc1e3bea
      Line: 0:0:0:gray:0
    18ceda11:
      Res:
        - Workspace
      Parent: 8b2032fd
      Rect:
        - 40
        - 40
        - 317
        - 315
        - 11
        - 0
    ba167aff:
      Res:
        - EAS
      Parent: 8b2032fd
      Rect:
        - 40
        - 40
        - 404
        - 315
        - 11
        - 0
