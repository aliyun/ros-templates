ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 创建VPC、ECS实例、OSS存储桶、RAM用户及策略，配置安全组和登录凭据，部署Java应用，支持文本绘图与人像美化功能。
  en: Create a Virtual Private Cloud (VPC), Elastic Compute Service (ECS) instances,
    Object Storage Service (OSS) buckets, Resource Access Management (RAM) users and
    policies, configure security groups and login credentials, deploy Java applications
    with support for text drawing and portrait beautification functionalities.
Parameters:
  DemoUserName:
    Type: String
    Label:
      zh-cn: 登录用户名
      en: Login Username
    Description:
      zh-cn: 在浏览器中登录示例应用程序时的用户名。
      en: Username when logging into the sample application in the browser.
    ConstraintDescription:
      zh-cn: 3 到 63 个字母组成。
      en: 3 to 63 letters.
    AssociationProperty: AutoCompleteInput
    AssociationPropertyMetadata:
      Length: 5
      Prefix: demo-user-
      CharacterClasses:
      - Class: lowercase
        min: 1
    AllowedPattern: ^[a-zA-Z-]{3,63}$
  DemoUserPassword:
    Type: String
    Label:
      en: Login Password
      zh-cn: 登录密码
    Description:
      en: Server login password, Length 8-30, must contain three(Capital letters,
        lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol
        in)
      zh-cn: 在浏览器中登录示例应用程序时的密码，长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/
        中的特殊符号）
    ConstraintDescription:
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers,
        ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in)
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）
    AssociationProperty: ALIYUN::ECS::Instance::Password
    NoEcho: true
  DashScopeApiKey:
    Type: String
    Label:
      en: DashScope API-KEY
      zh-cn: DashScope API-KEY
    Description:
      zh-cn: 开通灵积模型服务，并获得 API-KEY。请参考： <a href="https://help.aliyun.com/zh/dashscope/developer-reference/activate-dashscope-and-create-an-api-key"  target="_blank">开通DashScope并创建API-KEY</a>。
      en: 'Activate DashScope and obtain the API-KEY. Please refer to:  <a href="https://help.aliyun.com/zh/dashscope/developer-reference/activate-dashscope-and-create-an-api-key"  target="_blank">Activate
        DashScope and create API-KEY</a>.'
  BucketName:
    Type: String
    Label:
      zh-cn: 存储空间名称
      en: Bucket Name
    Description:
      zh-cn: 3到63个字符，不以连字符(-)开头和结尾，可以包含小写字母、数字和连字符(-)；<br>备注：<font color='blue'><b>需要保证整个网络的唯一性，已经存在的无法创建</b></font>
      en: '3 to 63 characters, not beginning and ending with a hyphen (-), can contain
        lowercase letters, Numbers and hyphens (-);<br>Note: <font color=''blue''><b>need
        whole network uniqueness, already existing can not be created.</b></font>'
    ConstraintDescription:
      zh-cn: 3 到 63 个字符，不以连字符 (-) 开头和结尾，可以包含小写字母、数字和连字符 (-)
      en: 3 to 63 characters, not beginning and ending with a hyphen (-), can contain
        lowercase letters, Numbers and hyphens (-)
    AssociationProperty: AutoCompleteInput
    AssociationPropertyMetadata:
      Length: 5
      Prefix: drawing-with-tongyi-wanxiang-
      CharacterClasses:
      - Class: lowercase
        min: 1
    AllowedPattern: ^[a-z0-9]+[a-z0-9\-]*[a-z0-9]+$
    MinLength: 3
    MaxLength: 63
  ZoneId:
    Type: String
    Label:
      en: Availability Zone
      zh-cn: 可用区
    AssociationProperty: ALIYUN::ECS::Instance::ZoneId
    AssociationPropertyMetadata:
      AutoSelectFirst: true
    Default: null
  InstanceType:
    Type: String
    Label:
      en: Instance Type
      zh-cn: 实例类型
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      ZoneId: ${ZoneId}
      InstanceChargeType: PostPaid
      SystemDiskCategory: cloud_essd
    Default: null
  InstancePassword:
    Type: String
    Label:
      en: Instance Password
      zh-cn: 实例密码
    Description:
      en: Server login password, Length 8-30, must contain three(Capital letters,
        lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol
        in)
      zh-cn: 服务器登录密码，长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）
    ConstraintDescription:
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers,
        ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in)
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）
    AssociationProperty: ALIYUN::ECS::Instance::Password
    Default: null
    NoEcho: true
  CommonName:
    Type: String
    Default: wanxiang
Resources:
  Vpc:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock: 192.168.0.0/16
      VpcName:
        Fn::Sub: ${CommonName}-vpc
  VSwitch:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      ZoneId:
        Ref: ZoneId
      VpcId:
        Ref: Vpc
      CidrBlock: 192.168.0.0/24
      VSwitchName:
        Fn::Sub: ${CommonName}-vsw
  SecurityGroup:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: Vpc
      SecurityGroupName:
        Fn::Sub: ${CommonName}-sg
      SecurityGroupIngress:
      - PortRange: 22/22
        SourceCidrIp: 0.0.0.0/0
        IpProtocol: tcp
      - PortRange: 80/80
        SourceCidrIp: 0.0.0.0/0
        IpProtocol: tcp
      - PortRange: -1/-1
        SourceCidrIp: 0.0.0.0/0
        IpProtocol: icmp
  EcsInstance:
    Type: ALIYUN::ECS::InstanceGroup
    Properties:
      ZoneId:
        Ref: ZoneId
      VpcId:
        Ref: Vpc
      VSwitchId:
        Ref: VSwitch
      SecurityGroupId:
        Ref: SecurityGroup
      ImageId: aliyun_3_9_x64_20G_alibase_
      InstanceName:
        Fn::Sub: ${CommonName}-ecs
      InstanceType:
        Ref: InstanceType
      SystemDiskCategory: cloud_essd
      MaxAmount: 1
      InternetMaxBandwidthOut: 5
      Password:
        Ref: InstancePassword
  Bucket:
    Type: ALIYUN::OSS::Bucket
    Properties:
      BucketName:
        Ref: BucketName
      DeletionForce: true
  User:
    Type: ALIYUN::RAM::User
    Properties:
      UserName:
        Fn::Sub: create_by_solution-${ALIYUN::StackId}
      PolicyAttachments:
        Custom:
        - Ref: CustomPolicy
  AccessKey:
    Type: ALIYUN::RAM::AccessKey
    Properties:
      UserName:
        Ref: User
  CustomPolicy:
    Type: ALIYUN::RAM::ManagedPolicy
    Properties:
      PolicyName:
        Fn::Sub: create_by_solution-${ALIYUN::StackId}
      PolicyDocument:
        Version: '1'
        Statement:
        - Effect: Allow
          Action:
          - oss:GetObject
          - oss:PutObject
          Resource:
          - Fn::Sub: acs:oss:oss-${ALIYUN::Region}:${ALIYUN::TenantId}:${BucketName}/*
  ModuleInstallJava:
    Type: MODULE::ACS::OOS::Extension
    Properties:
      EcsInstanceIds:
      - Ref: EcsInstance
      PackageName: ACS-Extension-java-1853370294850618
    Version: default
  InstallApp:
    Type: ALIYUN::ECS::RunCommand
    Properties:
      InstanceIds:
      - Ref: EcsInstance
      Type: RunShellScript
      Sync: true
      Timeout: 3600
      CommandContent:
        Fn::Sub: |-
          #!/bin/bash
          
          cat << EOF >> ~/.bash_profile
          export DASHSCOPE_API_KEY="${DashScopeApiKey}"
          export OSS_ACCESS_KEY_ID="${AccessKey.AccessKeyId}"
          export OSS_ACCESS_KEY_SECRET="${AccessKey.AccessKeySecret}"
          export WANX_DEMO_OSS_BUCKET="${BucketName}"
          export WANX_DEMO_USERNAME="${DemoUserName}"
          export WANX_DEMO_PASSWORD="${DemoUserPassword}"
          export WANX_DEMO_OSS_ENDPOINT="https://oss-${ALIYUN::Region}.aliyuncs.com"
          export APP_MANUAL_DEPLOY=false
          EOF
          
          source ~/.bash_profile 
          wget https://help-static-aliyun-doc.aliyuncs.com/tech-solution/wanx-demo-0.0.4.jar
          nohup java -jar wanx-demo-0.0.4.jar > wanx-demo.log 2>&1 &
Outputs:
  EcsLoginAddress:
    Description:
      en: Ecs login address.
      zh-cn: ECS登录地址。
    Value:
      Fn::Sub: https://ecs-workbench.aliyun.com/?from=EcsConsole&instanceType=ecs&regionId=${ALIYUN::Region}&instanceId=${EcsInstance}
  ExperienceAddress:
    Description:
      en: Experience address.
      zh-cn: 体验地址。
    Value:
      Fn::Sub:
      - http://${PublicIp}/wanx-demo
      - PublicIp:
          Fn::Select:
          - 0
          - Fn::GetAtt:
            - EcsInstance
            - PublicIps
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
    - Parameters:
      - DemoUserName
      - DemoUserPassword
      Label:
        en: Application login information configuration
        zh-cn: 应用登录信息配置
    - Parameters:
      - DashScopeApiKey
      - BucketName
      - ZoneId
      - InstanceType
      - InstancePassword
      Label:
        en: Cloud resource information configuration
        zh-cn: 云资源信息配置
    TemplateTags:
    - acs:technical-solution:ai:通义万相的文本绘图与人像美化之旅-tech_solu_109
    Hidden:
    - CommonName
