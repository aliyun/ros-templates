ROSTemplateFormatVersion: '2015-09-01'
Transform: Aliyun::Terraform-v1.5
Metadata:
  ALIYUN::ROS::Interface:
    TemplateTags:
      - acs:technical-solution:ai:MCP Empowerment for Visual OLAP Intelligent Applications-tech_solu_265
Workspace:
  variable.tf: |-
    # ------------------------------------------------------------------------------
    # Module Input Variables
    #
    # This file defines all configurable input variables for this Terraform module.
    # Each variable contains detailed descriptions to help users configure the module correctly.
    # ------------------------------------------------------------------------------

    # Username for PolarDB
    variable "account_name" {
      type        = string
      default     = "polar_ai"
      description = "account_name"
      validation {
        condition     = can(regex("^[a-z][a-z0-9_]{0,30}[a-z0-9]$", var.account_name))
        error_message = "The database username must start with a letter, end with a letter or number, and can only contain letters, numbers, and underscores with a maximum of 32 characters"
      }
    }

    # Password for PolarDB
    variable "db_password" {
      type        = string
      sensitive   = true
      description = "db_password"
      #default    = ""
      validation {
        condition     = can(regex("^[0-9A-Za-z_!@#$%^&*()_+\\-=\\+]+$", var.db_password)) && length(var.db_password) >= 8 && length(var.db_password) <= 30
        error_message = "Length 8-30, must include three items (uppercase letters, lowercase letters, numbers, special symbols from !@#$%^&*()_+-=)"
      }
    }

    # Database name for PolarDB
    variable "dbname" {
      type        = string
      default     = "db-test"
      description = "dbname"
    }

  main.tf: |-
    # ------------------------------------------------------------------------------
    # Main Resource Definitions
    # 
    # This file contains the core infrastructure resources of the module.
    # The code here is responsible for creating and configuring all cloud resources based on input variables.
    # ------------------------------------------------------------------------------

    # Configure Alibaba Cloud provider
    provider "alicloud" {
      region = "cn-hangzhou"
    }

    # Create a random ID
    resource "random_id" "suffix" {
      byte_length = 8
    }

    # Define local variables
    locals {
      common_name = "polardb-${random_id.suffix.id}"
    }

    # Query availability zones
    data "alicloud_polardb_node_classes" "default" {
      db_type    = "MySQL"
      pay_type   = "PostPaid"
      category   = "SENormal"
    }

    # Create a VPC
    resource "alicloud_vpc" "vpc" {
      cidr_block = "192.168.0.0/16"
      vpc_name   = "VPC_${local.common_name}"
    }

    # Create a VSwitch
    resource "alicloud_vswitch" "vswitch" {
      vpc_id       = alicloud_vpc.vpc.id
      cidr_block   = "192.168.0.0/24"
      zone_id      = data.alicloud_polardb_node_classes.default.classes[0].zone_id
      vswitch_name = "vsw_001_${local.common_name}"
    }

    # Create a PolarDB cluster
    resource "alicloud_polardb_cluster" "polardb_cluster" {
      vpc_id            = alicloud_vpc.vpc.id
      db_type           = "MySQL"
      zone_id           = data.alicloud_polardb_node_classes.default.classes[0].zone_id
      vswitch_id        = alicloud_vswitch.vswitch.id
      db_version        = "8.0"
      creation_category = "SENormal"
      storage_space     = 40
      db_node_class     = "polar.mysql.g1.tiny.c"
      pay_type          = "PostPaid"
      storage_type      = "ESSDAUTOPL"
      security_ips      = ["0.0.0.0/0"]
    }

    # Create a PolarDB account
    resource "alicloud_polardb_account" "account" {
      db_cluster_id    = alicloud_polardb_cluster.polardb_cluster.id
      account_name     = var.account_name
      account_password = var.db_password
      account_type     = "Super"
    }

    # Retrieve endpoint information of the PolarDB cluster
    data "alicloud_polardb_endpoints" "polardb_endpoints" {
      db_cluster_id = alicloud_polardb_cluster.polardb_cluster.id
      depends_on    = [alicloud_polardb_cluster.polardb_cluster]
    }

    # Create a public connection address for the PolarDB cluster
    resource "alicloud_polardb_endpoint_address" "dbcluster_endpoint_address" {
      db_endpoint_id = data.alicloud_polardb_endpoints.polardb_endpoints.endpoints[0].db_endpoint_id
      db_cluster_id  = alicloud_polardb_cluster.polardb_cluster.id
      net_type       = "Public"
      depends_on = [
        alicloud_polardb_account.account
      ]
    }

    # Create a PolarDB database
    resource "alicloud_polardb_database" "polardb_database" {
      db_cluster_id      = alicloud_polardb_cluster.polardb_cluster.id
      db_name            = var.dbname
      character_set_name = "utf8"
      account_name       = var.account_name
    }

  output.tf: |-
    # ------------------------------------------------------------------------------
    # Module Outputs
    #
    # This file defines the values returned to the caller after successful module execution.
    # These outputs can be referenced by other Terraform configurations or displayed to users after the apply command completes.
    # ------------------------------------------------------------------------------

    # Outputs the access address of the PolarDB cluster
    output "polardb_cluster_address" {
      value = format("https://polardb.console.aliyun.com/%s/cluster/%s/baseInfo","cn-hangzhou", alicloud_polardb_cluster.polardb_cluster.id)
      description = "PolarDB access address"
    }

    # Outputs the database username
    output "db_username" {
      value       = var.account_name
      description = "Database username"
    }

    # Outputs the database password
    output "db_password" {
      value       = var.db_password
      sensitive   = true
      description = "Database password"
    }

    # Outputs the database name
    output "db_name" {
      value       = var.dbname
      description = "Database name"
    }

    # Outputs the public connection address of the PolarDB database
    output "connection_string" {
      value = format("%s", alicloud_polardb_endpoint_address.dbcluster_endpoint_address.connection_string)
      description = "Public connection address of the PolarDB database"
    }
