ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 创建VPC环境，配置安全组，搭建NFS文件系统，启用PAI服务，部署基于Qwen和LangChain的对话模型WebUI。
  en: Create a VPC environment, configure security groups, set up an NFS file system,
    enable PAI services, and deploy a conversation model WebUI based on Qwen and LangChain.
Parameters:
  ZoneId:
    Type: String
    Label:
      en: VSwitch Availability Zone
      zh-cn: 可用区
    Description:
      en: Availability Zone ID
      zh-cn: 可用区ID。
    AssociationProperty: ZoneId
  PAIEASInstanceType:
    Type: String
    Label:
      en: PAI-EAS instance type.
      zh-cn: PAI-EAS实例规格
    Description:
      en: PAI-EAS instance type.
      zh-cn: PAI-EAS 使用的实例规格。
    AllowedPattern: (^ecs.*gn.*)|(^ml.*)
Resources:
  RandomString:
    Type: ALIYUN::RandomString
    Properties:
      length: 8
      character_classes:
      - class: lowercase
        min: 1
      - class: digits
        min: 1
  EnablePAI:
    Type: ALIYUN::ROS::AutoEnableService
    Properties:
      ServiceName: PAI
  Vpc:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock: 192.168.0.0/16
    DependsOn:
    - EnablePAI
  VSwitch:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      ZoneId:
        Ref: ZoneId
      VpcId:
        Ref: Vpc
      CidrBlock: 192.168.0.0/24
  SecurityGroup:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: Vpc
      SecurityGroupIngress:
      - PortRange: 22/22
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
        IpProtocol: tcp
        NicType: internet
      - PortRange: 80/80
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
        IpProtocol: tcp
        NicType: internet
      - PortRange: 443/443
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
        IpProtocol: tcp
        NicType: internet
      - PortRange: 3389/3389
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
        IpProtocol: tcp
        NicType: internet
  NasFileSystem:
    Type: ALIYUN::NAS::FileSystem
    Properties:
      ZoneId:
        Ref: ZoneId
      VpcId:
        Ref: Vpc
      VSwitchId:
        Ref: VSwitch
      ProtocolType: NFS
      FileSystemType: standard
      StorageType: Performance
      DeletionForce: true
  NasAccessGroup:
    Type: ALIYUN::NAS::AccessGroup
    Properties:
      AccessGroupType: Vpc
      AccessGroupName:
        Fn::Sub: nas-access-group-${ALIYUN::StackId}
  NasAccessRule:
    Type: ALIYUN::NAS::AccessRule
    Properties:
      SourceCidrIp: 0.0.0.0/0
      AccessGroupName:
        Ref: NasAccessGroup
  NasMountTarget:
    Type: ALIYUN::NAS::MountTarget
    Properties:
      VpcId:
        Ref: Vpc
      VSwitchId:
        Ref: VSwitch
      NetworkType: Vpc
      AccessGroupName:
        Ref: NasAccessGroup
      FileSystemId:
        Ref: NasFileSystem
    DependsOn:
    - NasAccessRule
  Workspace:
    Type: ALIYUN::PAI::Workspace
    Properties:
      EnvTypes:
      - dev
      - prod
      Description: Build a dialogue model based on Qwen and LangChain.
      WorkspaceName:
        Fn::Sub: qwen_demo_${RandomString.value}
    DependsOn:
    - EnablePAI
  EAS:
    Type: ALIYUN::PAI::Service
    Properties:
      ServiceConfig:
        metadata:
          name:
            Fn::Sub: qwen_demo_${RandomString.value}
          instance: 1
          enable_webservice: 'true'
        cloud:
          computing:
            instance_type:
              Ref: PAIEASInstanceType
            instances: null
        containers:
        - image:
            Fn::Sub:
            - eas-registry-vpc.${Region}.cr.aliyuncs.com/pai-eas/chat-llm-webui:2.1
            - Region:
                Ref: ALIYUN::Region
          script: python webui/webui_server.py --port=8000 --model-path=Qwen/Qwen-7B-Chat
          port: 8000
    DependsOn:
    - Workspace
Outputs:
  Namespace:
    Description:
      zh-cn: 服务所在的命名空间。
      en: The namespace where the service resides.
    Value:
      Fn::GetAtt:
      - EAS
      - Namespace
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
    - Parameters:
      - ZoneId
      - PAIEASInstanceType
    TemplateTags:
    - acs:technical-solution:AI:通义千问和LangChain搭建对话模型
