ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 创建托管Kubernetes集群，配置VPC、节点池、HPA及日志服务，实现容器应用的自动伸缩与监控。
  en: Create a managed Kubernetes cluster, configure Virtual Private Cloud (VPC),
    node pools, Horizontal Pod Autoscaler (HPA), and logging services to enable automatic
    scaling and monitoring of containerized applications.
Parameters:
  SlsProjectName:
    Type: String
    Label:
      en: Name of sls project
      zh-cn: 日志项目的名称
    Description:
      en: The name contains 3 to 36 characters. It must start and end with a lowercase
        letter or number. The value can contain lowercase letters, digits, and hyphens
        (-).
      zh-cn: 长度为3~36个字符。必须以小写英文字母或数字开头和结尾。可包含小写英文字母、数字和短划线（-）。
    AssociationProperty: AutoCompleteInput
    AssociationPropertyMetadata:
      Length: 5
      Prefix: k8s-hpa-sls-project-
      CharacterClasses:
      - Class: lowercase
        min: 1
  ManagedKubernetesClusterName:
    Type: String
    Label:
      en: Managed Kubernetes Cluster Name
      zh-cn: ACK托管版集群名称
    AssociationProperty: AutoCompleteInput
    AssociationPropertyMetadata:
      Length: 5
      Prefix: k8s-hpa-cluster-
      CharacterClasses:
      - Class: lowercase
        min: 1
  ZoneId1:
    Type: String
    Label:
      en: Availability Zone
      zh-cn: 可用区1
    AssociationProperty: ALIYUN::ECS::Instance::ZoneId
    AssociationPropertyMetadata:
      ExclusiveTo:
      - ZoneId2
  ZoneId2:
    Type: String
    Label:
      en: Availability Zone
      zh-cn: 可用区2
    AssociationProperty: ALIYUN::ECS::Instance::ZoneId
    AssociationPropertyMetadata:
      ExclusiveTo:
      - ZoneId1
  InstanceType:
    Type: CommaDelimitedList
    Label:
      en: Instance Type
      zh-cn: 实例规格
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      InstanceChargeType: PostPaid
      SystemDiskCategory: cloud_essd
      CreateACKClusterParams:
        NetworkPlugin: terway-eniip
  InstancePassword:
    Type: String
    Label:
      en: Instance Password
      zh-cn: 实例密码
    Description:
      en: Server login password, Length 8-30, must contain three(Capital letters,
        lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol
        in)
      zh-cn: 服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）
    ConstraintDescription:
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers,
        ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in)
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）
    AssociationProperty: ALIYUN::ECS::Instance::Password
    Default: null
    NoEcho: true
  CommonName:
    Type: String
    Default: k8s-hpa-cluster
Resources:
  Vpc:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock: 10.0.0.0/8
      VpcName:
        Fn::Sub: ${CommonName}-vpc
  VSwitch1:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      ZoneId:
        Ref: ZoneId1
      VpcId:
        Ref: Vpc
      CidrBlock: 10.0.0.0/24
      VSwitchName:
        Fn::Sub: ${CommonName}-vsw
  VSwitch2:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      ZoneId:
        Ref: ZoneId2
      VpcId:
        Ref: Vpc
      CidrBlock: 10.0.1.0/24
      VSwitchName:
        Fn::Sub: ${CommonName}-vsw
  SecurityGroup:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: Vpc
      SecurityGroupName:
        Fn::Sub: ${CommonName}-sg
      SecurityGroupIngress:
      - PortRange: 22/22
        SourceCidrIp: 0.0.0.0/0
        IpProtocol: tcp
      - PortRange: 443/443
        SourceCidrIp: 0.0.0.0/0
        IpProtocol: tcp
      - PortRange: 80/80
        SourceCidrIp: 0.0.0.0/0
        IpProtocol: tcp
  SlsProject:
    Type: ALIYUN::SLS::Project
    Properties:
      Name:
        Ref: SlsProjectName
  AliyunCSManagedAutoScalerRole:
    Type: ALIYUN::RAM::Role
    Properties:
      RoleName: AliyunCSManagedAutoScalerRole
      Description: CS使用此角色来访问您在其他云产品中的资源。
      AssumeRolePolicyDocument:
        Version: '1'
        Statement:
        - Action: sts:AssumeRole
          Effect: Allow
          Principal:
            Service:
            - cs.aliyuncs.com
      MaxSessionDuration: 3600
      IgnoreExisting: true
      DeletionForce: true
      PolicyAttachments:
        System:
        - AliyunCSManagedAutoScalerRolePolicy
  AckCluster:
    Type: ALIYUN::CS::ManagedKubernetesCluster
    Properties:
      VpcId:
        Ref: Vpc
      VSwitchIds:
      - Ref: VSwitch1
      - Ref: VSwitch2
      PodVswitchIds:
      - Ref: VSwitch1
      - Ref: VSwitch1
      Name:
        Ref: ManagedKubernetesClusterName
      KubernetesVersion: 1.28.9-aliyun.1
      ServiceCidr: 192.168.0.0/16
      ClusterSpec: ack.pro.small
      LoadBalancerSpec: slb.s2.small
      IsEnterpriseSecurityGroup: true
      SnatEntry: true
      NumOfNodes: 0
      EndpointPublicAccess: true
      Platform: AliyunLinux
      Addons:
      - Name: ack-node-local-dns
      - Name: terway-eniip
        Config: '{"IPVlan":"false","NetworkPolicy":"false","ENITrunking":"false"}'
      - Name: csi-plugin
      - Name: csi-provisioner
      - Name: storage-operator
        Config: '{"CnfsOssEnable":"false","CnfsNasEnable":"false"}'
      - Name: nginx-ingress-controller
        Disabled: true
      - Name: logtail-ds
        Config: '{"IngressDashboardEnabled":"true"}'
      - Name: alb-ingress-controller
        Version: ''
        Config:
          Fn::Sub: '{"albIngress":{"AddressType":"Internet","ZoneMappings":{"${ZoneId1}":["${VSwitch1}"],
            "${ZoneId2}":["${VSwitch2}"]},"CreateDefaultALBConfig":true}}'
      - Name: ack-helm-manager
      - Name: arms-prometheus
      ProxyMode: ipvs
      DeleteOptions:
      - ResourceType: ALB
        DeleteMode: delete
      - ResourceType: SLB
        DeleteMode: delete
      - ResourceType: SLS_Data
        DeleteMode: delete
      - ResourceType: SLS_ControlPlane
        DeleteMode: delete
      - ResourceType: PrivateZone
        DeleteMode: delete
    DependsOn: AliyunCSManagedAutoScalerRole
  NodePools:
    Type: ALIYUN::CS::ClusterNodePool
    Properties:
      ClusterId:
        Ref: AckCluster
      NodePoolInfo:
        Name: k8s-hpa-cluster-nodepool
      ScalingGroup:
        VSwitchIds:
        - Ref: VSwitch1
        - Ref: VSwitch2
        ZoneIds:
        - Ref: ZoneId1
        - Ref: ZoneId2
        SystemDiskCategory: cloud_essd
        SystemDiskPerformanceLevel: PL0
        SystemDiskSize: 40
        InstanceTypes:
          Ref: InstanceType
        LoginPassword:
          Ref: InstancePassword
        Platform: AliyunLinux
        ImageId: aliyun_3_9_x64_20G_alibase_20231219.vhd
      KubernetesConfig:
        Runtime: containerd
        RuntimeVersion: 1.6.28
      AutoScaling:
        Enable: true
        MinInstances: 2
        MaxInstances: 10
  Sleep:
    Type: ALIYUN::ROS::Sleep
    Properties:
      CreateDuration: 300
    DependsOn: NodePools
  AckMetricsAdapter:
    Type: ALIYUN::CS::ClusterHelmApplication
    Properties:
      Namespace: kube-system
      ChartUrl: https://aliacs-app-catalog.oss-cn-hangzhou.aliyuncs.com/charts-incubator/ack-alibaba-cloud-metrics-adapter-1.3.3.tgz
      ClusterId:
        Ref: AckCluster
      Name: ack-alibaba-cloud-metrics-adapter
      ChartValues:
        AlibabaCloudMetricsAdapter:
          commonLabels: ''
          replicas: 1
          resources:
            metricsAdapterDeployment:
              resources:
                limits:
                  cpu: 0.5
                  memory: 1Gi
                requests:
                  cpu: 100m
                  memory: 200Mi
            configReloader:
              resources:
                limits:
                  cpu: 20m
                  memory: 30Mi
                requests:
                  cpu: 20m
                  memory: 30Mi
          listenPort: 443
          costWeights:
            cpu: '1.0'
            memory: '0.0'
          image:
            repository: registry-cn-hangzhou-vpc.ack.aliyuncs.com/acs/alibaba-cloud-metrics-adapter-amd64
            tag: v0.2.7-f1ee5c3-aliyun
            pullPolicy: Always
          nameOverride: ''
          fullnameOverride: ''
          service:
            type: ClusterIP
          serviceAccountName: ack-alibaba-cloud-metrics-adapter
          annotations: {}
          nodeSelector: {}
          tolerations: []
          env:
          - AccessKeyId: ''
          - AccessKeySecret: ''
          - Region: ''
          affinity: {}
          prometheus:
            enabled: true
            url: {}
            metricsRelistInterval: 1m
            logLevel: 5
            adapter:
              rules:
                default: false
                custom:
                - seriesQuery: container_memory_working_set_bytes{namespace!="",pod!=""}
                  resources:
                    overrides:
                      namespace:
                        resource: namespace
                      pod:
                        resource: pod
                  name:
                    matches: ^(.*)_bytes
                    as: ${1}_bytes_per_second
                  metricsQuery: sum(<<.Series>>{<<.LabelMatchers>>}) by (<<.GroupBy>>)
                - seriesQuery: container_cpu_usage_seconds_total{namespace!="",pod!=""}
                  resources:
                    overrides:
                      namespace:
                        resource: namespace
                      pod:
                        resource: pod
                  name:
                    matches: ^(.*)_seconds_total
                    as: ${1}_core_per_second
                  metricsQuery: sum(rate(<<.Series>>{<<.LabelMatchers>>}[1m])) by
                    (<<.GroupBy>>)
        ConfigReloader:
          image:
            repository: registry-vpc.cn-hangzhou.aliyuncs.com/acs/configmap-reload
            tag: v0.0.1
    DependsOn: Sleep
  InstallBackendApp:
    Type: ALIYUN::CS::ClusterApplication
    Properties:
      ClusterId:
        Ref: AckCluster
      YamlContent:
        Fn::Sub: "apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: coffee\n\
          spec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: coffee\n\
          \  template:\n    metadata:\n      labels:\n        app: coffee\n    spec:\n\
          \      containers:\n      - name: coffee\n        image: registry.${ALIYUN::Region}.aliyuncs.com/acs-sample/nginxdemos:latest\n\
          \        ports:\n        - containerPort: 80\n        resources:\n     \
          \     limits:\n            cpu: 500m\n            memory: 1Gi\n        \
          \  requests:\n            cpu: 500m\n            memory: 512Mi\n---\napiVersion:\
          \ v1\nkind: Service\nmetadata:\n  name: coffee-svc\nspec:\n  ports:\n  -\
          \ port: 80\n    targetPort: 80\n    protocol: TCP\n  selector:\n    app:\
          \ coffee\n  type: NodePort\n---\napiVersion: apps/v1\nkind: Deployment\n\
          metadata:\n  name: tea\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n\
          \      app: tea\n  template:\n    metadata:\n      labels:\n        app:\
          \ tea\n    spec:\n      containers:\n      - name: tea\n        image: registry.${ALIYUN::Region}.aliyuncs.com/acs-sample/nginxdemos:latest\n\
          \        ports:\n        - containerPort: 80\n        resources:\n     \
          \     limits:\n            cpu: 500m\n            memory: 1Gi\n        \
          \  requests:\n            cpu: 500m\n            memory: 512Mi\n---\napiVersion:\
          \ v1\nkind: Service\nmetadata:\n  name: tea-svc\nspec:\n  ports:\n  - port:\
          \ 80\n    targetPort: 80\n    protocol: TCP\n  selector:\n    app: tea\n\
          \  type: NodePort"
    DependsOn: AckMetricsAdapter
  AlbConfig:
    Type: ALIYUN::CS::ClusterApplication
    Properties:
      ClusterId:
        Ref: AckCluster
      YamlContent:
        Fn::Sub: "apiVersion: alibabacloud.com/v1\nkind: AlbConfig\nmetadata:\n  name:\
          \ k8s-hpa-alb-config\nspec:\n  config:\n    name: k8s-hpa-alb\n    addressType:\
          \ Internet\n    zoneMappings:\n    - vSwitchId: ${VSwitch1}\n    - vSwitchId:\
          \ ${VSwitch2}\n    accessLogConfig:\n      logProject: ${SlsProject}\n \
          \     logStore: \"alb_k8s_hpa_sls_logstore\"\n  listeners:\n    - port:\
          \ 80\n      protocol: HTTP"
    DependsOn: InstallBackendApp
  IngressClass:
    Type: ALIYUN::CS::ClusterApplication
    Properties:
      ClusterId:
        Ref: AckCluster
      YamlContent:
        Fn::Sub: "apiVersion: networking.k8s.io/v1\nkind: IngressClass\nmetadata:\n\
          \  name: k8s-hpa-alb-ingress-class\nspec:\n  controller: ingress.k8s.alibabacloud/alb\n\
          \  parameters:\n    apiGroup: alibabacloud.com\n    kind: AlbConfig\n  \
          \  name: k8s-hpa-alb-config"
    DependsOn: AlbConfig
  Ingress:
    Type: ALIYUN::CS::ClusterApplication
    Properties:
      ClusterId:
        Ref: AckCluster
      YamlContent:
        Fn::Sub: "apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name:\
          \ k8s-hpa-alb-ingress\nspec:\n  ingressClassName: k8s-hpa-alb-ingress-class\n\
          \  rules:\n   - http:\n      paths:\n      - path: /tea\n        pathType:\
          \ ImplementationSpecific\n        backend:\n          service:\n       \
          \     name: tea-svc\n            port:\n              number: 80\n     \
          \ - path: /coffee\n        pathType: ImplementationSpecific\n        backend:\n\
          \          service:\n            name: coffee-svc\n            port: \n\
          \              number: 80"
    DependsOn: IngressClass
  WaitAlbIngress:
    Type: ALIYUN::ROS::Sleep
    Properties:
      CreateDuration: 120
    DependsOn: Ingress
  Hpa:
    Type: ALIYUN::CS::ClusterApplication
    Properties:
      ClusterId:
        Ref: AckCluster
      YamlContent:
        Fn::Sub: "apiVersion: autoscaling/v2\nkind: HorizontalPodAutoscaler\nmetadata:\n\
          \  name: k8s-alb-tea-hpa\nspec:\n  scaleTargetRef:\n    apiVersion: apps/v1\n\
          \    kind: Deployment\n    name: tea\n  minReplicas: 2\n  maxReplicas: 10\n\
          \  metrics:\n    - type: External\n      external:\n        metric:\n  \
          \        name: sls_alb_ingress_qps\n          selector:\n            matchLabels:\n\
          \              sls.project: ${SlsProject}\n              sls.logstore: \"\
          alb_k8s_hpa_sls_logstore\" \n              sls.ingress.route: \"default-tea-svc-80\"\
          \n        target:\n          type: AverageValue\n          averageValue:\
          \ 2\n    - resource:\n        name: cpu\n        target:\n          averageUtilization:\
          \ 80\n          type: Utilization\n      type: Resource\n    - resource:\n\
          \        name: memory\n        target:\n          averageUtilization: 80\n\
          \          type: Utilization\n      type: Resource"
    DependsOn: WaitAlbIngress
  IngressInfo:
    Type: DATASOURCE::CS::ClusterApplicationResources
    Properties:
      ClusterId:
        Ref: AckCluster
      Kind: Ingress
      Namespace: default
      JsonPath: $.items.[0].status.loadBalancer.ingress.[0].hostname
      FirstMatch: true
    DependsOn: WaitAlbIngress
Outputs:
  TeaUrl:
    Description:
      zh-cn: tea服务访问地址。
      en: The addresses of tea service.
    Value:
      Fn::Sub: http://${IngressInfo}/tea
  CoffeeUrl:
    Description:
      zh-cn: coffee服务访问地址。
      en: The addresses of coffee service.
    Value:
      Fn::Sub: http://${IngressInfo}/coffee
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
    - Parameters:
      - SlsProjectName
      - ManagedKubernetesClusterName
      - ZoneId1
      - ZoneId2
      - InstanceType
      - InstancePassword
    TemplateTags:
    - acs:technical-solution:micro:通过HPA实现容器应用的水平弹性伸缩-tech_solu_125
    Hidden:
    - CommonName
