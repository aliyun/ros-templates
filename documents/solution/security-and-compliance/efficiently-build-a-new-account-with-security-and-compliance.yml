ROSTemplateFormatVersion: '2015-09-01'
Transform: Aliyun::Terraform-v1.2
Description:
  zh-cn: 创建资源账户、SAML身份提供商、RAM角色与策略、VPC和交换机，实现新账号的安全合规自动化构建。
  en: Create resource accounts, SAML identity providers, RAM roles and policies, VPCs,
    and switches to achieve secure and compliant automated setup for new accounts.
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
    - Parameters:
      - folder_ids
    TemplateTags:
    - acs:technical-solution:security-and-compliance:高效构建安全合规的新账号-tech_solu_66
    Hidden:
    - idp_metadata
    - ALIYUN__StackId
Workspace:
  main.tf: "terraform {\n  required_providers {\n    alicloud = {\n      source =\
    \ \"hashicorp/alicloud\"\n      version = \"1.205.0\"\n    }\n  }\n}\n\nlocals\
    \ {\n  suffix = element(split(\"-\", var.ALIYUN__StackId), length(split(\"-\"\
    , var.ALIYUN__StackId))-1)\n}\n\nmodule \"account_create\" {\n  source = \"./modules/account-create\"\
    \n\n  account_name = \"account-new-demo-${local.suffix}\"\n  account_name_prefix\
    \ = \"demo-${local.suffix}\"\n  folder_id = element(var.folder_ids, 0)\n}\n\n\
    module \"account_deploy\" {\n  source = \"./modules/account-deploy\"\n\n  idp_metadata\
    \ = var.idp_metadata\n  account_id = module.account_create.account_id\n}"
  modules/account-create/main.tf: "# Create member account\nresource \"alicloud_resource_manager_account\"\
    \ \"rd_account_app\" {\n  display_name = var.account_name\n  account_name_prefix\
    \ = var.account_name_prefix\n  folder_id = var.folder_id\n}"
  modules/account-create/outputs.tf: "# outputs.tf https://learn.hashicorp.com/tutorials/terraform/outputs\n\
    output \"account_id\" {\n  value = alicloud_resource_manager_account.rd_account_app.id\n\
    }"
  modules/account-create/variables.tf: 'variable "account_name" {}


    variable "account_name_prefix" {}


    variable "folder_id" {}'
  modules/account-deploy/auth-authorize-role/main.tf: "locals {\n  policy_name   \
    \  = var.policy_name\n  policy_document = var.policy_document\n  attach_roles\
    \    = var.attach_roles\n  attach_users    = var.attach_users\n\n  reader_name\
    \        = var.reader_name\n  reader_policy_type = var.reader_policy_type\n  reader_policy_name\
    \ = var.reader_policy_name\n}\n\n# Create policy\nresource \"alicloud_ram_policy\"\
    \ \"policy\" {\n  policy_name     = local.policy_name\n  policy_document = local.policy_document\n\
    \  description     = \"create by Terraform\"\n  force           = true\n}\n\n\
    # Add policy to user\nresource \"alicloud_ram_user_policy_attachment\" \"user_attach\"\
    \ {\n  for_each    = toset(local.attach_users)\n  policy_name = alicloud_ram_policy.policy.name\n\
    \  policy_type = alicloud_ram_policy.policy.type\n  user_name   = each.value\n\
    }\n\n# Add policy to role\nresource \"alicloud_ram_role_policy_attachment\" \"\
    role_attach\" {\n  for_each    = toset(local.attach_roles)\n  policy_name = alicloud_ram_policy.policy.name\n\
    \  policy_type = alicloud_ram_policy.policy.type\n  role_name   = each.value\n\
    }\n\n# Add policy to reader role\nresource \"alicloud_ram_role_policy_attachment\"\
    \ \"reader_attach\" {\n  policy_name = local.reader_policy_name\n  policy_type\
    \ = local.reader_policy_type\n  role_name   = local.reader_name\n}"
  modules/account-deploy/auth-authorize-role/variables.tf: "variable \"policy_name\"\
    \ {}\n\nvariable \"policy_document\" {\n    type = string\n}\n\nvariable \"attach_roles\"\
    \ {\n    type = list(string)\n}\n\nvariable \"attach_users\" {\n    type = list(string)\n\
    }\n\nvariable \"reader_name\" {}\n\nvariable \"reader_policy_type\" {}\n\nvariable\
    \ \"reader_policy_name\" {}"
  modules/account-deploy/auth-create-idp/idp/main.tf: "resource \"alicloud_ram_saml_provider\"\
    \ \"idp\" {\n  saml_provider_name            = var.sso_provider_name\n  encodedsaml_metadata_document\
    \ = var.encodedsaml_metadata_document\n  description                   = \"Created\
    \ with Terraform automation scripts.\"\n}"
  modules/account-deploy/auth-create-idp/idp/outputs.tf: "output \"idp_arn\" {\n \
    \ value = alicloud_ram_saml_provider.idp.arn\n}"
  modules/account-deploy/auth-create-idp/idp/variables.tf: 'variable "sso_provider_name"
    {}


    variable "encodedsaml_metadata_document" {}'
  modules/account-deploy/auth-create-idp/main.tf: "module \"idp\" {\n  source = \"\
    ./idp\"\n\n  sso_provider_name = var.sso_provider_name\n  encodedsaml_metadata_document\
    \ = base64encode(trim(var.metadata, \" \\t\\n\"))\n}"
  modules/account-deploy/auth-create-idp/outputs.tf: "output \"idp_arn\" {\n  value\
    \ = module.idp.idp_arn\n}"
  modules/account-deploy/auth-create-idp/variables.tf: 'variable "sso_provider_name"
    {}


    variable "metadata" {}'
  modules/account-deploy/auth-create-role/main.tf: "# Create ram roles from IDP\n\
    module \"ram_role\" {\n  source    = \"./role\"\n\n  for_each          = {for\
    \ role in var.ram_roles.roles : role.role_name => role}\n  account_uid       =\
    \ var.account_id\n  role_name         = each.value.role_name\n  role_description\
    \  = each.value.description\n  sso_provider_name = var.sso_provider_name\n}"
  modules/account-deploy/auth-create-role/outputs.tf: "output \"role_arns\" {\n  value\
    \      = {\n  for role in var.ram_roles.roles :role.role_name => module.ram_role[role.role_name].role_arn\n\
    \  }\n  depends_on = [module.ram_role]\n}"
  modules/account-deploy/auth-create-role/role/main.tf: "resource \"alicloud_ram_role\"\
    \ \"ram_role\" {\n  name = var.role_name\n  description = var.role_description\n\
    \  document    = <<EOF\n  {\n    \"Statement\": [\n        {\n            \"Action\"\
    : \"sts:AssumeRole\",\n            \"Condition\": {\n                \"StringEquals\"\
    : {\n                    \"saml:recipient\": \"https://signin.aliyun.com/saml-role/sso\"\
    \n                }\n            },\n            \"Effect\": \"Allow\",\n    \
    \        \"Principal\": {\n                \"Federated\": [\n                \
    \    \"acs:ram::${var.account_uid}:saml-provider/${var.sso_provider_name}\"\n\
    \                ]\n            }\n        }\n    ],\n    \"Version\": \"1\"\n\
    \  }\n  EOF\n  force = true\n}\n"
  modules/account-deploy/auth-create-role/role/outputs.tf: "output \"role_arn\" {\n\
    \  value = alicloud_ram_role.ram_role.arn\n  description = \"Output role arn.\"\
    \n}\n"
  modules/account-deploy/auth-create-role/role/variables.tf: 'variable "role_name"
    {}


    variable "role_description" {}


    variable "sso_provider_name" {}


    variable "account_uid" {}'
  modules/account-deploy/auth-create-role/variables.tf: 'variable "sso_provider_name"
    {}


    variable "ram_roles" {}


    variable "account_id" {}'
  modules/account-deploy/auth-create-user/main.tf: "locals {\n  user_name    = var.user_name\n\
    }\n\nresource \"alicloud_ram_user\" \"user\" {\n  name     = local.user_name\n\
    \  force    = true\n}"
  modules/account-deploy/auth-create-user/outputs.tf: "output \"user_id\" {\n  value\
    \ = alicloud_ram_user.user.id\n}"
  modules/account-deploy/auth-create-user/variables.tf: variable "user_name" {}
  modules/account-deploy/main.tf: "locals {\n  user_name = \"AutomationSecurity_DAT09\"\
    \n  idp_metadata = var.idp_metadata\n  account_id = var.account_id\n}\n\nprovider\
    \ \"alicloud\" {\n  assume_role {\n    role_arn           = format(\"acs:ram::%s:role/ResourceDirectoryAccountAccessRole\"\
    , local.account_id)\n    session_name       = \"AccountLandingZoneSetup\"\n  \
    \  session_expiration = 999\n  }\n}\n\nprovider \"alicloud\" {\n  alias = \"network_role\"\
    \n  region = \"cn-shanghai\"\n  assume_role {\n    role_arn           = format(\"\
    acs:ram::%s:role/ResourceDirectoryAccountAccessRole\", local.account_id)\n   \
    \ session_name       = \"AccountLandingZoneSetup\"\n    session_expiration = 999\n\
    \  }\n}\n\nresource \"time_sleep\" \"wait\" {\n  create_duration = \"10s\"\n \
    \ triggers = {\n    account_id = local.account_id\n  }\n}\n\nmodule \"auth_create_idp\"\
    \ {\n  source = \"./auth-create-idp\"\n  depends_on = [time_sleep.wait]\n\n  sso_provider_name\
    \ = \"idp\"\n  metadata = local.idp_metadata\n}\n\nmodule \"auth_create_user\"\
    \ {\n  source = \"./auth-create-user\"\n  depends_on = [time_sleep.wait]\n\n \
    \ user_name = local.user_name\n}\n\nmodule \"auth_create_role\" {\n  source =\
    \ \"./auth-create-role\"\n  depends_on = [time_sleep.wait]\n\n  sso_provider_name\
    \ = \"idp\"\n  ram_roles = {\n    \"roles\" = [\n      {\n        \"role_name\"\
    \   = \"admin\"\n        \"description\" = \"Administrator role for member accounts\"\
    \n      },\n      {\n        \"role_name\"   = \"reader\"\n        \"description\"\
    \ = \"Reader role for member accounts\"\n      }\n    ]\n  }\n  account_id = local.account_id\n\
    }\n\nmodule \"auth_authorize_role\" {\n  source = \"./auth-authorize-role\"\n\
    \  depends_on = [module.auth_create_user, module.auth_create_role]\n\n  policy_name\
    \ = \"AliyunContributor\"\n  policy_document = <<EOF\n  {\n    \"Version\": \"\
    1\",\n    \"Statement\": [\n      {\n        \"Action\": [\n          \"RAM:*\"\
    \n        ],\n        \"Resource\": [\n          \"*\"\n        ],\n        \"\
    Effect\": \"Deny\"\n      },\n      {\n        \"Action\": [\n          \"*\"\n\
    \        ],\n        \"Resource\": [\n          \"*\"\n        ],\n        \"\
    Effect\": \"Allow\"\n      }\n    ]\n  }\n  EOF\n  attach_roles = [\"admin\"]\n\
    \  attach_users = [local.user_name]\n  reader_name = \"reader\"\n  reader_policy_type\
    \ = \"System\"\n  reader_policy_name = \"AliyunLogReadOnlyAccess\"\n}\n\nmodule\
    \ \"network_create_vpc_vsw\" {\n  source = \"./network-create-vpc-vsw\"\n  providers\
    \ = {\n    alicloud = alicloud.network_role\n  }\n  depends_on = [time_sleep.wait]\n\
    \n  vpc_name = \"autovpc1\"\n  vpc_cidr_block = \"172.16.0.0/12\"\n  switch_cidr_block\
    \ = \"172.16.0.0/21\"\n  vswitch_name = \"autovsw1\"\n  zone_id = \"cn-shanghai-b\"\
    \n}"
  modules/account-deploy/network-create-vpc-vsw/main.tf: "terraform {\n  required_providers\
    \ {\n    alicloud = {\n      source = \"hashicorp/alicloud\"\n    }\n  }\n}\n\n\
    locals {\n  vpc_name = var.vpc_name\n  vpc_cidr_block = var.vpc_cidr_block\n \
    \ switch_cidr_block = var.switch_cidr_block\n  vswitch_name = var.vswitch_name\n\
    \  zone_id = var.zone_id\n}\n\nmodule \"network_config\" {\n  source = \"./network\"\
    \n\n  vpc_name = local.vpc_name\n  vpc_cidr_block = local.vpc_cidr_block\n  vswitch_name\
    \ = local.vswitch_name\n  switch_cidr_block = local.switch_cidr_block\n  zone_id\
    \ = local.zone_id\n}"
  modules/account-deploy/network-create-vpc-vsw/network/main.tf: "resource \"alicloud_vpc\"\
    \ \"vpc\" {\n  vpc_name   = var.vpc_name\n  cidr_block = var.vpc_cidr_block\n\
    }\n\nresource \"alicloud_vswitch\" \"vsw\" {\n  vpc_id            = alicloud_vpc.vpc.id\n\
    \  vswitch_name      = var.vswitch_name\n  cidr_block        = var.switch_cidr_block\n\
    \  zone_id           = var.zone_id\n}"
  modules/account-deploy/network-create-vpc-vsw/network/outputs.tf: "output \"vpc_id\"\
    \ {\n  value = alicloud_vpc.vpc.id\n}\n\noutput \"vswitch_id\" {\n  value = alicloud_vswitch.vsw.id\n\
    }"
  modules/account-deploy/network-create-vpc-vsw/network/variables.tf: 'variable "vpc_name"
    {}


    variable "vpc_cidr_block" {}


    variable "vswitch_name" {}


    variable "switch_cidr_block" {}


    variable "zone_id" {}'
  modules/account-deploy/network-create-vpc-vsw/outputs.tf: "output \"vpc_id\" {\n\
    \  value = module.network_config.vpc_id\n}\n\noutput \"vswitch_id\" {\n  value\
    \ = module.network_config.vswitch_id\n}"
  modules/account-deploy/network-create-vpc-vsw/variables.tf: 'variable "vpc_name"
    {}


    variable "vpc_cidr_block" {}


    variable "switch_cidr_block" {}


    variable "vswitch_name" {}


    variable "zone_id" {}'
  modules/account-deploy/outputs.tf: "output \"vpc_id\" {\n  value = module.network_create_vpc_vsw.vpc_id\n\
    }\n\noutput \"vswitch_id\" {\n  value = module.network_create_vpc_vsw.vswitch_id\n\
    }"
  modules/account-deploy/variables.tf: 'variable "idp_metadata" {}


    variable "account_id" {}'
  outputs.tf: "output \"account_id\" {\n  value = module.account_create.account_id\n\
    \  description = <<EOF\n  {\n    \"AssociationProperty\": \"ALIYUN::ResourceManager::Folder\"\
    ,\n    \"Description\": {\n      \"en\": \"ID of resource account created in Resource\
    \ Directory.\",\n      \"zh-cn\": \"资源目录中创建的资源账号的ID。\"\n    }\n  }\n  EOF\n}\n\
    \noutput \"vpc_id\" {\n  value = module.account_deploy.vpc_id\n  description =\
    \ <<EOF\n  {\n    \"AssociationProperty\": \"ALIYUN::ResourceManager::Folder\"\
    ,\n    \"Description\": {\n      \"en\": \"ID of VPC created in resource account.\"\
    ,\n      \"zh-cn\": \"资源账号中创建的VPC的ID。\"\n    }\n  }\n  EOF\n}\n\noutput \"vswitch_id\"\
    \ {\n  value = module.account_deploy.vswitch_id\n  description = <<EOF\n  {\n\
    \    \"AssociationProperty\": \"ALIYUN::ResourceManager::Folder\",\n    \"Description\"\
    : {\n      \"en\": \"ID of VSwitch created in resource account.\",\n      \"zh-cn\"\
    : \"资源账号创建的VSwitch的ID。\"\n    }\n  }\n  EOF\n}"
  variables.tf: "variable \"folder_ids\" {\n  type = list(string)\n  description =\
    \ <<EOF\n  {\n    \"Type\": \"Json\",\n    \"Label\": {\n      \"en\": \"Folder\
    \ ID\",\n      \"zh-cn\": \"资源夹ID\"\n    },\n    \"Description\": {\n      \"\
    en\": \"Folder of Resource Directory in which to create a resource account.\"\
    ,\n      \"zh-cn\": \"要在其中创建资源账号的资源目录的资源夹。\"\n    },\n    \"AssociationProperty\"\
    : \"ALIYUN::ResourceManager::Folder\",\n    \"MinLength\": 1,\n    \"MaxLength\"\
    : 1\n  }\n  EOF\n}\n\nvariable \"idp_metadata\" {\n  type = string\n  default\
    \ = <<-EOF\n  <?xml version=\"1.0\" encoding=\"UTF-8\"?><md:EntityDescriptor xmlns:md=\"\
    urn:oasis:names:tc:SAML:2.0:metadata\" ID=\"SIMELg4ew1fqqUq3Wtug2atgLF1b8Cz5dhsF\"\
    \ entityID=\"https://qulkokcn.aliyunidaas.com/api/v2/app_msthbzqwwwzsijtwxsfcmvdvzy/saml2/meta\"\
    \ validUntil=\"2123-07-06T07:44:38.640Z\">\n  <md:IDPSSODescriptor protocolSupportEnumeration=\"\
    urn:oasis:names:tc:SAML:2.0:protocol\">\n  <md:KeyDescriptor use=\"signing\">\n\
    \  <ds:KeyInfo xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\">\n  <ds:X509Data>\n\
    \  <ds:X509Certificate>MIIEFTCCAv2gAwIBAgISCYYAsS9tZ7Muu0/fHvCbyJbUMA0GCSqGSIb3DQEBCwUAMIGSMScwJQYDVQQDDB5hcHBfbXN0aGJ6cXd3d3pzaWp0d3hzZmNtdmR2enkxKTAnBgNVBAsMIGlkYWFzX2hqbnZ1eWxzeG9nbjc1Z25tNjJicHdraG1pMRwwGgYDVQQKDBNBbGliYWJhIENsb3VkIElEYWFTMREwDwYDVQQIDAhaaGVqaWFuZzELMAkGA1UEBhMCQ04wHhcNMjMwNzA1MTYwMDAwWhcNMzMwNzA1MTYwMDAwWjCBkjEnMCUGA1UEAwweYXBwX21zdGhienF3d3d6c2lqdHd4c2ZjbXZkdnp5MSkwJwYDVQQLDCBpZGFhc19oam52dXlsc3hvZ243NWdubTYyYnB3a2htaTEcMBoGA1UECgwTQWxpYmFiYSBDbG91ZCBJRGFhUzERMA8GA1UECAwIWmhlamlhbmcxCzAJBgNVBAYTAkNOMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsG58tm1xxcrU0K5qZL5Rn+M7EHZLdmP0D5mVPJlK3je9wx6xBT/zyFffDUE/GNvtRevmjjmvhwazojhXGYaa05y+fS9mplIk8dBK7E397QG4IaKlH6FrZiN4pRne89pIts6jAixk+349yXMlkA+EfToj3XuyVkOauqdXcz7NNW/mqrUx306SjF7BUpygXh/EGsu0LonJfiqLGKDbuuetZcx+NrRXa1Qw7gwFV0PlwCkQXp7TorTa1sNWFdxYNCED5lMAhcfDqBsTFExwLoymPxzVBTw4IV1DNpHdzUQ9QouCoZ4+lnbXwSZTQ6jkIFEq3eUnDdb4M/kEAv3RcCYoxQIDAQABo2MwYTAOBgNVHQ8BAf8EBAMCAQYwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQUovCEbjoAeeEV8DMfyfGrYOb0yAEwHwYDVR0jBBgwFoAUovCEbjoAeeEV8DMfyfGrYOb0yAEwDQYJKoZIhvcNAQELBQADggEBABHQ+NqVONzEOvDIVvg+XgrF5hjdGeoGGUqPBIqziPWxDQ6KCQMYlAsCV0xSGtigC3xoVtqHxC0yJIw3E6HsHPbn34uKk0Bs895wBrXuvv/tFCPVOYJukVrvY/I1iEBc8mbXr30jUe+EDZujXeE7m86MQEmDBG4HuB66Myax9feVZnnq0t6j4l09n3/BozSuhAFi9L4oUgYEIUFaUFVSL+KhNiFnHiqFZugXdsEoC69dPykrhl4eWgps+bfdK29bICZJ7FrOLS085b4TWnKbMWHZX9fSkNuWX9HXFCYiWSMAVT4AlUuvtv1gmz1TUX1gEvOaFpdJ20p3GN4r5fvOVxA=</ds:X509Certificate>\n\
    \  </ds:X509Data>\n  </ds:KeyInfo>\n  </md:KeyDescriptor>\n  <md:NameIDFormat>urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified</md:NameIDFormat>\n\
    \  <md:NameIDFormat>urn:oasis:names:tc:SAML:2.0:nameid-format:persistent</md:NameIDFormat>\n\
    \  <md:NameIDFormat>urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress</md:NameIDFormat>\n\
    \  <md:SingleSignOnService Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST\"\
    \ Location=\"https://qulkokcn.aliyunidaas.com/login/app/app_msthbzqwwwzsijtwxsfcmvdvzy/saml2/sso\"\
    />\n  <md:SingleSignOnService Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect\"\
    \ Location=\"https://qulkokcn.aliyunidaas.com/login/app/app_msthbzqwwwzsijtwxsfcmvdvzy/saml2/sso\"\
    />\n  </md:IDPSSODescriptor>\n  </md:EntityDescriptor>\n  EOF\n  description =\
    \ <<EOF\n  {\n    \"Label\": {\n      \"en\": \"IdP Metadata File\",\n      \"\
    zh-cn\": \"身份提供商（IdP）元数据文件\"\n    },\n    \"TextArea\": true\n  }\n  EOF\n}\n\n\
    variable \"ALIYUN__StackId\" {\n  type = string\n}"
