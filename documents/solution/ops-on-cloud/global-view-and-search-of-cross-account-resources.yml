ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 创建资源管理目录、账户，配置VPC、子网、安全组，实现跨账号资源部署及自动服务启用。
  en: Create resource management directories, accounts, configure VPCs, subnets, security
    groups, facilitate cross-account resource deployment, and enable automatic service
    provisioning.
Parameters:
  ZoneId:
    Type: String
    Label:
      en: VSwitch Available Zone
      zh-cn: 可用区
    AssociationProperty: ALIYUN::VPC::Zone::ZoneId
    AssociationPropertyMetadata:
      AutoSelectFirst: true
  FolderName:
    Type: String
    Label:
      zh-cn: 资源目录名称
      en: Resource directory folder name
    AssociationProperty: AutoCompleteInput
    AssociationPropertyMetadata:
      Length: 5
      Prefix: ros-folder-
      CharacterClasses:
        - Class: lowercase
  AccountDisplayName:
    Type: String
    AssociationProperty: AutoCompleteInput
    AssociationPropertyMetadata:
      Length: 5
      Prefix: account-for-search-
      CharacterClasses:
        - Class: lowercase
Resources:
  RDFolder:
    Type: ALIYUN::ResourceManager::Folder
    Properties:
      FolderName:
        Ref: FolderName
  RDAccount1:
    Type: ALIYUN::ResourceManager::Account
    Properties:
      DeleteAccount: true
      DisplayName:
        'Fn::Sub': '${AccountDisplayName}-1'
      FolderId:
        Fn::GetAtt:
          - RDFolder
          - FolderId
  RDAccount2:
    Type: ALIYUN::ResourceManager::Account
    Properties:
      DeleteAccount: true
      DisplayName:
        'Fn::Sub': '${AccountDisplayName}-2'
      FolderId:
        Fn::GetAtt:
          - RDFolder
          - FolderId
  AutoEnableTrustedRos:
    Type: ALIYUN::ROS::AutoEnableService
    Properties:
      ServiceName: 'TrustedService/ROS'
  StackGroup:
    Type: ALIYUN::ROS::StackGroup
    DependsOn: AutoEnableTrustedRos
    Properties:
      StackGroupName: ros-test-stack-group
      PermissionModel: SERVICE_MANAGED
      AutoDeployment:
        Enabled: false
      Parameters:
        ZoneId:
          Ref: ZoneId
      TemplateBody:
        ROSTemplateFormatVersion: '2015-09-01'
        Parameters:
          CommonName:
            Type: String
            Default: for-search
          ZoneId:
            Type: String
        Resources:
          EcsVpc:
            Type: 'ALIYUN::ECS::VPC'
            Properties:
              VpcName:
                'Fn::Sub': 'vpc-${CommonName}-${ALIYUN::TenantId}'
              CidrBlock: 192.168.0.0/16
          EcsVSwitch:
            Type: 'ALIYUN::ECS::VSwitch'
            Properties:
              ZoneId:
                Ref: ZoneId
              VpcId:
                Ref: EcsVpc
              VSwitchName:
                'Fn::Sub': 'vsw-${CommonName}-${ALIYUN::TenantId}'
              CidrBlock: 192.168.0.0/24
          EcsSecurityGroup:
            Type: 'ALIYUN::ECS::SecurityGroup'
            Properties:
              VpcId:
                Ref: EcsVpc
              SecurityGroupName:
                'Fn::Sub': 'sg-${CommonName}-${ALIYUN::TenantId}'
              SecurityGroupIngress:
                - PortRange: 80/80
                  Priority: 1
                  SourceCidrIp: 0.0.0.0/0
                  IpProtocol: tcp
                  NicType: internet
  StackGroupInstances:
    Type: ALIYUN::ROS::StackInstances
    DependsOn:
      - RDAccount1
      - RDAccount2
    Properties:
      StackGroupName:
        Ref: StackGroup
      RegionIds:
        - Ref: ALIYUN::Region
      DeploymentTargets:
        RdFolderIds:
          - Ref: RDFolder
      ParameterOverrides:
        ZoneId:
          Ref: ZoneId
      RetainStacks: false
      OperationPreferences:
        MaxConcurrentCount: 2
Metadata:
  'ALIYUN::ROS::Interface':
    ParameterGroups:
      - Parameters:
          - FolderName
          - AccountDisplayName
          - ZoneId
    TemplateTags:
      - 'acs:technical-solution:ops-on-cloud:跨账号资源全局视图及搜索-tech_solu_70'
    Hidden:
      - CommonName
  ALIYUN::ROS::Composer:
    bf76e67e:
      Rect:
        - 372
        - 342
        - 40
        - 60
        - 1
        - 0
      ResT: Composer::ROSParameter::AlibabaCloud
    7daa844c:
      Parent: bf76e67e
      Rect:
        - 296
        - 269
        - 60
        - 100
        - 2
        - 0
      ResT: Composer::ROSParameter::Region
    1c4c5c27:
      Res:
        - RDFolder
      Parent: 7daa844c
      Rect:
        - 40
        - 40
        - 270
        - 163
        - 3
        - 0
    0b5820ba:
      Res:
        - RDAccount1
      Parent: 7daa844c
      Rect:
        - 40
        - 40
        - 120
        - 140
        - 3
        - 0
    5b9bbd75:
      Res:
        - RDAccount2
      Parent: 7daa844c
      Rect:
        - 40
        - 40
        - 120
        - 215
        - 3
        - 0
    8da697b7:
      Res:
        - AutoEnableTrustedRos
      Parent: 7daa844c
      Rect:
        - 40
        - 40
        - 80
        - 260
        - 3
        - 0
      Hidden: true
    c19916db:
      Res:
        - StackGroup
      Parent: 7daa844c
      Rect:
        - 40
        - 40
        - 120
        - 282
        - 3
        - 0
    3f55f64a:
      Res:
        - StackGroupInstances
      Parent: 7daa844c
      Rect:
        - 40
        - 40
        - 270
        - 282
        - 3
        - 0
    bf4c8505:
      Parent: 7daa844c
      Edge:
        - 0b5820ba
        - 1c4c5c27
      Line: 0:0:0:gray:0
    453ce3a6:
      Parent: 7daa844c
      Edge:
        - 5b9bbd75
        - 1c4c5c27
      Line: 0:0:0:gray:0
    494ee7f6:
      Parent: 7daa844c
      Edge:
        - 3f55f64a
        - c19916db
      Line: 0:0:0:gray:0
    e10b31b0:
      Parent: 7daa844c
      Edge:
        - 3f55f64a
        - 1c4c5c27
      Line: 0:0:0:gray:0
