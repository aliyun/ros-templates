ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 创建ECS与RDS实例，配置安全组与网络，自建MySQL数据库，准备迁移至RDS MySQL 8.0。
  en: Create ECS and RDS instances, configure security groups and networking, and prepare for migration to RDS MySQL 8.0.
Parameters:
  Zone:
    AssociationProperty: ALIYUN::ECS::Instance::ZoneId
    Type: String
    Description:
      zh-cn: 用于创建ECS和RDS的可用区。
      en: Availability zone.
    Label:
      zh-cn: 可用区
      en: Availability Zone.
  EcsInstanceType:
    Type: String
    Description:
      zh-cn: 自建数据库的ECS实例类型。
      en: ECS instance on-premises database.
    Label:
      zh-cn: ECS实例类型
      en: ECS instance type.
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      SystemDiskCategory: cloud_essd
      InstanceChargeType: PostPaid
      ZoneId: ${Zone}
    Default: ecs.e-c1m1.large
  InstancePassword:
    Type: String
    Description:
      en: >-
        Server login password, Length 8-30, must contain three(Capital letters,
        lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special
        symbol in)
      zh-cn: >-
        服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/
        中的特殊符号）
    Label:
      en: ECS Instance Password
      zh-cn: ECS 实例密码
    ConstraintDescription:
      en: >-
        Length 8-30, must contain three(Capital letters, lowercase letters,
        numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in)
      zh-cn: '长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;''<>,.?/ 中的特殊符号）'
    AssociationProperty: 'ALIYUN::ECS::Instance::Password'
  DBInstanceEngineAndVersion:
    Type: String
    Description:
      zh-cn: 数据库引擎类型及版本，默认为MySQL 8.0
      en: 'Database instance engine type and version, default: MySQL 8.0'
    Label:
      zh-cn: 引擎类型及版本
      en: Engine And Version
    Default: MySQL 8.0
    AllowedValues:
      - MySQL 8.0
  DBInstanceClass:
    Type: String
    Description: '在模拟数据迁移体验中，您可以选择最小规格的数据库实例作为迁移目标实例，以减少成本。在生产环境中选择迁移目标实例，需要确保其规格满足您的业务需求。关于RDS实例规格详情，请参考：<a href="https://help.aliyun.com/zh/rds/apsaradb-rds-for-mysql/specifications-2" target="blank">云数据库RDS MySQL产品规格。</a>'
    Label:
      en: Target RDS Instance Class
      zh-cn: 迁移目标RDS实例规格
    AssociationProperty: ALIYUN::RDS::Instance::InstanceType
    AssociationPropertyMetadata:
      ZoneId:
        Ref: Zone
      EngineVersion: '8.0'
      DBInstanceStorageType: cloud_essd
      Engine: MySQL
      Category: Basic
      CommodityCode: bards
    Default: mysql.n2e.small.1
  RDSUserDTSUsername:
    Type: String
    ConstraintDescription:
      en: Consist of 2 to 16 characters of lowercase letters, underline. Must begin with a letter and be end with an alphanumeric character
      zh-cn: 由 2 到 16 个小写字母组成，下划线。必须以字母开头，以字母数字字符结尾
    Label:
      zh-cn: RDS数据库账号
      en: RDS DB Username
    Default: dbuser
    MaxLength: 16
    MinLength: 2
  RDSUserDTSPassword:
    Type: String
    NoEcho: true
    Label:
      zh-cn: RDS数据库密码
      en: RDS database password
    AssociationProperty: 'ALIYUN::RDS::Instance::AccountPassword'
  WPUserForSQLUsername:
    Type: String
    ConstraintDescription:
      en: Consist of 2 to 16 characters of lowercase letters, underline. Must begin with a letter and be end with an alphanumeric character
      zh-cn: 由 2 到 16 个小写字母组成，下划线。必须以字母开头，以字母数字字符结尾
    Label:
      zh-cn: ECS 自建 MySQL 数据库账号 (SQL)
      en: ECS builds its own MySQL database account (SQL)
    Description:
      zh-cn: ECS 自建 MySQL 数据库账号，该账号用于数据库 SQL 操作。
      en: ECS creates its own MySQL database account, which is used for database SQL operations.
    Default: dbuser
    MaxLength: 16
    MinLength: 2
  WPUserForSQLPassword:
    Type: String
    Label:
      zh-cn: ECS 自建 MySQL 数据库密码 (SQL)
      en: ECS builds its own MySQL database password (SQL)
    AllowedPattern: ^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=]).{8,32}$
    NoEcho: true
    Description:
      en: |-
        The password must be 8 to 32 characters in length. <br>
        It must contain the following character types: uppercase letters, lowercase letters, digits, and special characters. <br> 
        Special characters include <span style="background:#E7E9EB;"><b>!@#$%^&*()_+-=</b></span>.<br>
        <b>If you repeatedly provision in this tutorial on the same ECS instance, make sure that the MySQL database password is exactly the same as the password set when the template was executed for the first time. Otherwise, the result of provisioning is unavailable.</b>
      zh-cn: |-
        长度为8~32位，需包含大写字母、小写字母、特殊字符和数字，允许的特殊字符包括<span style="background:#E7E9EB;"><b>!@#$%^&*()_+-=</b></span>。
    ConstraintDescription:
      en: |-
        The password must be 8 to 32 characters in length. <br>
        It must contain the following character types: uppercase letters, lowercase letters, digits, and special characters. <br> 
        Special characters include <span style="background:#E7E9EB;"><b>!@#$%^&*()_+-=</b></span>.<br>
        <b>If you repeatedly provision in this tutorial on the same ECS instance, make sure that the MySQL database password is exactly the same as the password set when the template was executed for the first time. Otherwise, the result of provisioning is unavailable.</b>
      zh-cn: 长度为8~32位，需包含四项大写字母、小写字母、特殊字符和数字，允许的特殊字符包括<span style="background:#E7E9EB;"><b>!@#$%^&*()_+-=</b></span>。
Resources:
  RosWaitCondition:
    Type: ALIYUN::ROS::WaitCondition
    Properties:
      Count: 1
      Handle:
        Ref: RosWaitConditionHandle
      Timeout: 3600
  RosWaitConditionHandle:
    Type: ALIYUN::ROS::WaitConditionHandle
  VSwitch:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      CidrBlock: 192.168.0.0/24
      ZoneId:
        Ref: Zone
      VpcId:
        Fn::GetAtt:
          - Vpc
          - VpcId
  Vpc:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock: 192.168.0.0/16
      VpcName: database-migration-test
  SecurityGroup:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      SecurityGroupName: SG-DTS-GROUP-20220101
      VpcId:
        Fn::GetAtt:
          - Vpc
          - VpcId
  Database:
    Type: ALIYUN::RDS::DBInstance
    Properties:
      DBInstanceClass:
        Ref: DBInstanceClass
      ZoneId:
        Ref: Zone
      DBInstanceDescription: mysqltords
      DBInstanceStorage: 20
      Category: Basic
      DBInstanceStorageType: cloud_essd
      VSwitchId:
        Ref: VSwitch
      Engine: MySQL
      VpcId:
        Ref: Vpc
      SlaveZoneIds:
        - Auto
      EngineVersion: '8.0'
      SecurityIPList:
        Fn::GetAtt:
          - WebServer
          - PrivateIp
      MasterUsername:
        Ref: RDSUserDTSUsername
      MasterUserPassword:
        Ref: RDSUserDTSPassword
      MasterUserType: Super
  SecurityGroupIngress:
    Type: ALIYUN::ECS::SecurityGroupIngress
    Properties:
      SourceCidrIp: 0.0.0.0/0
      SecurityGroupId:
        Ref: SecurityGroup
      IpProtocol: all
      PortRange: '-1/-1'
  WebServer:
    Type: ALIYUN::ECS::Instance
    Properties:
      IoOptimized: optimized
      ImageId: aliyun_3_x64_20G_alibase_
      SecurityGroupId:
        Ref: SecurityGroup
      Password:
        Ref: InstancePassword
      InternetMaxBandwidthOut: 80
      VSwitchId:
        Ref: VSwitch
      VpcId:
        Ref: Vpc
      InstanceType:
        Ref: EcsInstanceType
      SystemDiskCategory: cloud_essd
      AllocatePublicIP: true
      ZoneId:
        Ref: Zone
  RunCommand:
    Type: ALIYUN::ECS::RunCommand
    Properties:
      InstanceIds:
        - Ref: WebServer
      Type: RunShellScript
      Sync: true
      Timeout: 3600
      CommandContent:
        Fn::Sub: |-
          #!/bin/bash
          cat << EOF >> ~/.bash_profile
          export MYSQL_USER=${WPUserForSQLUsername}
          export MYSQL_PWD=${WPUserForSQLPassword}
          export ROS_DEPLOY=true
          EOF
          source ~/.bash_profile
          curl -fsSL https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/install-script/mysql-rds/install.sh|sh
          ${RosWaitConditionHandle.CurlCli} --data-binary '{"status": "SUCCESS"}'
    DependsOn:
      - SecurityGroupIngress
  DtsInstance:
    Type: ALIYUN::DTS::Instance
    Properties:
      JobId:
        Fn::GetAtt:
          - MigrationJob
          - DtsJobId
      InstanceClass: micro
      PayType: PostPaid
      AutoStart: false
      Type: SYNC
      SourceRegion:
        Ref: ALIYUN::Region
      DestinationRegion:
        Ref: ALIYUN::Region
      SourceEndpointEngineName: MySQL
      DestinationEndpointEngineName: MySQL
  MigrationJob:
    Type: ALIYUN::DTS::SynchronizationJob2
    Properties:
      DtsJobName: ecs_mysql_2_cloud_dts
      SourceEndpoint:
        InstanceType: ECS
        InstanceID:
          Ref: WebServer
        EngineName: MYSQL
        Port: '3306'
        Region:
          Ref: ALIYUN::Region
        UserName:
          Ref: WPUserForSQLUsername
        Password:
          Ref: WPUserForSQLPassword
      DestinationEndpoint:
        InstanceType: RDS
        InstanceID:
          Ref: Database
        EngineName: MYSQL
        Region:
          Ref: ALIYUN::Region
        UserName:
          Ref: RDSUserDTSUsername
        Password:
          Ref: RDSUserDTSPassword
      StructureInitialization: true
      DataInitialization: true
      DataSynchronization: true
      DataCheckConfigure:
        fullCheckRatio: 100
        incrementalDataCheck: true
        fullCheckValidFailNotice: false
        fullCheckReferEndpoint: all
        incrementalCheckDelayNotice: false
        fullCheckFixData: false
        fullCheckModel: 1
        fullCheckErrorNotice: false
        fullDataCheck: true
        fullCheckNoticeValue: 1
        incrementalCheckValidFailNotice: false
        incrementalCheckErrorNotice: false
        dataCheckDbList: '{"dtstestdb":{"name":"dtstestdb","all":true}}'
      DbList:
        dtstestdb:
          name: dtstestdb
          all: true
Outputs:
  ECSInstanceUsername:
    Description:
      en: ECS instance login account.
      zh-cn: ECS 实例登录账号。
    Value: root
  ECSInstancePassword:
    Description:
      en: Login password for the ECS instance..
      zh-cn: ECS 实例登录密码。
    NoEcho: true
    Value:
      Ref: InstancePassword
  WPUserForSQLUsername:
    Description:
      en: ECS builds its own MySQL database account, which is used for SQL operations in the database.
      zh-cn: ECS 自建 MySQL 数据库账号，该账号用于数据库 SQL 操作。
    Value:
      Ref: WPUserForSQLUsername
  WPUserForSQLPassword:
    Description:
      en: ECS builds its own MySQL database account password, which is used for SQL operations in the database.
      zh-cn: ECS 自建 MySQL 数据库账号密码，该账号用于数据库 SQL 操作。
    NoEcho: true
    Value:
      Ref: WPUserForSQLPassword
  RDSUserDTSUsername:
    Description:
      en: High-privilege account for RDS database.
      zh-cn: RDS 数据库高权限账号。
    Value:
      Ref: RDSUserDTSUsername
  RDSUserDTSPassword:
    Description:
      en: High-privilege account password for RDS database.
      zh-cn: RDS 数据库高权限账号密码。
    NoEcho: true
    Value:
      Ref: RDSUserDTSPassword
  RDSInternalAddress:
    Description:
      en: The internal network connection address of the RDS instance.
      zh-cn: RDS 实例内网连接地址。
    Value:
      Fn::GetAtt:
        - Database
        - InnerConnectionString
  DTSInstanceAddress:
    Description:
      en: DTS Sync task address.
      zh-cn: DTS同步任务访问地址。
    Value:
      'Fn::Sub':
        - 'https://dtsnew.console.aliyun.com/sync/detail/manager/${MigrationJob}?regionId=${Region}'
        - MigrationJob:
            Fn::GetAtt:
              - MigrationJob
              - DtsJobId
          Region:
            Ref: ALIYUN::Region
  RDSInstanceAddress:
    Description:
      en: RDS Instance address.
      zh-cn: RDS实例访问地址。
    Value:
      Fn::Sub: https://rdsnext.console.aliyun.com/detail/${Database}/basicInfo?region=${ALIYUN::Region}
  EcsLoginAddress:
    Description:
      en: Ecs login address.
      zh-cn: ECS登录地址。
    Value:
      Fn::Sub: https://ecs-workbench.aliyun.com/?from=EcsConsole&instanceType=ecs&regionId=${ALIYUN::Region}&instanceId=${WebServer}
Metadata:
  ALIYUN::ROS::Interface:
    Outputs:
      - ECSInstanceUsername
      - ECSInstancePassword
      - WPUserForSQLUsername
      - WPUserForSQLPassword
      - RDSUserDTSUsername
      - RDSUserDTSPassword
      - RDSInternalAddress
    ParameterGroups:
      - Parameters:
          - EcsInstanceType
          - InstancePassword
          - WPUserForSQLUsername
          - WPUserForSQLPassword
        Label:
          default: ECS
      - Parameters:
          - DBInstanceEngineAndVersion
          - DBInstanceClass
          - RDSUserDTSUsername
          - RDSUserDTSPassword
        Label:
          default: RDS
    TemplateTags:
      - acs:technical-solution:database:自建数据库迁移到云数据库-tech_solu_112
  ALIYUN::ROS::Composer:
    '34727653':
      Res:
        - VSwitch
      Parent: 35402af3
      Rect:
        - 400
        - 200
        - 240
        - 300
        - 5
        - 0
    b7d6960a:
      Rect:
        - 815
        - 602
        - 40
        - 80
        - 1
        - 0
      ResT: Composer::ROSParameter::AlibabaCloud
    afa6b141:
      Parent: b7d6960a
      Rect:
        - 754
        - 534
        - 60
        - 120
        - 2
        - 0
      ResT: Composer::ROSParameter::Region
    6abd97cd:
      Res:
        - RosWaitCondition
      Parent: afa6b141
      Rect:
        - 40
        - 40
        - 320
        - 560
        - 3
        - 0
    2c041fd0:
      Res:
        - RosWaitConditionHandle
      Parent: afa6b141
      Rect:
        - 40
        - 40
        - 452
        - 560
        - 3
        - 0
    520dd1f3:
      Res:
        - Vpc
      Parent: afa6b141
      Rect:
        - 487
        - 383
        - 200
        - 160
        - 3
        - 0
    455ea1e7:
      Res:
        - RunCommand
      Parent: afa6b141
      Rect:
        - 40
        - 40
        - 125
        - 390
        - 3
        - 0
    19a061fb:
      Res:
        - SecurityGroupIngress
      Parent: afa6b141
      Rect:
        - 40
        - 40
        - 745
        - 350
        - 3
        - 0
    35402af3:
      Res:
        - Zone
      Parent: 520dd1f3
      Rect:
        - 440
        - 270
        - 220
        - 250
        - 4
        - 0
      ResT: Composer::ROSParameter::Zone
    65b719fd:
      Res:
        - SecurityGroup
      Parent: 520dd1f3
      Rect:
        - 455
        - 315
        - 216
        - 212
        - 10
        - 0
    2a615dbe:
      Parent: afa6b141
      Edge:
        - 6abd97cd
        - 2c041fd0
      Line: 0:0:0:gray:0
    387f6f5d:
      Parent: '34727653'
      Edge:
        - b6edc058
        - f0baedae
      Line: 0:0:0:gray:0
    90756bef:
      Parent: afa6b141
      Edge:
        - 19a061fb
        - 65b719fd
      Line: 0:0:0:gray:0
    e99e0aa4:
      Parent: afa6b141
      Edge:
        - 455ea1e7
        - f0baedae
      Line: 0:0:0:gray:0
    f0baedae:
      Res:
        - WebServer
      Parent: '34727653'
      Rect:
        - 40
        - 40
        - 337
        - 390
        - 11
        - 0
      Layer:
        - 65b719fd
    b6edc058:
      Res:
        - Database
      Parent: '34727653'
      Rect:
        - 40
        - 40
        - 475
        - 390
        - 11
        - 0
      Layer:
        - 65b719fd
