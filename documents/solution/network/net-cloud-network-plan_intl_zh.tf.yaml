ROSTemplateFormatVersion: '2015-09-01'
Transform: Aliyun::Terraform-v1.5
Workspace:
  main.tf: |-
    provider "alicloud" {
      region = "ap-southeast-1"
    }

    # VPC resources
    resource "alicloud_vpc" "vpc_prd1" {
      vpc_name = "VPC_PRD1"
      cidr_block = "10.1.0.0/16"
    }

    resource "alicloud_vpc" "vpc_prd2" {
      vpc_name = "VPC_PRD2"
      cidr_block = "10.2.0.0/16"
    }

    resource "alicloud_vpc" "vpc_prd3" {
      vpc_name = "VPC_PRD3"
      cidr_block = "10.3.0.0/16"
    }

    resource "alicloud_vpc" "vpc_sec" {
      vpc_name = "VPC_SEC"
      cidr_block = "172.16.0.0/16"
    }

    # VSwitch resources
    resource "alicloud_vswitch" "vswitch_prd1_001" {
      vpc_id = alicloud_vpc.vpc_prd1.id
      zone_id = var.zone1
      vswitch_name = "vsw_prd1_001"
      cidr_block = "10.1.1.0/24"
    }

    resource "alicloud_vswitch" "vswitch_prd1_002" {
      vpc_id = alicloud_vpc.vpc_prd1.id
      zone_id = var.zone2
      vswitch_name = "vsw_prd1_002"
      cidr_block = "10.1.2.0/24"
    }

    resource "alicloud_vswitch" "vswitch_prd1_003" {
      vpc_id = alicloud_vpc.vpc_prd1.id
      zone_id = var.zone1
      vswitch_name = "vsw_prd1_003"
      cidr_block = "10.1.3.0/24"
    }

    resource "alicloud_vswitch" "vswitch_prd2_001" {
      vpc_id = alicloud_vpc.vpc_prd2.id
      zone_id = var.zone1
      vswitch_name = "vsw_prd2_001"
      cidr_block = "10.2.1.0/24"
    }

    resource "alicloud_vswitch" "vswitch_prd2_002" {
      vpc_id = alicloud_vpc.vpc_prd2.id
      zone_id = var.zone2
      vswitch_name = "vsw_prd2_002"
      cidr_block = "10.2.2.0/24"
    }

    resource "alicloud_vswitch" "vswitch_prd2_003" {
      vpc_id = alicloud_vpc.vpc_prd2.id
      zone_id = var.zone1
      vswitch_name = "vsw_prd2_003"
      cidr_block = "10.2.3.0/24"
    }

    resource "alicloud_vswitch" "vswitch_prd3_001" {
      vpc_id = alicloud_vpc.vpc_prd3.id
      zone_id = var.zone1
      vswitch_name = "vsw_prd3_001"
      cidr_block = "10.3.1.0/24"
    }

    resource "alicloud_vswitch" "vswitch_prd3_002" {
      vpc_id = alicloud_vpc.vpc_prd3.id
      zone_id = var.zone2
      vswitch_name = "vsw_prd3_002"
      cidr_block = "10.3.2.0/24"
    }

    resource "alicloud_vswitch" "vswitch_prd3_003" {
      vpc_id = alicloud_vpc.vpc_prd3.id
      zone_id = var.zone1
      vswitch_name = "vsw_prd3_003"
      cidr_block = "10.3.3.0/24"
    }

    resource "alicloud_vswitch" "vswitch_sec_001" {
      vpc_id = alicloud_vpc.vpc_sec.id
      zone_id = var.zone1
      vswitch_name = "vsw_sec_001"
      cidr_block = "172.16.1.0/24"
    }

    resource "alicloud_vswitch" "vswitch_sec_002" {
      vpc_id = alicloud_vpc.vpc_sec.id
      zone_id = var.zone2
      vswitch_name = "vsw_sec_002"
      cidr_block = "172.16.2.0/24"
    }

    resource "alicloud_vswitch" "vswitch_sec_003" {
      vpc_id = alicloud_vpc.vpc_sec.id
      zone_id = var.zone1
      vswitch_name = "vsw_sec_003"
      cidr_block = "172.16.3.0/24"
    }

    # Security Groups
    resource "alicloud_security_group" "sg_for_vpc_prd1" {
      security_group_name = "SG_For_VPC_PRD1"
      vpc_id = alicloud_vpc.vpc_prd1.id
    }

    resource "alicloud_security_group_rule" "sg_rule_for_vpc_prd1_ingress_prd1" {
      type              = "ingress"
      ip_protocol       = "all"
      policy            = "accept"
      port_range        = "-1/-1"
      priority          = 1
      security_group_id = alicloud_security_group.sg_for_vpc_prd1.id
      cidr_ip           = "10.1.0.0/16"
    }

    resource "alicloud_security_group_rule" "sg_rule_for_vpc_prd1_ingress_prd2" {
      type              = "ingress"
      ip_protocol       = "all"
      policy            = "accept"
      port_range        = "-1/-1"
      priority          = 1
      security_group_id = alicloud_security_group.sg_for_vpc_prd1.id
      cidr_ip           = "10.2.0.0/16"
    }

    resource "alicloud_security_group_rule" "sg_rule_for_vpc_prd1_ingress_sec" {
      type              = "ingress"
      ip_protocol       = "all"
      policy            = "accept"
      port_range        = "-1/-1"
      priority          = 1
      security_group_id = alicloud_security_group.sg_for_vpc_prd1.id
      cidr_ip           = "172.16.0.0/16"
    }

    resource "alicloud_security_group" "sg_for_vpc_prd2" {
      security_group_name = "SG_For_VPC_PRD2"
      vpc_id = alicloud_vpc.vpc_prd2.id
    }

    resource "alicloud_security_group_rule" "sg_rule_for_vpc_prd2_ingress_prd1" {
      type              = "ingress"
      ip_protocol       = "all"
      policy            = "accept"
      port_range        = "-1/-1"
      priority          = 1
      security_group_id = alicloud_security_group.sg_for_vpc_prd2.id
      cidr_ip           = "10.1.0.0/16"
    }

    resource "alicloud_security_group_rule" "sg_rule_for_vpc_prd2_ingress_prd2" {
      type              = "ingress"
      ip_protocol       = "all"
      policy            = "accept"
      port_range        = "-1/-1"
      priority          = 1
      security_group_id = alicloud_security_group.sg_for_vpc_prd2.id
      cidr_ip           = "10.2.0.0/16"
    }

    resource "alicloud_security_group_rule" "sg_rule_for_vpc_prd2_ingress_sec" {
      type              = "ingress"
      ip_protocol       = "all"
      policy            = "accept"
      port_range        = "-1/-1"
      priority          = 1
      security_group_id = alicloud_security_group.sg_for_vpc_prd2.id
      cidr_ip           = "172.16.0.0/16"
    }

    resource "alicloud_security_group" "sg_for_vpc_prd3" {
      security_group_name = "SG_For_VPC_PRD3"
      vpc_id = alicloud_vpc.vpc_prd3.id
    }

    resource "alicloud_security_group_rule" "sg_rule_for_vpc_prd3_ingress_prd3" {
      type              = "ingress"
      ip_protocol       = "all"
      policy            = "accept"
      port_range        = "-1/-1"
      priority          = 1
      security_group_id = alicloud_security_group.sg_for_vpc_prd3.id
      cidr_ip           = "10.3.0.0/16"
    }

    resource "alicloud_security_group" "sg_for_vpc_sec" {
      security_group_name = "SG_For_VPC_SEC"
      vpc_id = alicloud_vpc.vpc_sec.id
    }

    resource "alicloud_security_group_rule" "sg_rule_for_vpc_sec_ingress_prd1" {
      type              = "ingress"
      ip_protocol       = "all"
      policy            = "accept"
      port_range        = "-1/-1"
      priority          = 1
      security_group_id = alicloud_security_group.sg_for_vpc_sec.id
      cidr_ip           = "10.1.0.0/16"
    }

    resource "alicloud_security_group_rule" "sg_rule_for_vpc_sec_ingress_prd2" {
      type              = "ingress"
      ip_protocol       = "all"
      policy            = "accept"
      port_range        = "-1/-1"
      priority          = 1
      security_group_id = alicloud_security_group.sg_for_vpc_sec.id
      cidr_ip           = "10.2.0.0/16"
    }

    resource "alicloud_security_group_rule" "sg_rule_for_vpc_sec_ingress_sec" {
      type              = "ingress"
      ip_protocol       = "all"
      policy            = "accept"
      port_range        = "-1/-1"
      priority          = 1
      security_group_id = alicloud_security_group.sg_for_vpc_sec.id
      cidr_ip           = "172.16.0.0/16"
    }

    # ECS Instances
    resource "alicloud_instance" "ecs_instance_in_vpc_prd1" {
      instance_name = "PRD1"
      vswitch_id = alicloud_vswitch.vswitch_prd1_003.id
      security_groups = [alicloud_security_group.sg_for_vpc_prd1.id]
      image_id = "centos_7_6_x64_20G_alibase_20211130.vhd"
      instance_type = var.ecs_instance_type
      password = var.ecs_instance_password
      system_disk_category = "cloud_essd"
      system_disk_size = 40
      internet_max_bandwidth_out = 0
    }

    resource "alicloud_instance" "ecs_instance_in_vpc_prd2" {
      instance_name = "PRD2"
      vswitch_id = alicloud_vswitch.vswitch_prd2_003.id
      security_groups = [alicloud_security_group.sg_for_vpc_prd2.id]
      image_id = "centos_7_6_x64_20G_alibase_20211130.vhd"
      instance_type = var.ecs_instance_type
      password = var.ecs_instance_password
      system_disk_category = "cloud_essd"
      system_disk_size = 40
      internet_max_bandwidth_out = 0
    }

    resource "alicloud_instance" "ecs_instance_in_vpc_prd3" {
      instance_name = "PRD3"
      vswitch_id = alicloud_vswitch.vswitch_prd3_003.id
      security_groups = [alicloud_security_group.sg_for_vpc_prd3.id]
      image_id = "centos_7_6_x64_20G_alibase_20211130.vhd"
      instance_type = var.ecs_instance_type
      password = var.ecs_instance_password
      system_disk_category = "cloud_essd"
      system_disk_size = 40
      internet_max_bandwidth_out = 0
    }

    resource "alicloud_instance" "ecs_instance_in_vpc_sec" {
      instance_name = "SEC"
      vswitch_id = alicloud_vswitch.vswitch_sec_003.id
      security_groups = [alicloud_security_group.sg_for_vpc_sec.id]
      image_id = "centos_7_6_x64_20G_alibase_20211130.vhd"
      instance_type = var.ecs_instance_type
      password = var.ecs_instance_password
      system_disk_category = "cloud_essd"
      system_disk_size = 40
      internet_max_bandwidth_out = 0
    }


    # Run command to enable IPv4 forwarding
    resource "alicloud_ecs_command" "run_command" {
      name = "enable_ipv4_forward"
      command_content = base64encode(<<-EOF
      echo 1 > /proc/sys/net/ipv4/ip_forward
      EOF
      )
      type = "RunShellScript"
      timeout = 60
    }

    resource "alicloud_ecs_invocation" "invoke_script" {
      instance_id = [alicloud_instance.ecs_instance_in_vpc_sec.id]
      command_id = alicloud_ecs_command.run_command.id
    }

    # CEN
    resource "alicloud_cen_instance" "cen_instance" {
      cen_instance_name = "cen"
    }

    # TR
    data "alicloud_cen_transit_router_service" "open" {
      enable = "On"
    }

    resource "alicloud_cen_transit_router" "transit_router" {
      cen_id = alicloud_cen_instance.cen_instance.id
    }

    # Transit Router Attachments
    resource "alicloud_cen_transit_router_vpc_attachment" "transit_router_vpc_prd1_attachment" {
      vpc_id = alicloud_vpc.vpc_prd1.id
      transit_router_id = alicloud_cen_transit_router.transit_router.transit_router_id
      zone_mappings {
        zone_id = var.zone1
        vswitch_id = alicloud_vswitch.vswitch_prd1_001.id
      }
      zone_mappings {
        zone_id = var.zone2
        vswitch_id = alicloud_vswitch.vswitch_prd1_002.id
      }
      auto_publish_route_enabled = true
    }

    resource "alicloud_cen_transit_router_vpc_attachment" "transit_router_vpc_prd2_attachment" {
      vpc_id = alicloud_vpc.vpc_prd2.id
      transit_router_id = alicloud_cen_transit_router.transit_router.transit_router_id
      zone_mappings {
        zone_id = var.zone1
        vswitch_id = alicloud_vswitch.vswitch_prd2_001.id
      }
      zone_mappings {
        zone_id = var.zone2
        vswitch_id = alicloud_vswitch.vswitch_prd2_002.id
      }
      auto_publish_route_enabled = true
    }

    resource "alicloud_cen_transit_router_vpc_attachment" "transit_router_vpc_prd3_attachment" {
      vpc_id = alicloud_vpc.vpc_prd3.id
      transit_router_id = alicloud_cen_transit_router.transit_router.transit_router_id
      zone_mappings {
        zone_id = var.zone1
        vswitch_id = alicloud_vswitch.vswitch_prd3_001.id
      }
      zone_mappings {
        zone_id = var.zone2
        vswitch_id = alicloud_vswitch.vswitch_prd3_002.id
      }
      auto_publish_route_enabled = true
    }

    resource "alicloud_cen_transit_router_vpc_attachment" "transit_router_vpc_sec_attachment" {
      vpc_id = alicloud_vpc.vpc_sec.id
      transit_router_id = alicloud_cen_transit_router.transit_router.transit_router_id
      zone_mappings {
        zone_id = var.zone1
        vswitch_id = alicloud_vswitch.vswitch_sec_001.id
      }
      zone_mappings {
        zone_id = var.zone2
        vswitch_id = alicloud_vswitch.vswitch_sec_002.id
      }
      auto_publish_route_enabled = true
    }

    # Transit Router Route Table
    resource "alicloud_cen_transit_router_route_table" "transit_router_custom_route_table_1" {
      transit_router_id = alicloud_cen_transit_router.transit_router.transit_router_id
      transit_router_route_table_name = "tr_custom_route_table_1"
    }

    resource "alicloud_cen_transit_router_route_table" "transit_router_custom_route_table_2" {
      transit_router_id = alicloud_cen_transit_router.transit_router.transit_router_id
      transit_router_route_table_name = "tr_custom_route_table_2"
    }

    # VPC_PRD1,VPC_PRD2,VPC_PRD3
    resource "alicloud_cen_transit_router_route_table_association" "transit_router_custom_route_table_1_association_prd1" {
      transit_router_attachment_id = alicloud_cen_transit_router_vpc_attachment.transit_router_vpc_prd1_attachment.transit_router_attachment_id
      transit_router_route_table_id = alicloud_cen_transit_router_route_table.transit_router_custom_route_table_1.transit_router_route_table_id
    }

    resource "alicloud_cen_transit_router_route_table_association" "transit_router_custom_route_table_1_association_prd2" {
      transit_router_attachment_id = alicloud_cen_transit_router_vpc_attachment.transit_router_vpc_prd2_attachment.transit_router_attachment_id
      transit_router_route_table_id = alicloud_cen_transit_router_route_table.transit_router_custom_route_table_1.transit_router_route_table_id
    }

    resource "alicloud_cen_transit_router_route_table_association" "transit_router_custom_route_table_1_association_prd3" {
      transit_router_attachment_id = alicloud_cen_transit_router_vpc_attachment.transit_router_vpc_prd3_attachment.transit_router_attachment_id
      transit_router_route_table_id = alicloud_cen_transit_router_route_table.transit_router_custom_route_table_1.transit_router_route_table_id
    }

    resource "alicloud_cen_transit_router_route_entry" "transit_router_route_entry" {
      transit_router_route_entry_destination_cidr_block = "0.0.0.0/0"
      transit_router_route_entry_next_hop_id = alicloud_cen_transit_router_vpc_attachment.transit_router_vpc_sec_attachment.transit_router_attachment_id
      transit_router_route_entry_next_hop_type = "Attachment"
      transit_router_route_table_id = alicloud_cen_transit_router_route_table.transit_router_custom_route_table_1.transit_router_route_table_id
    }

    # SEC
    resource "alicloud_cen_transit_router_route_table_association" "transit_router_custom_route_table_2_association_sec" {
      transit_router_attachment_id = alicloud_cen_transit_router_vpc_attachment.transit_router_vpc_sec_attachment.transit_router_attachment_id
      transit_router_route_table_id = alicloud_cen_transit_router_route_table.transit_router_custom_route_table_2.transit_router_route_table_id
    }

    # Transit Router Route Table Propagation
    resource "alicloud_cen_transit_router_route_table_propagation" "transit_router_custom_route_table_propagation_for_vpc_prd1" {
      transit_router_attachment_id = alicloud_cen_transit_router_vpc_attachment.transit_router_vpc_prd1_attachment.transit_router_attachment_id
      transit_router_route_table_id = alicloud_cen_transit_router_route_table.transit_router_custom_route_table_2.transit_router_route_table_id
    }

    resource "alicloud_cen_transit_router_route_table_propagation" "transit_router_custom_route_table_propagation_for_vpc_prd2" {
      transit_router_attachment_id = alicloud_cen_transit_router_vpc_attachment.transit_router_vpc_prd2_attachment.transit_router_attachment_id
      transit_router_route_table_id = alicloud_cen_transit_router_route_table.transit_router_custom_route_table_2.transit_router_route_table_id
    }

    resource "alicloud_cen_transit_router_route_table_propagation" "transit_router_custom_route_table_propagation_for_vpc_sec" {
      transit_router_attachment_id = alicloud_cen_transit_router_vpc_attachment.transit_router_vpc_sec_attachment.transit_router_attachment_id
      transit_router_route_table_id = alicloud_cen_transit_router_route_table.transit_router_custom_route_table_2.transit_router_route_table_id
    }

    # VPC_SEC Route Table
    resource "alicloud_route_table" "vpc_sec_custom_route_table_1" {
      vpc_id = alicloud_vpc.vpc_sec.id
      route_table_name = "Custom VPC_SEC TR IN"
    }

    resource "alicloud_route_table_attachment" "route_table_attachment_vswitch_sec_001" {
      vswitch_id     = alicloud_vswitch.vswitch_sec_001.id
      route_table_id = alicloud_route_table.vpc_sec_custom_route_table_1.id
    }

    resource "alicloud_route_table_attachment" "route_table_attachment_vswitch_sec_002" {
      vswitch_id     = alicloud_vswitch.vswitch_sec_002.id
      route_table_id = alicloud_route_table.vpc_sec_custom_route_table_1.id
    }

    resource "alicloud_route_table" "vpc_sec_custom_route_table_2" {
      vpc_id = alicloud_vpc.vpc_sec.id
      route_table_name = "Custom VPC_SEC TR OUT"
    }

    resource "alicloud_route_table_attachment" "route_table_attachment_vswitch_sec_003" {
      vswitch_id     = alicloud_vswitch.vswitch_sec_003.id
      route_table_id = alicloud_route_table.vpc_sec_custom_route_table_2.id
    }

    # VPC_SEC Route Forwarding
    resource "alicloud_route_entry" "route_forward_to_ecs" {
      route_table_id = alicloud_route_table.vpc_sec_custom_route_table_1.id
      destination_cidrblock = "0.0.0.0/0"
      nexthop_type = "Instance"
      nexthop_id = alicloud_instance.ecs_instance_in_vpc_sec.id
    }

    resource "alicloud_route_entry" "route_forward_to_cen" {
      route_table_id = alicloud_route_table.vpc_sec_custom_route_table_2.id
      destination_cidrblock = "0.0.0.0/0"
      nexthop_type = "Attachment"
      nexthop_id = alicloud_cen_transit_router_vpc_attachment.transit_router_vpc_sec_attachment.transit_router_attachment_id
    }

  outputs.tf: |-
    output "ecs_instances" {
      description = "查看创建的ECS实例列表"
      value = format("https://ecs.console.aliyun.com/server/region/%s?instanceIds=%s,%s,%s,%s", var.region, alicloud_instance.ecs_instance_in_vpc_prd1.id, alicloud_instance.ecs_instance_in_vpc_prd2.id, alicloud_instance.ecs_instance_in_vpc_prd3.id, alicloud_instance.ecs_instance_in_vpc_sec.id)
    }
  variables.tf: |-
    variable "ecs_instance_type" {
      type        = string
      description = "ECS实例规格"
      default = "ecs.t6-c4m1.large"
    }

    variable "ecs_instance_password" {
      type        = string
      sensitive   = true
      description = "服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）"
      # default = "Alicloud@123"
    }

    variable "region" {
      type        = string
      description = "资源部署地域"
      default = "ap-southeast-1"
    }

    variable "zone1" {
      type        = string
      description = "交换机可用区1"
      default = "ap-southeast-1a"
    }

    variable "zone2" {
      type        = string
      description = "交换机可用区2，请确保交换机可用区2与交换机可用区1不相同"
      default = "ap-southeast-1b"
    }
Metadata:
  ALIYUN::ROS::Interface:
    TemplateTags:
      - acs:technical-solution:network:net-cloud-network-plan-intl-zh

