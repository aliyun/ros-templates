ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 构建双VPC架构，配置安全组与路由，通过CEN互联，部署ALB与NLB实现公网访问与负载均衡，确保资源安全与高可用。
  en: Construct a dual VPC architecture, configure security groups and routes, interconnect
    via CEN (Cloud Enterprise Network), deploy ALB (Application Load Balancer) and
    NLB (Network Load Balancer) to facilitate public network access and load balancing,
    ensuring resource security and high availability.
Parameters:
  ZoneId_0:
    Type: String
    Label:
      zh-cn: 可用区A
      en: Availability Zone A
    Description:
      en: To create an availability zone for the instance, <font color='red'><b>ensure that the current region has 
        at least two different availability zones to choose from</b>.
      zh-cn: 创建实例的可用区，<font color='red'><b>请确保当前地域有至少两个不同的可用区可供选择</b>。
    AssociationProperty: ALIYUN::NLB::Zone::ZoneId
  ZoneId_1:
    Type: String
    Label:
      zh-cn: 可用区B
      en: Availability Zone B
    Description:
      en: To create an availability zone for the instance, <font color='red'><b>ensure that the current region has
        at least two different availability zones to choose from</b>.
      zh-cn: 创建实例的可用区，<font color='red'><b>请确保当前地域有至少两个不同的可用区可供选择</b>。
    AssociationProperty: ALIYUN::NLB::Zone::ZoneId
  InstanceType:
    Type: String
    Label:
      en: ECS Instance Type
      zh-cn: ECS实例规格
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
  SystemDiskCategory:
    Type: String
    Label:
      en: System disk type
      zh-cn: 系统盘类型
  InstancePassword:
    NoEcho: true
    Type: String
    Description:
      en: >-
        Server login password, Length 8-30, must contain three(Capital letters,
        lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special
        symbol in)
      zh-cn: >-
        服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/
        中的特殊符号）
    Label:
      en: Instance Password
      zh-cn: 实例密码
    ConstraintDescription:
      en: >-
        Length 8-30, must contain three(Capital letters, lowercase letters,
        numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in)
      zh-cn: '长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;''<>,.?/ 中的特殊符号）'
    AssociationProperty: 'ALIYUN::ECS::Instance::Password'
    Default: null
Resources:
  PrdVpc_0:
    Type: ALIYUN::ECS::VPC
    Properties:
      VpcName: VPC_PRD1
      CidrBlock: 192.168.0.0/24
  PrdVpc_1:
    Type: ALIYUN::ECS::VPC
    Properties:
      VpcName: VPC_PRD2
      CidrBlock: 192.168.1.0/24
  DmzVpc:
    Type:
      ALIYUN::ECS::VPC
    Properties:
      VpcName: VPC_DMZ
      CidrBlock: 192.168.2.0/24
  PrdSecurityGroup_0:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: PrdVpc_0
      SecurityGroupIngress:
        - PortRange: -1/-1
          Priority: 1
          SourceCidrIp: 192.168.0.0/24
          IpProtocol: all
          NicType: intranet
  PrdSecurityGroup_1:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: PrdVpc_1
      SecurityGroupIngress:
        - PortRange: -1/-1
          Priority: 1
          SourceCidrIp: 192.168.1.0/24
          IpProtocol: all
          NicType: intranet
  PrdVSwitch_0_0:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      VpcId:
        Ref: PrdVpc_0
      ZoneId:
        Ref: ZoneId_0
      CidrBlock: 192.168.0.0/25
  PrdVSwitch_0_1:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      VpcId:
        Ref: PrdVpc_0
      ZoneId:
        Ref: ZoneId_1
      CidrBlock: 192.168.0.128/25
  PrdVSwitch_1_0:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      VpcId:
        Ref: PrdVpc_1
      ZoneId:
        Ref: ZoneId_0
      CidrBlock: 192.168.1.0/25
  PrdVSwitch_1_1:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      VpcId:
        Ref: PrdVpc_1
      ZoneId:
        Ref: ZoneId_1
      CidrBlock: 192.168.1.128/25
  DmzVSwitch_0:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      VpcId:
        Ref: DmzVpc
      ZoneId:
        Ref: ZoneId_0
      CidrBlock: 192.168.2.0/25
  DmzVSwitch_1:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      VpcId:
        Ref: DmzVpc
      ZoneId:
        Ref: ZoneId_1
      CidrBlock: 192.168.2.128/25
  CenInstance:
    Type: ALIYUN::CEN::CenInstance
    DependsOn: AutoEnableTR
    Properties:
      Name: DmzCen
  CenTransitRouter:
    Type: ALIYUN::CEN::TransitRouter
    Properties:
      CenId:
        Fn::GetAtt:
          - CenInstance
          - CenId
  PrdCenTransitRouterVpcAttachment_0:
    Type: ALIYUN::CEN::TransitRouterVpcAttachment
    Properties:
      TransitRouterId:
        Fn::GetAtt:
          - CenTransitRouter
          - TransitRouterId
      VpcId:
        Ref: PrdVpc_0
      ZoneMappings:
        - ZoneId:
            Ref: ZoneId_0
          VSwitchId:
            Ref: PrdVSwitch_0_0
        - ZoneId:
            Ref: ZoneId_1
          VSwitchId:
            Ref: PrdVSwitch_0_1
      DeletionForce: true
  PrdCenTransitRouterVpcAttachment_1:
    Type: ALIYUN::CEN::TransitRouterVpcAttachment
    Properties:
      TransitRouterId:
        Fn::GetAtt:
          - CenTransitRouter
          - TransitRouterId
      VpcId:
        Ref: PrdVpc_1
      ZoneMappings:
        - ZoneId:
            Ref: ZoneId_0
          VSwitchId:
            Ref: PrdVSwitch_1_0
        - ZoneId:
            Ref: ZoneId_1
          VSwitchId:
            Ref: PrdVSwitch_1_1
      DeletionForce: true
  DmzCenTransitRouterVpcAttachment:
    Type: ALIYUN::CEN::TransitRouterVpcAttachment
    Properties:
      TransitRouterId:
        Fn::GetAtt:
          - CenTransitRouter
          - TransitRouterId
      VpcId:
        Ref: DmzVpc
      ZoneMappings:
        - ZoneId:
            Ref: ZoneId_0
          VSwitchId:
            Ref: DmzVSwitch_0
        - ZoneId:
            Ref: ZoneId_1
          VSwitchId:
            Ref: DmzVSwitch_1
      DeletionForce: true
  CenTransitRouterRouteTable_0:
    Type: ALIYUN::CEN::TransitRouterRouteTable
    Properties:
      TransitRouterRouteTableName: Prd_tr_1
      TransitRouterId:
        Fn::GetAtt:
          - CenTransitRouter
          - TransitRouterId
  CenTransitRouterRouteTable_1:
    Type: ALIYUN::CEN::TransitRouterRouteTable
    Properties:
      TransitRouterRouteTableName: Prd_tr_2
      TransitRouterId:
        Fn::GetAtt:
          - CenTransitRouter
          - TransitRouterId
  DmzTransitRouterRouteTablePropagation_0:
    Type: ALIYUN::CEN::TransitRouterRouteTablePropagation
    Properties:
      TransitRouterRouteTableId:
        Fn::GetAtt:
          - CenTransitRouter
          - SystemTransitRouterRouteTableId
      TransitRouterAttachmentId:
        Fn::GetAtt:
          - PrdCenTransitRouterVpcAttachment_0
          - TransitRouterAttachmentId
  DmzTransitRouterRouteTablePropagation_1:
    Type: ALIYUN::CEN::TransitRouterRouteTablePropagation
    Properties:
      TransitRouterRouteTableId:
        Fn::GetAtt:
          - CenTransitRouter
          - SystemTransitRouterRouteTableId
      TransitRouterAttachmentId:
        Fn::GetAtt:
          - PrdCenTransitRouterVpcAttachment_1
          - TransitRouterAttachmentId
  PrdTransitRouterRouteTablePropagation_0:
    Type: ALIYUN::CEN::TransitRouterRouteTablePropagation
    Properties:
      TransitRouterRouteTableId:
        Fn::GetAtt:
          - CenTransitRouterRouteTable_0
          - TransitRouterRouteTableId
      TransitRouterAttachmentId:
        Fn::GetAtt:
          - DmzCenTransitRouterVpcAttachment
          - TransitRouterAttachmentId
  PrdTransitRouterRouteTablePropagation_1:
    Type: ALIYUN::CEN::TransitRouterRouteTablePropagation
    Properties:
      TransitRouterRouteTableId:
        Fn::GetAtt:
          - CenTransitRouterRouteTable_1
          - TransitRouterRouteTableId
      TransitRouterAttachmentId:
        Fn::GetAtt:
          - DmzCenTransitRouterVpcAttachment
          - TransitRouterAttachmentId
  PrdCenTransitRouterRouteEntryToDmz_0:
    Type: ALIYUN::CEN::TransitRouterRouteEntry
    Properties:
      TransitRouterRouteTableId:
        Fn::GetAtt:
          - CenTransitRouterRouteTable_0
          - TransitRouterRouteTableId
      TransitRouterRouteEntryDestinationCidrBlock: 0.0.0.0/0
      TransitRouterRouteEntryNextHopType: Attachment
      TransitRouterRouteEntryNextHopId:
        Fn::GetAtt:
          - DmzCenTransitRouterVpcAttachment
          - TransitRouterAttachmentId
  PrdCenTransitRouterRouteEntryToDmz_1:
    Type: ALIYUN::CEN::TransitRouterRouteEntry
    Properties:
      TransitRouterRouteTableId:
        Fn::GetAtt:
          - CenTransitRouterRouteTable_1
          - TransitRouterRouteTableId
      TransitRouterRouteEntryDestinationCidrBlock: 0.0.0.0/0
      TransitRouterRouteEntryNextHopType: Attachment
      TransitRouterRouteEntryNextHopId:
        Fn::GetAtt:
          - DmzCenTransitRouterVpcAttachment
          - TransitRouterAttachmentId
  DmzTransitRouterRouteTableAssociation:
    Type: ALIYUN::CEN::TransitRouterRouteTableAssociation
    Properties:
      TransitRouterRouteTableId:
        Fn::GetAtt:
          - CenTransitRouter
          - SystemTransitRouterRouteTableId
      TransitRouterAttachmentId:
        Fn::GetAtt:
          - DmzCenTransitRouterVpcAttachment
          - TransitRouterAttachmentId
  PrdTransitRouterRouteTableAssociation_0:
    Type: ALIYUN::CEN::TransitRouterRouteTableAssociation
    Properties:
      TransitRouterRouteTableId:
        Fn::GetAtt:
          - CenTransitRouterRouteTable_0
          - TransitRouterRouteTableId
      TransitRouterAttachmentId:
        Fn::GetAtt:
          - PrdCenTransitRouterVpcAttachment_0
          - TransitRouterAttachmentId
  PrdTransitRouterRouteTableAssociation_1:
    Type: ALIYUN::CEN::TransitRouterRouteTableAssociation
    Properties:
      TransitRouterRouteTableId:
        Fn::GetAtt:
          - CenTransitRouterRouteTable_1
          - TransitRouterRouteTableId
      TransitRouterAttachmentId:
        Fn::GetAtt:
          - PrdCenTransitRouterVpcAttachment_1
          - TransitRouterAttachmentId
  DmzRouterEntryToPrd_0:
    Type: ALIYUN::ECS::Route
    Properties:
      DestinationCidrBlock: 192.168.0.0/24
      RouteTableId:
        Fn::GetAtt:
          - DmzVpc
          - RouteTableId
      NextHopType: Attachment
      NextHopId:
        Fn::GetAtt:
          - DmzCenTransitRouterVpcAttachment
          - TransitRouterAttachmentId
  DmzRouterEntryToPrd_1:
    Type: ALIYUN::ECS::Route
    Properties:
      DestinationCidrBlock: 192.168.1.0/24
      RouteTableId:
        Fn::GetAtt:
          - DmzVpc
          - RouteTableId
      NextHopType: Attachment
      NextHopId:
        Fn::GetAtt:
          - DmzCenTransitRouterVpcAttachment
          - TransitRouterAttachmentId
  PrdRouterEntryToDmz_0_0:
    Type: ALIYUN::ECS::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      RouteTableId:
        Fn::GetAtt:
          - PrdVpc_0
          - RouteTableId
      NextHopType: Attachment
      NextHopId:
        Fn::GetAtt:
          - PrdCenTransitRouterVpcAttachment_0
          - TransitRouterAttachmentId
  PrdRouterEntryToDmz_0_1:
    Type: ALIYUN::ECS::Route
    Properties:
      DestinationCidrBlock: 192.168.2.0/24
      RouteTableId:
        Fn::GetAtt:
          - PrdVpc_0
          - RouteTableId
      NextHopType: Attachment
      NextHopId:
        Fn::GetAtt:
          - PrdCenTransitRouterVpcAttachment_0
          - TransitRouterAttachmentId
  PrdRouterEntryToDmz_1_0:
    Type: ALIYUN::ECS::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      RouteTableId:
        Fn::GetAtt:
          - PrdVpc_1
          - RouteTableId
      NextHopType: Attachment
      NextHopId:
        Fn::GetAtt:
          - PrdCenTransitRouterVpcAttachment_1
          - TransitRouterAttachmentId
  PrdRouterEntryToDmz_1_1:
    Type: ALIYUN::ECS::Route
    Properties:
      DestinationCidrBlock: 192.168.2.0/24
      RouteTableId:
        Fn::GetAtt:
          - PrdVpc_1
          - RouteTableId
      NextHopType: Attachment
      NextHopId:
        Fn::GetAtt:
          - PrdCenTransitRouterVpcAttachment_1
          - TransitRouterAttachmentId
  CommonBandwidthPackage:
    Type: ALIYUN::VPC::CommonBandwidthPackage
    Properties:
      Bandwidth: 2
      InternetChargeType: PayByBandwidth
  PrdEcsInstance_0_0:
    Type: ALIYUN::ECS::Instance
    Properties:
      VpcId:
        Ref: PrdVpc_0
      SecurityGroupId:
        Ref: PrdSecurityGroup_0
      VSwitchId:
        Ref: PrdVSwitch_0_0
      InstanceName: APP01
      ZoneId:
        Ref: ZoneId_0
      InstanceChargeType: PostPaid
      InstanceType:
        Ref: InstanceType
      ImageId: centos_7
      SystemDiskCategory:
        Ref: SystemDiskCategory
      SystemDiskSize: 40
      AllocatePublicIP: false
      Password:
        Ref: InstancePassword
  PrdEcsInstance_0_1:
    Type: ALIYUN::ECS::Instance
    Properties:
      VpcId:
        Ref: PrdVpc_0
      SecurityGroupId:
        Ref: PrdSecurityGroup_0
      VSwitchId:
        Ref: PrdVSwitch_0_1
      InstanceName: APP02
      ZoneId:
        Ref: ZoneId_1
      InstanceChargeType: PostPaid
      InstanceType:
        Ref: InstanceType
      ImageId: centos_7
      SystemDiskCategory:
        Ref: SystemDiskCategory
      SystemDiskSize: 40
      AllocatePublicIP: false
      Password:
        Ref: InstancePassword
  PrdEcsInstance_1_0:
    Type: ALIYUN::ECS::Instance
    Properties:
      VpcId:
        Ref: PrdVpc_1
      SecurityGroupId:
        Ref: PrdSecurityGroup_1
      VSwitchId:
        Ref: PrdVSwitch_1_0
      InstanceName: APP03
      ZoneId:
        Ref: ZoneId_0
      InstanceChargeType: PostPaid
      InstanceType:
        Ref: InstanceType
      ImageId: centos_7
      SystemDiskCategory:
        Ref: SystemDiskCategory
      SystemDiskSize: 40
      AllocatePublicIP: false
      Password:
        Ref: InstancePassword
  PrdEcsInstance_1_1:
    Type: ALIYUN::ECS::Instance
    Properties:
      VpcId:
        Ref: PrdVpc_1
      SecurityGroupId:
        Ref: PrdSecurityGroup_1
      VSwitchId:
        Ref: PrdVSwitch_1_1
      InstanceName: APP04
      ZoneId:
        Ref: ZoneId_1
      InstanceChargeType: PostPaid
      InstanceType:
        Ref: InstanceType
      ImageId: centos_7
      SystemDiskCategory:
        Ref: SystemDiskCategory
      SystemDiskSize: 40
      AllocatePublicIP: false
      Password:
        Ref: InstancePassword
  InstallApp:
    Type: 'ALIYUN::ECS::RunCommand'
    DependsOn:
     - SnatEntry
    Properties:
      InstanceIds:
        - Ref: PrdEcsInstance_0_0
        - Ref: PrdEcsInstance_0_1
        - Ref: PrdEcsInstance_1_0
        - Ref: PrdEcsInstance_1_1
      Type: RunShellScript
      Sync: true
      Timeout: 3600
      CommandContent:
        Fn::Sub: |-
          #!/bin/bash
          yum update -y
          yum install nginx -y 
          systemctl enable nginx
          systemctl start nginx
  NatGateWay:
    Type: ALIYUN::VPC::NatGateway
    Properties:
      VpcId:
        Ref: DmzVpc
      VSwitchId:
        Ref: DmzVSwitch_0
      DeletionForce: true
  Eip:
    Type: ALIYUN::VPC::EIP
  EipAssociation:
    Type: ALIYUN::VPC::EIPAssociation
    Properties:
      AllocationId:
        Fn::GetAtt:
          - Eip
          - AllocationId
      InstanceId:
        Fn::GetAtt:
          - NatGateWay
          - NatGatewayId
  SnatEntry:
    Type: ALIYUN::VPC::SnatEntry
    Properties:
      SnatTableId:
        Fn::GetAtt:
          - NatGateWay
          - SNatTableId
      SnatIp:
        Fn::GetAtt:
          - Eip
          - EipAddress
    DependsOn: EipAssociation
  AlbLoadBalancer_0:
    Type: ALIYUN::ALB::LoadBalancer
    Properties:
      LoadBalancerName: ALB_HZ_0
      AddressType: Intranet
      VpcId:
        Ref: PrdVpc_0
      ZoneMappings:
        - ZoneId:
            Ref: ZoneId_0
          VSwitchId:
            Ref: PrdVSwitch_0_0
        - ZoneId:
            Ref: ZoneId_1
          VSwitchId:
            Ref: PrdVSwitch_0_1
      AddressAllocatedMode: Dynamic
      AddressIpVersion: IPv4
      LoadBalancerEdition: Basic
      LoadBalancerBillingConfig:
        PayType: PostPay
  AlbLoadBalancer_1:
    Type: ALIYUN::ALB::LoadBalancer
    Properties:
      LoadBalancerName: ALB_HZ_1
      AddressType: Intranet
      VpcId:
        Ref: PrdVpc_1
      ZoneMappings:
        - ZoneId:
            Ref: ZoneId_0
          VSwitchId:
            Ref: PrdVSwitch_1_0
        - ZoneId:
            Ref: ZoneId_1
          VSwitchId:
            Ref: PrdVSwitch_1_1
      AddressAllocatedMode: Dynamic
      AddressIpVersion: IPv4
      LoadBalancerEdition: Basic
      LoadBalancerBillingConfig:
        PayType: PostPay
  AlbServerGroup_0:
    Type: ALIYUN::ALB::ServerGroup
    Properties:
      VpcId:
        Ref: PrdVpc_0
      HealthCheckConfig:
        HealthCheckEnabled: true
      ServerGroupName: AlbServerGroup_PRD_0
      StickySessionConfig:
        StickySessionEnabled: false
  AlbServerGroup_1:
    Type: ALIYUN::ALB::ServerGroup
    Properties:
      VpcId:
        Ref: PrdVpc_1
      HealthCheckConfig:
        HealthCheckEnabled: true
      ServerGroupName: AlbServerGroup_PRD_1
      StickySessionConfig:
        StickySessionEnabled: false
  AlbBackendServerAttachment_0:
    Type: ALIYUN::ALB::BackendServerAttachment
    Properties:
      ServerGroupId:
        Fn::GetAtt:
          - AlbServerGroup_0
          - ServerGroupId
      Servers:
        - ServerType: Ecs
          ServerId:
            Fn::GetAtt:
              - PrdEcsInstance_0_0
              - InstanceId
          Port: 80
        - ServerType: Ecs
          ServerId:
            Fn::GetAtt:
              - PrdEcsInstance_0_1
              - InstanceId
          Port: 80
  AlbBackendServerAttachment_1:
    Type: ALIYUN::ALB::BackendServerAttachment
    Properties:
      ServerGroupId:
        Fn::GetAtt:
          - AlbServerGroup_1
          - ServerGroupId
      Servers:
        - ServerType: Ecs
          ServerId:
            Fn::GetAtt:
              - PrdEcsInstance_1_0
              - InstanceId
          Port: 80
        - ServerType: Ecs
          ServerId:
            Fn::GetAtt:
              - PrdEcsInstance_1_1
              - InstanceId
          Port: 80
  AlbListener_0:
    Type: ALIYUN::ALB::Listener
    Properties:
      ListenerPort: 80
      LoadBalancerId:
        Fn::GetAtt:
          - AlbLoadBalancer_0
          - LoadBalancerId
      ListenerProtocol: HTTP
      DefaultActions:
        - Type: ForwardGroup
          ForwardGroupConfig:
            ServerGroupTuples:
              - ServerGroupId:
                  Fn::GetAtt:
                    - AlbServerGroup_0
                    - ServerGroupId
  AlbListener_1:
    Type: ALIYUN::ALB::Listener
    Properties:
      ListenerPort: 80
      LoadBalancerId:
        Fn::GetAtt:
          - AlbLoadBalancer_1
          - LoadBalancerId
      ListenerProtocol: HTTP
      DefaultActions:
        - Type: ForwardGroup
          ForwardGroupConfig:
            ServerGroupTuples:
              - ServerGroupId:
                  Fn::GetAtt:
                    - AlbServerGroup_1
                    - ServerGroupId
  DmzNlbLoadBalancer:
    Type: ALIYUN::NLB::LoadBalancer
    Properties:
      AddressType: Internet
      VpcId:
        Ref: DmzVpc
      ZoneMappings:
        - ZoneId:
            Ref: ZoneId_0
          VSwitchId:
            Ref: DmzVSwitch_0
        - ZoneId:
            Ref: ZoneId_1
          VSwitchId:
            Ref: DmzVSwitch_1
      AddressIpVersion: Ipv4
      BandwidthPackageId:
        Ref: CommonBandwidthPackage
  DmzNlbServerGroup:
    Type: ALIYUN::NLB::ServerGroup
    Properties:
      ServerGroupType: Ip
      ServerGroupName: DmzNlbServerGroup
      VpcId:
        Ref: DmzVpc
      Protocol: TCP
      Scheduler: Wrr
      HealthCheckConfig:
        HttpCheckMethod: HEAD
        HealthCheckType: Tcp
      Servers:
        - ServerType: Ip
          ServerId:
            Fn::Jq:
              - First
              - .[0].LoadBalancerAddresses | .[0].Address
              - Fn::GetAtt:
                  - AlbLoadBalancer_0
                  - ZoneMappings
          ServerIp:
            Fn::Jq:
              - First
              - .[0].LoadBalancerAddresses | .[0].Address
              - Fn::GetAtt:
                  - AlbLoadBalancer_0
                  - ZoneMappings
          Port: 80
        - ServerType: Ip
          ServerId:
            Fn::Jq:
              - First
              - .[1].LoadBalancerAddresses | .[0].Address
              - Fn::GetAtt:
                  - AlbLoadBalancer_0
                  - ZoneMappings
          ServerIp:
            Fn::Jq:
              - First
              - .[1].LoadBalancerAddresses | .[0].Address
              - Fn::GetAtt:
                  - AlbLoadBalancer_0
                  - ZoneMappings
          Port: 80
        - ServerType: Ip
          ServerId:
            Fn::Jq:
              - First
              - .[0].LoadBalancerAddresses | .[0].Address
              - Fn::GetAtt:
                  - AlbLoadBalancer_1
                  - ZoneMappings
          ServerIp:
            Fn::Jq:
              - First
              - .[0].LoadBalancerAddresses | .[0].Address
              - Fn::GetAtt:
                  - AlbLoadBalancer_1
                  - ZoneMappings
          Port: 80
        - ServerType: Ip
          ServerId:
            Fn::Jq:
              - First
              - .[1].LoadBalancerAddresses | .[0].Address
              - Fn::GetAtt:
                  - AlbLoadBalancer_1
                  - ZoneMappings
          ServerIp:
            Fn::Jq:
              - First
              - .[1].LoadBalancerAddresses | .[0].Address
              - Fn::GetAtt:
                  - AlbLoadBalancer_1
                  - ZoneMappings
          Port: 80
  DmzNlbListener:
    Type: ALIYUN::NLB::Listener
    Properties:
      ListenerPort: 80
      ListenerProtocol: TCP
      ServerGroupId:
        Fn::GetAtt:
          - DmzNlbServerGroup
          - ServerGroupId
      LoadBalancerId:
        Fn::GetAtt:
          - DmzNlbLoadBalancer
          - LoadBalancerId
  AutoEnableTR:
    Type: ALIYUN::ROS::AutoEnableService
    Properties:
      ServiceName: TransitRouter
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
      - Parameters:
          - ZoneId_0
          - ZoneId_1
          - InstanceType
          - SystemDiskCategory
          - InstancePassword
    TemplateTags:
      - acs:technical-solution:network:云上公网架构设计和安全管理-tech_solu_41
  ALIYUN::ROS::Composer:
    79c3030a:
      Rect:
        - 2880
        - 650
        - 40
        - 100
        - 1
        - 0
      ResT: Composer::ROSParameter::AlibabaCloud
    af4a6296:
      Parent: 79c3030a
      Rect:
        - 2840
        - 580
        - 60
        - 150
        - 2
        - 0
      ResT: Composer::ROSParameter::Region
    93217d3c:
      Res:
        - PrdVpc_0
      Parent: af4a6296
      Rect:
        - 866
        - 355
        - 140
        - 301
        - 3
        - 0
    6e4238be:
      Res:
        - PrdVpc_1
      Parent: af4a6296
      Rect:
        - 860
        - 355
        - 1020
        - 301
        - 3
        - 0
    54cbcb40:
      Res:
        - DmzVpc
      Parent: af4a6296
      Rect:
        - 920
        - 371
        - 1900
        - 301
        - 3
        - 0
    50f1c54b:
      Res:
        - CenInstance
      Parent: af4a6296
      Rect:
        - 40
        - 40
        - 80
        - 200
        - 3
        - 0
    1f927f85:
      Res:
        - CenTransitRouter
        - DmzTransitRouterRouteTableAssociation
      Ref:
        - DmzTransitRouterRouteTableAssociation
      Parent: af4a6296
      Rect:
        - 40
        - 40
        - 140
        - 200
        - 3
        - 0
    4a6579c4:
      Res:
        - CenTransitRouterRouteTable_0
        - PrdTransitRouterRouteTableAssociation_0
      Ref:
        - PrdTransitRouterRouteTableAssociation_0
      Parent: af4a6296
      Rect:
        - 40
        - 40
        - 2840
        - 200
        - 3
        - 0
      Hidden: true
    177fc488:
      Res:
        - CenTransitRouterRouteTable_1
        - PrdTransitRouterRouteTableAssociation_1
      Ref:
        - PrdTransitRouterRouteTableAssociation_1
      Parent: af4a6296
      Rect:
        - 40
        - 40
        - 80
        - 260
        - 3
        - 0
      Hidden: true
    28c8689a:
      Res:
        - DmzTransitRouterRouteTablePropagation_0
      Parent: af4a6296
      Rect:
        - 40
        - 40
        - 140
        - 260
        - 3
        - 0
      Hidden: true
    6d67b802:
      Res:
        - DmzTransitRouterRouteTablePropagation_1
      Parent: af4a6296
      Rect:
        - 40
        - 40
        - 1020
        - 260
        - 3
        - 0
      Hidden: true
    7e18f9de:
      Res:
        - PrdTransitRouterRouteTablePropagation_0
      Parent: af4a6296
      Rect:
        - 40
        - 40
        - 1900
        - 260
        - 3
        - 0
      Hidden: true
    97502faa:
      Res:
        - PrdTransitRouterRouteTablePropagation_1
      Parent: af4a6296
      Rect:
        - 40
        - 40
        - 2840
        - 260
        - 3
        - 0
      Hidden: true
    c6e9cee3:
      Res:
        - PrdCenTransitRouterRouteEntryToDmz_0
      Parent: af4a6296
      Rect:
        - 40
        - 40
        - 1020
        - 200
        - 3
        - 0
      Hidden: true
    5d6aa249:
      Res:
        - PrdCenTransitRouterRouteEntryToDmz_1
      Parent: af4a6296
      Rect:
        - 40
        - 40
        - 1900
        - 200
        - 3
        - 0
      Hidden: true
    c24dc6ac:
      Res:
        - CommonBandwidthPackage
      Parent: af4a6296
      Rect:
        - 40
        - 40
        - 80
        - 670
        - 3
        - 0
      Hidden: true
    aaa2bc37:
      Res:
        - InstallApp
      Parent: af4a6296
      Rect:
        - 40
        - 40
        - 80
        - 320
        - 3
        - 0
      Hidden: true
    6e443abb:
      Res:
        - Eip
        - EipAssociation
      Ref:
        - EipAssociation
      Parent: af4a6296
      Rect:
        - 40
        - 40
        - 2484
        - 672
        - 3
        - 0
    f38d46ff:
      Res:
        - AutoEnableTR
      Parent: af4a6296
      Rect:
        - 40
        - 40
        - 2840
        - 320
        - 3
        - 0
      Hidden: true
    6441d908:
      Res:
        - PrdVSwitch_0_0
      Parent: 93217d3c
      Rect:
        - 400
        - 200
        - 160
        - 430
        - 4
        - 0
    32511d25:
      Res:
        - PrdVSwitch_0_1
      Parent: 93217d3c
      Rect:
        - 400
        - 200
        - 590
        - 430
        - 4
        - 0
    587e1e44:
      Res:
        - PrdVSwitch_1_0
      Parent: 6e4238be
      Rect:
        - 400
        - 200
        - 1040
        - 430
        - 4
        - 0
    80b3d84c:
      Res:
        - PrdVSwitch_1_1
      Parent: 6e4238be
      Rect:
        - 400
        - 200
        - 1460
        - 430
        - 4
        - 0
    6ebd9009:
      Res:
        - DmzVSwitch_0
      Parent: 54cbcb40
      Rect:
        - 400
        - 200
        - 2399
        - 430
        - 4
        - 0
    6a73dd7b:
      Res:
        - DmzVSwitch_1
      Parent: 54cbcb40
      Rect:
        - 400
        - 200
        - 1960
        - 430
        - 4
        - 0
    173d6ba7:
      Res:
        - DmzRouterEntryToPrd_0
      Parent: 54cbcb40
      Rect:
        - 40
        - 40
        - 2126
        - 341
        - 4
        - 0
    79ab5352:
      Res:
        - DmzRouterEntryToPrd_1
      Parent: 54cbcb40
      Rect:
        - 40
        - 40
        - 2544
        - 341
        - 4
        - 0
    9d3bea2d:
      Res:
        - PrdRouterEntryToDmz_0_0
      Parent: 93217d3c
      Rect:
        - 40
        - 40
        - 340
        - 341
        - 4
        - 0
    cba3c0b6:
      Res:
        - PrdRouterEntryToDmz_0_1
      Parent: 93217d3c
      Rect:
        - 40
        - 40
        - 713
        - 341
        - 4
        - 0
    748ff729:
      Res:
        - PrdRouterEntryToDmz_1_0
      Parent: 6e4238be
      Rect:
        - 40
        - 40
        - 1220
        - 341
        - 4
        - 0
    3eabe4e2:
      Res:
        - PrdRouterEntryToDmz_1_1
      Parent: 6e4238be
      Rect:
        - 40
        - 40
        - 1629
        - 341
        - 4
        - 0
    90943eed:
      Res:
        - DmzCenTransitRouterVpcAttachment
      Parent: 6a73dd7b
      Rect:
        - 40
        - 40
        - 1980
        - 480
        - 5
        - 0
      Hidden: true
    e225526b:
      Res:
        - NatGateWay
        - SnatEntry
      Ref:
        - SnatEntry
      Parent: 6ebd9009
      Rect:
        - 40
        - 40
        - 2484
        - 480
        - 5
        - 0
    068f40e3:
      Res:
        - DmzNlbLoadBalancer
        - DmzNlbListener
      Ref:
        - DmzNlbListener
      Parent: 6a73dd7b
      Rect:
        - 40
        - 40
        - 2040
        - 480
        - 5
        - 0
    d4544d7b:
      Res:
        - AlbServerGroup_0
        - AlbBackendServerAttachment_0
      Ref:
        - AlbBackendServerAttachment_0
      Parent: 93217d3c
      Rect:
        - 731
        - 165
        - 180
        - 475
        - 10
        - 0
    a22d1d8d:
      Res:
        - DmzNlbServerGroup
      Parent: 54cbcb40
      Rect:
        - 40
        - 40
        - 2340
        - 571
        - 10
        - 0
      Hidden: true
    fbf0f75d:
      Edge:
        - 1f927f85
        - 50f1c54b
      Line: 0:0:0:gray:0
    055b287f:
      Parent: af4a6296
      Edge:
        - 1f927f85
        - 90943eed
      Line: 0:0:0:gray:0
    e05072a6:
      Parent: af4a6296
      Edge:
        - ecac3db0
        - 1f927f85
      Line: 0:0:0:gray:0
    a35e944b:
      Edge:
        - e57892ec
        - 1f927f85
      Line: 0:0:0:gray:0
    f39e59ac:
      Parent: af4a6296
      Edge:
        - 90943eed
        - 1f927f85
      Line: 0:0:0:gray:0
    bdbac828:
      Edge:
        - 4a6579c4
        - 1f927f85
      Line: 0:0:0:gray:0
    6846ccd5:
      Parent: af4a6296
      Edge:
        - 4a6579c4
        - ecac3db0
      Line: 0:0:0:gray:0
    e5b3940a:
      Edge:
        - 177fc488
        - 1f927f85
      Line: 0:0:0:gray:0
    45b1e0ba:
      Edge:
        - 177fc488
        - e57892ec
      Line: 0:0:0:gray:0
    094ebac2:
      Edge:
        - 28c8689a
        - 1f927f85
      Line: 0:0:0:gray:0
    38b26c99:
      Parent: af4a6296
      Edge:
        - 28c8689a
        - ecac3db0
      Line: 0:0:0:gray:0
    bd7f4295:
      Edge:
        - 6d67b802
        - 1f927f85
      Line: 0:0:0:gray:0
    80e2cb95:
      Edge:
        - 6d67b802
        - e57892ec
      Line: 0:0:0:gray:0
    30dbd379:
      Edge:
        - 7e18f9de
        - 4a6579c4
      Line: 0:0:0:gray:0
    77303ef5:
      Parent: af4a6296
      Edge:
        - 7e18f9de
        - 90943eed
      Line: 0:0:0:gray:0
    5cfdea80:
      Edge:
        - 97502faa
        - 177fc488
      Line: 0:0:0:gray:0
    06a08602:
      Parent: af4a6296
      Edge:
        - 97502faa
        - 90943eed
      Line: 0:0:0:gray:0
    00758c88:
      Edge:
        - c6e9cee3
        - 4a6579c4
      Line: 0:0:0:gray:0
    0899705f:
      Parent: af4a6296
      Edge:
        - c6e9cee3
        - 90943eed
      Line: 0:0:0:gray:0
    3b18f696:
      Edge:
        - 5d6aa249
        - 177fc488
      Line: 0:0:0:gray:0
    d65bedd5:
      Parent: af4a6296
      Edge:
        - 5d6aa249
        - 90943eed
      Line: 0:0:0:gray:0
    f8149e7d:
      Parent: 54cbcb40
      Edge:
        - 173d6ba7
        - 90943eed
      Line: 0:0:0:gray:0
    bbf87a83:
      Parent: 54cbcb40
      Edge:
        - 79ab5352
        - 90943eed
      Line: 0:0:0:gray:0
    fd818089:
      Parent: 93217d3c
      Edge:
        - 9d3bea2d
        - ecac3db0
      Line: 0:0:0:gray:0
    fa2f9cff:
      Parent: 93217d3c
      Edge:
        - cba3c0b6
        - ecac3db0
      Line: 0:0:0:gray:0
    56b8ce4e:
      Parent: 6e4238be
      Edge:
        - 748ff729
        - e57892ec
      Line: 0:0:0:gray:0
    b1c4a77f:
      Parent: 6e4238be
      Edge:
        - 3eabe4e2
        - e57892ec
      Line: 0:0:0:gray:0
    8a29adb0:
      Parent: af4a6296
      Edge:
        - aaa2bc37
        - 4fda43af
      Line: 0:0:0:gray:0
    45c46aac:
      Parent: af4a6296
      Edge:
        - aaa2bc37
        - 3610414c
      Line: 0:0:0:gray:0
    64ec4f80:
      Parent: af4a6296
      Edge:
        - aaa2bc37
        - eb651e80
      Line: 0:0:0:gray:0
    5cde583a:
      Parent: af4a6296
      Edge:
        - aaa2bc37
        - 78abe018
      Line: 0:0:0:gray:0
    00404ba4:
      Parent: af4a6296
      Edge:
        - e225526b
        - 6e443abb
      Line: 0:0:0:gray:0
    0b6a34b5:
      Parent: af4a6296
      Edge:
        - 6e443abb
        - e225526b
      Line: 0:0:0:gray:0
    4eeb7349:
      Parent: af4a6296
      Edge:
        - 068f40e3
        - c24dc6ac
      Line: 0:0:0:gray:0
    3183deb1:
      Parent: 54cbcb40
      Edge:
        - 068f40e3
        - a22d1d8d
      Line: 0:0:0:gray:0
    a8e9eb99:
      Parent: af4a6296
      Edge:
        - a22d1d8d
        - bc075415
      Line: 0:0:0:gray:0
    e96ff13d:
      Parent: af4a6296
      Edge:
        - a22d1d8d
        - f1ec722c
      Line: 0:0:0:gray:0
    e91832a4:
      Res:
        - AlbServerGroup_1
        - AlbBackendServerAttachment_1
      Ref:
        - AlbBackendServerAttachment_1
      Parent: 6e4238be
      Rect:
        - 704
        - 170
        - 1060
        - 470
        - 10
        - 0
    '865e3973':
      Res:
        - PrdSecurityGroup_1
      Parent: 6e4238be
      Rect:
        - 500
        - 115
        - 1139
        - 470
        - 11
        - 0
    515b0d02:
      Res:
        - PrdSecurityGroup_0
      Parent: 93217d3c
      Rect:
        - 690
        - 150
        - 180
        - 475
        - 11
        - 0
    78abe018:
      Res:
        - PrdEcsInstance_1_1
      Parent: 80b3d84c
      Rect:
        - 40
        - 40
        - 1669
        - 510
        - 11
        - 0
      Layer:
        - e91832a4
    eb651e80:
      Res:
        - PrdEcsInstance_1_0
      Parent: 587e1e44
      Rect:
        - 40
        - 40
        - 1180
        - 490
        - 12
        - 0
      Layer:
        - '865e3973'
        - e91832a4
    f1ec722c:
      Res:
        - AlbLoadBalancer_1
        - AlbListener_1
      Ref:
        - AlbListener_1
      Parent: 80b3d84c
      Rect:
        - 40
        - 40
        - 1480
        - 480
        - 12
        - 0
    e57892ec:
      Res:
        - PrdCenTransitRouterVpcAttachment_1
      Parent: 80b3d84c
      Rect:
        - 40
        - 40
        - 1570
        - 480
        - 12
        - 0
      Hidden: true
    3610414c:
      Res:
        - PrdEcsInstance_0_1
      Parent: 32511d25
      Rect:
        - 40
        - 40
        - 673
        - 510
        - 12
        - 0
      Layer:
        - 515b0d02
        - d4544d7b
    4fda43af:
      Res:
        - PrdEcsInstance_0_0
      Parent: 6441d908
      Rect:
        - 40
        - 40
        - 340
        - 495
        - 12
        - 0
      Layer:
        - 515b0d02
        - d4544d7b
    bc075415:
      Res:
        - AlbLoadBalancer_0
        - AlbListener_0
      Ref:
        - AlbListener_0
      Parent: 32511d25
      Rect:
        - 40
        - 40
        - 787
        - 530
        - 12
        - 0
    ecac3db0:
      Res:
        - PrdCenTransitRouterVpcAttachment_0
      Parent: 32511d25
      Rect:
        - 40
        - 40
        - 700
        - 480
        - 12
        - 0
      Hidden: true
