ROSTemplateFormatVersion: '2015-09-01'
Transform: Aliyun::Terraform-v1.5
Metadata:
  ALIYUN::ROS::Interface:
    TemplateTags:
      - acs:technical-solution:data-analysis:Rapid Setup of Enterprise Operation Screen-tech_solu_151
Workspace:
  variable.tf: |-
    # ------------------------------------------------------------------------------
    # Module Input Variables
    #
    # This file defines all configurable input variables for this Terraform module.
    # Each variable contains detailed descriptions to help users configure the module correctly.
    # ------------------------------------------------------------------------------

    # Database account name
    variable "rds_db_user" {
      type        = string
      default     = "user_test"
      validation {
        condition     = can(regex("^[a-z][a-z0-9_]{0,31}$", var.rds_db_user))
        error_message = "Composed of 2 to 32 lowercase letters, supports lowercase letters, numbers, and underscores, starting with a lowercase letter"
      }
      description = "Database account"
    }

    # MySQL database password
    variable "db_password" {
      type        = string
      sensitive   = true
      #default    = ""
      description = "MySQL database password"
      validation {
        condition     = can(regex("^[0-9A-Za-z_!@#$%^&*()_+\\-=\\+]+$", var.db_password)) && length(var.db_password) >= 8 && length(var.db_password) <= 30
        error_message = "Length 8-30, must include three items (uppercase letters, lowercase letters, numbers, special symbols from !@#$%^&*()_+-=)"
      }
    }

  main.tf: |-
    # ------------------------------------------------------------------------------
    # Main Resource Definitions
    # 
    # This file contains the core infrastructure resources of the module.
    # The code here is responsible for creating and configuring all cloud resources based on input variables.
    # ------------------------------------------------------------------------------

    # Configures the Alibaba Cloud provider.
    provider "alicloud" {
      region = "cn-hangzhou"
    }

    # Create a random ID.
    resource "random_id" "suffix" {
      byte_length = 8
    }

    # Define a local variable.
    locals {
      common_name = random_id.suffix.id
    }

    # Query availability zones.
    data "alicloud_db_zones" "zones_ids" {
      engine                   = "MySQL"
      engine_version           = "8.0"
      instance_charge_type     = "PostPaid"
      category                 = "Basic"
      db_instance_storage_type = "cloud_essd"
    }

    # Create a VPC.
    resource "alicloud_vpc" "vpc" {
      vpc_name = "vpc-${local.common_name}"
      cidr_block = "192.168.0.0/16"
    }

    # Create a VSwitch.
    resource "alicloud_vswitch" "vswitch" {
      vpc_id = alicloud_vpc.vpc.id
      zone_id = data.alicloud_db_zones.zones_ids.ids.1
      cidr_block = "192.168.0.0/24"
      vswitch_name = "vsw-${local.common_name}"
    }

    # Create a security group.
    resource "alicloud_security_group" "security_group" {
      vpc_id = alicloud_vpc.vpc.id
    }

    # Create an RDS instance.
    resource "alicloud_db_instance" "rds_instance" {
      engine = "MySQL"
      instance_storage = 40
      engine_version = "8.0"
      security_ips = ["192.168.0.0/16"]
      vpc_id = alicloud_vpc.vpc.id
      zone_id = data.alicloud_db_zones.zones_ids.ids.1
      vswitch_id = alicloud_vswitch.vswitch.id
      instance_charge_type = "Postpaid"
      instance_type = "mysql.n2.medium.1"
      category = "Basic"
      db_instance_storage_type = "cloud_essd"
    }

    # Create a database.
    resource "alicloud_db_database" "database" {
      character_set   = "utf8"
      instance_id     = alicloud_db_instance.rds_instance.id
      name            = "mysqltest"
    }

    # Create a database account.
    resource "alicloud_db_account" "default" {
      db_instance_id      = alicloud_db_instance.rds_instance.id
      account_name        = var.rds_db_user
      account_password    = var.db_password
      account_type        = "Super"
    }

  output.tf: |-
    # ------------------------------------------------------------------------------
    # Module Outputs
    #
    # This file defines the values returned to the caller after successful module execution.
    # These outputs can be referenced by other Terraform configurations or displayed to users after the apply command completes.
    # ------------------------------------------------------------------------------

    # Outputs the ID of the created RDS instance.
    output "DBInstanceId" {
      value       = alicloud_db_instance.rds_instance.id
      description = "The ID of the RDS instance"
    }

    # Outputs the internal connection string of the RDS instance.
    output "InnerConnectionString" {
      value       = alicloud_db_instance.rds_instance.connection_string
      description = "The internal connection address of the RDS instance"
    }

    # Outputs the internal port number of the RDS instance.
    output "InnerPort" {
      value       = alicloud_db_instance.rds_instance.port
      description = "The internal port of the RDS instance"
    }

    # Outputs the database username.
    output "account_name" {
      value       = var.rds_db_user
      description = "Database username"
    }

    # Outputs the database password.
    output "account_password" {
      value       = var.db_password
      sensitive   = true
      description = "Database password"
    }
