ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 创建Centos7 ECS实例，配置安全组，安装部署FTP服务，支持自定义ECS或新建ECS资源。
  en: Create a Centos 7 ECS instance, configure security groups, install and deploy
    FTP services, supporting customization of ECS or the creation of new ECS resources.
Conditions:
  CreateEcs:
    Fn::Equals:
    - 创建ECS
    - Ref: EcsCondition
  HasEcs:
    Fn::Equals:
    - 使用已有ECS
    - Ref: EcsCondition
Parameters:
  EcsCondition:
    Type: String
    Label:
      zh-cn: 是否创建ECS
      en: FTP server access username
    Default: 使用已有ECS
    AllowedValues:
    - 使用已有ECS
    - 创建ECS
  EcsInstanceId:
    Type: String
    Label:
      en: ECS Instance ID
      zh-cn: ECS实例ID
    AssociationProperty: ALIYUN::ECS::Instance::InstanceId
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Not:
            Fn::Equals:
            - ${EcsCondition}
            - 创建ECS
    Default: null
  ZoneId:
    Type: String
    Label:
      zh-cn: 可用区ID
      en: Available Zone ID
    Description:
      zh-cn: 可用区ID。<br><b>注： <font color='blue'>选择可用区前请确认该可用区是否支持创建ECS资源的规格</font></b>
      en: Availability Zone ID,<br><b>note： <font color='blue'>Before selecting, please
        confirm that the Availability Zone supports the specification of creating
        ECS resources</font></b>
    AssociationProperty: ALIYUN::ECS::Instance::ZoneId
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Not:
            Fn::Equals:
            - ${EcsCondition}
            - 使用已有ECS
    Default: null
  InstanceType:
    Type: String
    Label:
      zh-cn: 实例类型
      en: Instance Type
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      ZoneId: ${ZoneId}
      Visible:
        Condition:
          Fn::Not:
            Fn::Equals:
            - ${EcsCondition}
            - 使用已有ECS
    Default: null
  SystemDiskCategory:
    Type: String
    Label:
      zh-cn: 系统磁盘类型
      en: System Disk Category
    Description:
      zh-cn: '<font color=''blue''><b>可选值：</b></font><br>[cloud_efficiency: <font
        color=''green''>高效云盘</font>]<br>[cloud_ssd: <font color=''green''>SSD云盘</font>]<br>[cloud_essd:
        <font color=''green''>ESSD云盘</font>]<br>[cloud: <font color=''green''>普通云盘</font>]<br>[ephemeral_ssd:
        <font color=''green''>本地SSD盘</font>]'
      en: '<font color=''blue''><b>Optional values:</b></font><br>[cloud_efficiency:
        <font color=''green''>Efficient Cloud Disk</font>]<br>[cloud_ssd: <font color=''green''>SSD
        Cloud Disk</font>]<br>[cloud_essd: <font color=''green''>ESSD Cloud Disk</font>]<br>[cloud:
        <font color=''green''>Cloud Disk</font>]<br>[ephemeral_ssd: <font color=''green''>Local
        SSD Cloud Disk</font>]'
    AssociationProperty: ALIYUN::ECS::Disk::SystemDiskCategory
    AssociationPropertyMetadata:
      InstanceType: ${InstanceType}
      ZoneId: ${ZoneId}
      Visible:
        Condition:
          Fn::Not:
            Fn::Equals:
            - ${EcsCondition}
            - 使用已有ECS
    Default: null
  InstancePassword:
    Type: String
    Label:
      zh-cn: 实例密码
      en: Instance Password
    Description:
      zh-cn: 长度8-30，必须包含大写字母、小写字母、数字、特殊符号三个；<br>特殊字符包括：()`~!@#$%^&*_-+=|{}[]:;'<>,.?/
      en: The 8-30 long login password of instance, consists of the uppercase, lowercase
        letter and number. <br> special characters include()`~!@#$%^&*_-+=|{}[]:;'<>,.?/
    ConstraintDescription:
      zh-cn: 长度8-30，必须包含大写字母、小写字母、数字、特殊符号三种；特殊字符包括：()`~!@#$%^&*_-+=|{}[]:;' <>,.?/
      en: 'Length 8-30, must contain upper case letters, lower case letters, Numbers,
        special symbols three; special characters include: ()`~!@#$%^&*_-+=|{}[]:;''<>,.?/'
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Not:
            Fn::Equals:
            - ${EcsCondition}
            - 使用已有ECS
    Default: null
    AllowedPattern: '[0-9A-Za-z\_\-&:;''<>,=%`~!@#\(\)\$\^\*\+\|\{\}\[\]\.\?\/]+$'
    MinLength: '8'
    MaxLength: '30'
    NoEcho: true
  FTPUser:
    Type: String
    Label:
      zh-cn: FTP服务访问用户名
      en: FTP server access username
    Default: ftptest
  FTPUserPassword:
    Type: String
    Label:
      zh-cn: FTP服务访问用户密码
      en: FTP server access username
    NoEcho: true
Resources:
  DS_Instances:
    Type: DATASOURCE::ECS::Instances
    Condition: HasEcs
    Properties:
      InstanceIds:
      - Ref: EcsInstanceId
  SecurityGroupIngress_22:
    Type: ALIYUN::ECS::SecurityGroupIngress
    Condition: HasEcs
    Properties:
      SecurityGroupId:
        Fn::Jq:
        - First
        - .[0].SecurityGroupIds[0]
        - Fn::GetAtt:
          - DS_Instances
          - Instances
      SourceCidrIp: 0.0.0.0/0
      IpProtocol: tcp
      NicType: intranet
      PortRange: 22/22
  SecurityGroupIngress_50000:
    Type: ALIYUN::ECS::SecurityGroupIngress
    Condition: HasEcs
    Properties:
      SecurityGroupId:
        Fn::Jq:
        - First
        - .[0].SecurityGroupIds[0]
        - Fn::GetAtt:
          - DS_Instances
          - Instances
      SourceCidrIp: 0.0.0.0/0
      IpProtocol: tcp
      NicType: intranet
      PortRange: 50000/50010
  SecurityGroupIngress_21:
    Type: ALIYUN::ECS::SecurityGroupIngress
    Condition: HasEcs
    Properties:
      SecurityGroupId:
        Fn::Jq:
        - First
        - .[0].SecurityGroupIds[0]
        - Fn::GetAtt:
          - DS_Instances
          - Instances
      SourceCidrIp: 0.0.0.0/0
      IpProtocol: tcp
      NicType: intranet
      PortRange: 21/21
  InstallFtp:
    Type: ALIYUN::ECS::RunCommand
    Condition: HasEcs
    Properties:
      InstanceIds:
      - Ref: EcsInstanceId
      Type: RunShellScript
      Sync: true
      Timeout: 3600
      CommandContent:
        Fn::Sub:
        - '#!/bin/bash

          # install ftp

          yum install -y vsftpd

          adduser ''${FTPUser}''

          echo ''${FTPUserPassword}'' | passwd --stdin ''${FTPUser}''

          mkdir /var/ftp/test

          touch /var/ftp/test/testfile.txt

          chown -R ''${FTPUser}'':''${FTPUser}'' /var/ftp/test

          touch /etc/vsftpd/chroot_list

          sed -i ''s/anonymous_enable=YES/anonymous_enable=NO/'' /etc/vsftpd/vsftpd.conf

          sed -i ''s/listen=NO/listen=YES/'' /etc/vsftpd/vsftpd.conf

          sed -i ''s/listen_ipv6=YES/\# listen_ipv6=YES/'' /etc/vsftpd/vsftpd.conf

          echo "local_root=/var/ftp/test" >>/etc/vsftpd/vsftpd.conf

          echo "pasv_enable=YES" >>/etc/vsftpd/vsftpd.conf

          echo "allow_writeable_chroot=YES" >>/etc/vsftpd/vsftpd.conf

          echo "pasv_min_port=50000" >>/etc/vsftpd/vsftpd.conf

          echo "pasv_max_port=50010" >>/etc/vsftpd/vsftpd.conf

          echo "pasv_address=${IP}" >>/etc/vsftpd/vsftpd.conf

          sed -i ''s/\#anon_upload_enable=YES/anon_upload_enable=YES/'' /etc/vsftpd/vsftpd.conf

          sed -i ''s/\#chroot_local_user=YES/chroot_local_user=YES/'' /etc/vsftpd/vsftpd.conf

          sed -i ''s/\#chroot_list_enable=YES/chroot_list_enable=YES/'' /etc/vsftpd/vsftpd.conf

          sed -i ''s%#chroot_list_file=/etc/vsftpd/chroot_list%chroot_list_file=/etc/vsftpd/chroot_list%''
          /etc/vsftpd/vsftpd.conf

          chmod o+w /var/ftp/pub/

          systemctl enable vsftpd.service

          systemctl restart vsftpd.service

          ${WaitConditionHandle.CurlCli} -d "{\"status\" : \"SUCCESS\"}"

          '
        - IP:
            Fn::Jq:
            - First
            - if .[0].PublicIpAddress != [] then .[0].PublicIpAddress[0] else .[0].EipAddress.IpAddress
              end
            - Fn::GetAtt:
              - DS_Instances
              - Instances
    DependsOn:
    - SecurityGroupIngress_21
    - SecurityGroupIngress_22
  EcsVpc:
    Type: ALIYUN::ECS::VPC
    Condition: CreateEcs
    Properties:
      CidrBlock: 192.168.0.0/16
  EcsSecurityGroup:
    Type: ALIYUN::ECS::SecurityGroup
    Condition: CreateEcs
    Properties:
      VpcId:
        Ref: EcsVpc
      SecurityGroupIngress:
      - Priority: 1
        PortRange: 22/22
        NicType: internet
        SourceCidrIp: 0.0.0.0/0
        IpProtocol: tcp
      - Priority: 1
        PortRange: 21/21
        NicType: internet
        SourceCidrIp: 0.0.0.0/0
        IpProtocol: tcp
      - Priority: 1
        PortRange: 50000/50010
        NicType: internet
        SourceCidrIp: 0.0.0.0/0
        IpProtocol: tcp
  WaitConditionHandle:
    Type: ALIYUN::ROS::WaitConditionHandle
    Properties: {}
  EcsVSwitch:
    Type: ALIYUN::ECS::VSwitch
    Condition: CreateEcs
    Properties:
      ZoneId:
        Ref: ZoneId
      VpcId:
        Ref: EcsVpc
      CidrBlock: 192.168.1.0/24
  EcsInstance:
    Type: ALIYUN::ECS::Instance
    Condition: CreateEcs
    Properties:
      VpcId:
        Fn::GetAtt:
        - EcsVpc
        - VpcId
      VSwitchId:
        Ref: EcsVSwitch
      SecurityGroupId:
        Ref: EcsSecurityGroup
      ImageId: centos_7
      UserData:
        Fn::Sub: '#!/bin/bash

          # install ftp

          yum install -y vsftpd

          adduser ''${FTPUser}''

          echo ''${FTPUserPassword}'' | passwd --stdin ''${FTPUser}''

          mkdir /var/ftp/test

          touch /var/ftp/test/testfile.txt

          chown -R ''${FTPUser}'':''${FTPUser}'' /var/ftp/test

          touch /etc/vsftpd/chroot_list

          sed -i ''s/anonymous_enable=YES/anonymous_enable=NO/'' /etc/vsftpd/vsftpd.conf

          sed -i ''s/listen=NO/listen=YES/'' /etc/vsftpd/vsftpd.conf

          sed -i ''s/listen_ipv6=YES/\# listen_ipv6=YES/'' /etc/vsftpd/vsftpd.conf

          echo "local_root=/var/ftp/test" >>/etc/vsftpd/vsftpd.conf

          echo "pasv_enable=YES" >>/etc/vsftpd/vsftpd.conf

          echo "allow_writeable_chroot=YES" >>/etc/vsftpd/vsftpd.conf

          echo "pasv_min_port=50000" >>/etc/vsftpd/vsftpd.conf

          echo "pasv_max_port=50010" >>/etc/vsftpd/vsftpd.conf

          echo "pasv_address=${VpcEip.EipAddress}" >>/etc/vsftpd/vsftpd.conf

          sed -i ''s/\#anon_upload_enable=YES/anon_upload_enable=YES/'' /etc/vsftpd/vsftpd.conf

          sed -i ''s/\#chroot_local_user=YES/chroot_local_user=YES/'' /etc/vsftpd/vsftpd.conf

          sed -i ''s/\#chroot_list_enable=YES/chroot_list_enable=YES/'' /etc/vsftpd/vsftpd.conf

          sed -i ''s%#chroot_list_file=/etc/vsftpd/chroot_list%chroot_list_file=/etc/vsftpd/chroot_list%''
          /etc/vsftpd/vsftpd.conf

          chmod o+w /var/ftp/pub/

          systemctl enable vsftpd.service

          systemctl restart vsftpd.service

          ${WaitConditionHandle.CurlCli} -d "{\"status\" : \"SUCCESS\"}"

          '
      SystemDiskCategory:
        Ref: SystemDiskCategory
      AllocatePublicIP: false
      Password:
        Ref: InstancePassword
      InstanceType:
        Ref: InstanceType
  WaitCondition:
    Type: ALIYUN::ROS::WaitCondition
    Properties:
      Count: 1
      Handle:
        Ref: WaitConditionHandle
      Timeout: 1800
    DependsOn: EcsInstance
  VpcEip:
    Type: ALIYUN::VPC::EIP
    Condition: CreateEcs
    Properties:
      Bandwidth: 5
  EipAssociation:
    Type: ALIYUN::VPC::EIPAssociation
    Condition: CreateEcs
    Properties:
      InstanceId:
        Fn::GetAtt:
        - EcsInstance
        - InstanceId
      AllocationId:
        Ref: VpcEip
    DependsOn:
    - VpcEip
Outputs:
  FTPServerAddress:
    Description: FTP server Connection address.
    Condition: CreateEcs
    Value:
      Fn::Join:
      - ''
      - - ftp://
        - Fn::GetAtt:
          - VpcEip
          - EipAddress
        - :21
  FtpServerAddress:
    Description: FTP server Connection address.
    Condition: HasEcs
    Value:
      Fn::Sub:
      - ftp://${IP}:21
      - IP:
          Fn::Jq:
          - First
          - if .[0].PublicIpAddress != [] then .[0].PublicIpAddress[0] else .[0].EipAddress.IpAddress
            end
          - Fn::GetAtt:
            - DS_Instances
            - Instances
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
    - Parameters:
      - EcsCondition
      - EcsInstanceId
      - ZoneId
      - InstanceType
      - SystemDiskCategory
      - InstancePassword
      - FTPUser
      - FTPUserPassword
      Label:
        default: ECS
    TemplateTags:
    - acs:document-help:ecs:手动搭建FTP站点（CentOS 7）
