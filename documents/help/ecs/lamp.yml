ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 创建LAMP环境，支持新实例部署或选择现有实例，配置VPC、安全组及实例设置，自动安装LAMP堆栈，提供ECS登录与Nginx、PHP信息页面访问。
  en: Create a LAMP environment, supporting deployment on new instances or selection
    of existing instances, with configuration of VPC, security groups, and instance
    settings. Automate the installation of the LAMP stack, providing access to ECS
    login and Nginx/PHP information pages.
Parameters:
  InstanceSource:
    Type: String
    Default: CreateNew
    Label:
      zh-cn: 实例来源
      en: Instance Source
    AllowedValues:
      - CreateNew
      - UseExisted
    AssociationPropertyMetadata:
      ValueLabelMapping:
        CreateNew:
          zh-cn: 创建新实例
          en: Create New Instance
        UseExisted:
          zh-cn: 选择已有实例
          en: Select Existed Instance
  ZoneId:
    Type: String
    Default: null
    Required: true
    Label:
      en: Availability Zone
      zh-cn: 可用区
    AssociationProperty: ALIYUN::ECS::Instance::ZoneId
    AssociationPropertyMetadata:
      AutoSelectFirst: true
      Visible:
        Condition:
          Fn::Equals:
            - ${InstanceSource}
            - CreateNew
  ImageId:
    Type: String
    Default: aliyun_3_9_x64_20G_alibase_20231219.vhd
    Required: true
    Label:
      en: Image of Instance
      zh-cn: 实例镜像
    AssociationProperty: ALIYUN::ECS::Image::ImageId
    AssociationPropertyMetadata:
      SupportedImageOwnerAlias:
        - system
      IsSupportCloudinit: true
      Visible:
        Condition:
          Fn::Equals:
            - ${InstanceSource}
            - CreateNew
  InstanceType:
    Type: String
    Default: null
    Required: true
    Label:
      en: Instance Type
      zh-cn: 实例类型
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      ZoneId: ${ZoneId}
      SpotStrategy: SpotAsPriceGo
      InstanceChargeType: PostPaid
      SystemDiskCategory: cloud_essd
      Visible:
        Condition:
          Fn::Equals:
            - ${InstanceSource}
            - CreateNew
  InstancePassword:
    Type: String
    NoEcho: true
    Default: null
    Confirm: true
    Description:
      en: >-
        Server login password, Length 8-30, must contain three(Capital letters,
        lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special
        symbol in)
      zh-cn: >-
        服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/
        中的特殊符号）
    Label:
      en: Instance Password
      zh-cn: 实例密码
    ConstraintDescription:
      en: >-
        Length 8-30, must contain three(Capital letters, lowercase letters,
        numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in)
      zh-cn: '长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;''<>,.?/ 中的特殊符号）'
    AssociationProperty: 'ALIYUN::ECS::Instance::Password'
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${InstanceSource}
            - CreateNew
  EcsInstanceId:
    Type: String
    Default: null
    Label:
      en: ECS Instance ID
      zh-cn: ECS实例ID
    AssociationProperty: ALIYUN::ECS::Instance::InstanceId
    AssociationPropertyMetadata:
      Status: Running
      Visible:
        Condition:
          Fn::Equals:
            - ${InstanceSource}
            - UseExisted
  CommonName:
    Type: String
    Default: lamp
Conditions:
  CreateInstance:
    Fn::Equals:
      - Ref: InstanceSource
      - CreateNew
  UseExistedInstance:
    Fn::Equals:
      - Ref: InstanceSource
      - UseExisted
Resources:
  Vpc:
    Type: 'ALIYUN::ECS::VPC'
    Condition: CreateInstance
    Properties:
      CidrBlock: 192.168.0.0/16
      VpcName:
        Fn::Sub: ${CommonName}-vpc
  VSwitch:
    Type: 'ALIYUN::ECS::VSwitch'
    Condition: CreateInstance
    Properties:
      VpcId:
        Ref: Vpc
      CidrBlock: 192.168.0.0/24
      ZoneId:
        Ref: ZoneId
      VSwitchName:
        Fn::Sub: ${CommonName}-vsw
  SecurityGroup:
    Type: 'ALIYUN::ECS::SecurityGroup'
    Condition: CreateInstance
    Properties:
      VpcId:
        Ref: Vpc
      SecurityGroupName:
        Fn::Sub: ${CommonName}-sg
      SecurityGroupIngress:
        - PortRange: 3389/3389
          SourceCidrIp: 0.0.0.0/0
          IpProtocol: tcp
        - PortRange: 80/80
          SourceCidrIp: 0.0.0.0/0
          IpProtocol: tcp
        - PortRange: '-1/-1'
          SourceCidrIp: 0.0.0.0/0
          IpProtocol: icmp
  EcsInstance:
    Type: 'ALIYUN::ECS::InstanceGroup'
    Condition: CreateInstance
    Properties:
      VpcId:
        Ref: Vpc
      ZoneId:
        Ref: ZoneId
      VSwitchId:
        Ref: VSwitch
      SecurityGroupId:
        Ref: SecurityGroup
      ImageId:
        Ref: ImageId
      InstanceName:
        Fn::Sub: ${CommonName}-ecs
      InstanceType:
        Ref: InstanceType
      SystemDiskCategory: cloud_essd
      MaxAmount: 1
      InternetMaxBandwidthOut: 100
      SpotStrategy: SpotAsPriceGo
      Password:
        Ref: InstancePassword
  ModuleInstallLAMP:
    Version: default
    Type: 'MODULE::ACS::OOS::Extension'
    Properties:
      EcsInstanceIds:
        - Fn::If:
            - UseExistedInstance
            - Ref: EcsInstanceId
            - Ref: EcsInstance
      PackageName: ACS-Extension-LAMP-One-Click-1853370294850618
  DsEcs:
    Type: 'DATASOURCE::ECS::Instances'
    Properties:
      InstanceIds:
        - Fn::If:
            - UseExistedInstance
            - Ref: EcsInstanceId
            - Ref: EcsInstance
Outputs:
  EcsLoginAddress:
    Description:
      en: Ecs login address.
      zh-cn: ECS登录地址。
    Value:
      Fn::Sub:
        - https://ecs-workbench.aliyun.com/?from=EcsConsole&instanceType=ecs&regionId=${ALIYUN::Region}&instanceId=${InstanceId}
        - InstanceId:
            Fn::If:
              - UseExistedInstance
              - Ref: EcsInstanceId
              - Ref: EcsInstance
  NginxUrl:
    Description:
      en: Nginx Info Page.
      zh-cn: Nginx信息页面。
    Value:
      Fn::Sub:
        - http://${PublicIp}
        - PublicIp:
            Fn::Jq:
              - First
              - if .[0].PublicIpAddress != [] then .[0].PublicIpAddress[0] else .[0].EipAddress.IpAddress end
              - Fn::GetAtt:
                  - DsEcs
                  - Instances
  PhpUrl:
    Description:
      en: PHP Info Page.
      zh-cn: PHP信息页面。
    Value:
      Fn::Sub:
      - http://${PublicIp}/phpinfo.php
      - PublicIp:
          Fn::Jq:
          - First
          - if .[0].PublicIpAddress != [] then .[0].PublicIpAddress[0] else .[0].EipAddress.IpAddress
            end
          - Fn::GetAtt:
            - DsEcs
            - Instances
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
      - Parameters:
          - InstanceSource
          - ZoneId
          - ImageId
          - InstanceType
          - InstancePassword
          - EcsInstanceId
    Hidden:
      - CommonName
    TemplateTags:
      - acs:document-help:ecs:部署LAMP环境
  ALIYUN::ROS::Composer:
    810b6cff:
      Rect:
        - 620
        - 540
        - 40
        - 100
        - 1
        - 0
      ResT: Composer::ROSParameter::AlibabaCloud
    f1438552:
      Parent: 810b6cff
      Rect:
        - 580
        - 470
        - 60
        - 150
        - 2
        - 0
      ResT: Composer::ROSParameter::Region
    efc38fcc:
      Res:
        - Vpc
      Parent: f1438552
      Rect:
        - 480
        - 340
        - 80
        - 200
        - 3
        - 0
    f74adccf:
      Res:
        - ModuleInstallLAMP
      Parent: f1438552
      Rect:
        - 40
        - 40
        - 80
        - 560
        - 3
        - 0
      Hidden: true
      ResT: MODULE::ACS::OOS::Extension
    771cbefd:
      Res:
        - DsEcs
      Parent: f1438552
      Rect:
        - 40
        - 40
        - 580
        - 200
        - 3
        - 0
      Hidden: true
      ResT: DATASOURCE::ECS::Instances
    a441c4a8:
      Res:
        - ZoneId
      Parent: efc38fcc
      Rect:
        - 440
        - 270
        - 100
        - 250
        - 4
        - 0
      ResT: Composer::ROSParameter::Zone
    f2bab609:
      Res:
        - VSwitch
      Parent: a441c4a8
      Rect:
        - 400
        - 200
        - 120
        - 300
        - 5
        - 0
    f8d3bcc8:
      Res:
        - SecurityGroup
      Parent: efc38fcc
      Rect:
        - 178
        - 130
        - 140
        - 350
        - 10
        - 0
    aeaac0a6:
      Parent: f1438552
      Edge:
        - f74adccf
        - d81bd770
      Line: 0:0:0:gray:0
    8789ddb8:
      Parent: f1438552
      Edge:
        - 771cbefd
        - d81bd770
      Line: 0:0:0:gray:0
    d81bd770:
      Res:
        - EcsInstance
      Parent: f2bab609
      Rect:
        - 40
        - 40
        - 209
        - 395
        - 11
        - 0
      Layer:
        - f8d3bcc8
