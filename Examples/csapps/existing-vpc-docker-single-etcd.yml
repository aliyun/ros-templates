ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 单节点在centos7下安装部署Etcd服务，Etcd是一个用于服务注册与发现的键值存储组件, 其内部采用raft协议作为一致性算法保证数据统一性，服务安装完成后请使用etcdctl命令在云服务器中操作管理服务
  en: A single node installs and deploys etcd service under centos7. Etcd is a key
    value storage component used for service registration and discovery. The raft
    protocol is used as a consistency algorithm to ensure data consistency. Once the
    Server is installed, use the etcdctl command line to operate the management server
    in the cloud server.
Parameters:
  VSwitchZoneId:
    Type: String
    Label:
      zh-cn: 交换机可用区
      en: VSwitch Availability Zone
    Description:
      zh-cn: 可用区ID。<br><b>注： <font color='blue'>选择前请确认该可用区是否支持创建ECS资源的规格，建议与其他交换机可用区不同</font></b>
      en: Availability Zone ID.<br><b>note：<font color='blue'>before selecting, please
        confirm that the Availability Zone supports the specification of creating
        ECS resources,which is recommended to be different from other VSwitch Availability
        Zone</font></b>
    AssociationProperty: ALIYUN::ECS::Instance:ZoneId
  VPC:
    Type: String
    Label:
      zh-cn: 现有VPC的实例ID
      en: Existing VPC Instance ID
    Description:
      zh-cn: 现有虚拟专有网络的实例ID,控制台-VPC-专有网络下查询
      en: Please search the ID starts with (vpc-xxx)from console-Virtual Private Cloud
    AssociationProperty: ALIYUN::ECS::VPC::VPCId
  VSwitch:
    Type: String
    Label:
      zh-cn: 网络交换机ID
      en: Existing VSwitch ID
    Description:
      zh-cn: 现有业务网络交换机的实例ID,控制台-VPC-专有网络-交换机下查询
      en: Please search the business VSwitch ID starts with(vsw-xxx)from console-Virtual
        Private Cloud-VSwitches
    AssociationProperty: ALIYUN::ECS::VSwitch::VSwitchId
    AssociationPropertyMetadata:
      VpcId: VPC
      ZoneId: VSwitchZoneId
  SecurityGroup:
    Type: String
    Label:
      zh-cn: 业务安全组ID
      en: Business Security Group ID
    Description:
      zh-cn: 现有业务安全组的实例ID,控制台-ECS-网络与安全-安全组下查询
      en: Please search the business security group ID starting with(sg-xxx)from console-ECS-Network
        & Security
    AssociationProperty: ALIYUN::ECS::SecurityGroup::SecurityGroupId
    AssociationPropertyMetadata:
      VpcId: VPC
  InstanceType:
    Type: String
    Label:
      zh-cn: 实例规格
      en: Instance Type
    Description:
      en: <font color='blue'><b>1.Before selecting the model please confirm that the
        current available zone under the model is in stock, some models need to be
        reported in advance</b></font>]<br><font color='blue'><b>2.List of optional
        models</font>]<br></b></font>[ecs.c5.large <font color='green'>2vCPU 4GiB
        Intranet bandwidth1Gbps In-grid sending and receiving packages30MillionPPSS</font>]<br></b>[ecs.c5.xlarge
        <font color='green'>4vCPU 8GiB Intranet bandwidth1.5Gbps In-grid sending and
        receiving packages50MillionPPS</font>]<br></b>[ecs.c5.2xlarge <font color='green'>8vCPU
        16GiB Intranet bandwidth2.5Gbps In-grid sending and receiving packages80MillionPPS</font>]
      zh-cn: <font color='blue'><b>1.选择机型前请先确认当前可用区下该机型是否有货，部分机型需要提前报备</b></font><br><font
        color='blue'><b>2.可选机型列表</font><br></b></font>[ecs.c5.large <font color='green'>2vCPU
        4GiB 内网带宽1Gbps 内网收发包30万PPS</font>]<br></b>[ecs.c5.xlarge <font color='green'>4vCPU
        8GiB 内网带宽1.5Gbps 内网收发包50万PPS</font>]<br></b>[ecs.c5.2xlarge <font color='green'>8vCPU
        16GiB 内网带宽2.5Gbps 内网收发包80万PPS</font>]
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      ZoneId: VSwitchZoneId
  SystemDiskCategory:
    Type: String
    Label:
      zh-cn: 系统盘类型
      en: System Disk Type
    Description:
      en: '<font color=''blue''><b>Optional values:</b></font><br>[cloud_efficiency:
        <font color=''green''>Efficient Cloud Disk</font>]<br>[cloud_ssd: <font color=''green''>SSD
        Cloud Disk</font>]<br>[cloud_essd: <font color=''green''>ESSD Cloud Disk</font>]<br>[cloud:
        <font color=''green''>Cloud Disk</font>]<br>[ephemeral_ssd: <font color=''green''>Local
        SSD Cloud Disk</font>]'
      zh-cn: '<font color=''blue''><b>可选值：</b></font><br>[cloud_efficiency: <font
        color=''green''>高效云盘</font>]<br>[cloud_ssd: <font color=''green''>SSD云盘</font>]<br>[cloud_essd:
        <font color=''green''>ESSD云盘</font>]<br>[cloud: <font color=''green''>普通云盘</font>]<br>[ephemeral_ssd:
        <font color=''green''>本地SSD盘</font>]'
    Default: cloud_efficiency
    AllowedValues:
    - cloud_auto
    - cloud_efficiency
    - cloud_ssd
    - cloud
    - cloud_essd
    - ephemeral_ssd
  SystemDiskSize:
    Type: Number
    Label:
      zh-cn: 系统盘空间
      en: System Disk Space
    Description:
      zh-cn: 系统盘大小, 取值范围：[20, 500], 单位：GB。
      en: 'System disk size, range of values: 20-500, units: GB.'
    Default: 20
  Password:
    Type: String
    Label:
      zh-cn: 实例密码
      en: Instance Password
    Description:
      zh-cn: 服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）。
      en: Server login password, Length 8-30, must contain three(Capital letters,
        lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol
        in).
    ConstraintDescription:
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）。
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers,
        ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in).
    AllowedPattern: '[0-9A-Za-z\_\-\&:;''<>,=%`~!@#\(\)\$\^\*\+\|\{\}\[\]\.\?\/]+$'
    MinLength: 8
    MaxLength: 30
    NoEcho: true
Resources:
  WaitConditionHandle:
    Type: ALIYUN::ROS::WaitConditionHandle
    Properties: {}
    Metadata:
      ALIYUN::ROS::Designer:
        id: dfee0897-b608-4948-acac-8d6d412da61a
  WaitCondition:
    Type: ALIYUN::ROS::WaitCondition
    Properties:
      Count: 1
      Handle:
        Ref: WaitConditionHandle
      Timeout: 1800
    Metadata:
      ALIYUN::ROS::Designer:
        id: 526a0d87-d716-454f-badd-aeb69d573ed6
  EtcdServer:
    Type: ALIYUN::ECS::InstanceGroup
    Properties:
      ZoneId:
        Ref: VSwitchZoneId
      VpcId:
        Ref: VPC
      VSwitchId:
        Ref: VSwitch
      SecurityGroupId:
        Ref: SecurityGroup
      ImageId: centos_7
      UserData:
        Fn::Replace:
        - ros-notify:
            Fn::GetAtt:
            - WaitConditionHandle
            - CurlCli
        - Fn::Join:
          - ''
          - - '#!/bin/sh'
            - " \n"
            - "HOST_IP=`ifconfig eth0 | awk '/inet /{print $2}'` \n"
            - "InstallPackage() { \n"
            - "    yum install -y yum-utils \n"
            - "} \n"
            - '

              '
            - "InstallEtcd() { \n"
            - "    yum install etcd -y \n"
            - "    sed -i 's%ETCD_LISTEN_CLIENT_URLS=.*%ETCD_LISTEN_CLIENT_URLS=\"\
              http://'${HOST_IP}':2379,http://127.0.0.1:2379\"%g' /etc/etcd/etcd.conf\
              \ \n"
            - "    sed -i 's%ETCD_ADVERTISE_CLIENT_URLS=.*%ETCD_ADVERTISE_CLIENT_URLS=\"\
              http://'${HOST_IP}':2379,http://127.0.0.1:2379\"%g' /etc/etcd/etcd.conf\
              \ \n"
            - "    systemctl enable etcd \n"
            - "    systemctl start etcd \n"
            - "} \n"
            - '

              '
            - "main() { \n"
            - "    InstallPackage \n"
            - "    InstallEtcd  \n"
            - "} \n"
            - '

              '
            - "main \n"
            - "netstat -ntlp | grep 2380 >> /tmp/access.log \n"
            - "if [[ $? -eq 0 ]]; \n"
            - "then \n"
            - "     ros-notify \n"
            - "fi \n"
      SystemDiskCategory:
        Ref: SystemDiskCategory
      SystemDiskSize:
        Ref: SystemDiskSize
      AllocatePublicIP: true
      Password:
        Ref: Password
      InstanceName: EtcdServer
      InstanceType:
        Ref: InstanceType
      MaxAmount: 1
    Metadata:
      ALIYUN::ROS::Designer:
        id: 01d5b336-622c-47e6-86e7-189cae745b4d
Outputs:
  EtcdServerConnectionAddress:
    Value:
      Fn::Join:
      - ''
      - - Fn::Select:
          - '0'
          - Fn::GetAtt:
            - EtcdServer
            - PrivateIps
        - :2379
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
    - Parameters:
      - VSwitchZoneId
      - VPC
      - VSwitch
      - SecurityGroup
      Label:
        default:
          zh-cn: 基础资源配置（必填）
          en: Infrastructure Configuration
    - Parameters:
      - InstanceType
      - SystemDiskCategory
      - SystemDiskSize
      - Password
      Label:
        default:
          zh-cn: Etcd 配置
          en: Etcd Configuration
    TemplateTags:
    - acs:example:容器:Etcd单机版(已有VPC)
  ALIYUN::ROS::Designer:
    526a0d87-d716-454f-badd-aeb69d573ed6:
      size:
        width: 60
        height: 60
      position:
        x: 184
        y: 42
      z: 0
    01d5b336-622c-47e6-86e7-189cae745b4d:
      size:
        width: 60
        height: 60
      position:
        x: 60
        y: 100
      z: 0
    dfee0897-b608-4948-acac-8d6d412da61a:
      size:
        width: 60
        height: 60
      position:
        x: 184
        y: 186
      z: 0
    1eff9b8e-35a0-4602-987d-9656827beadb:
      source:
        id: 526a0d87-d716-454f-badd-aeb69d573ed6
      target:
        id: dfee0897-b608-4948-acac-8d6d412da61a
      z: 1
